'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.ProjectJSONContribution = undefined;

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _strings = require('../common/strings');

var _strings2 = _interopRequireDefault(_strings);

var _requestLight = require('request-light');

var _requestLight2 = _interopRequireDefault(_requestLight);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var LIMIT = 40;

var ProjectJSONContribution = exports.ProjectJSONContribution = function () {
    function ProjectJSONContribution() {
        _classCallCheck(this, ProjectJSONContribution);
    }

    _createClass(ProjectJSONContribution, [{
        key: 'isProjectJSONFile',
        value: function isProjectJSONFile(resource) {
            var path = resource.path;
            return _strings2.default.endsWith(path, '/project.json');
        }
    }, {
        key: 'collectDefaultSuggestions',
        value: function collectDefaultSuggestions(resource, result) {
            if (this.isProjectJSONFile(resource)) {
                var defaultValue = {
                    'version': '{{1.0.0-*}}',
                    'dependencies': {},
                    'frameworks': {
                        'dnx451': {},
                        'dnxcore50': {}
                    }
                };
                result.add({ type: 'snippet', displayText: 'Default project.json', snippet: JSON.stringify(defaultValue, null, '\t'), description: '' });
            }
            return null;
        }
    }, {
        key: 'collectPropertySuggestions',
        value: function collectPropertySuggestions(resource, location, currentWord, addValue, isLast, result) {
            if (this.isProjectJSONFile(resource) && (location.matches(['dependencies']) || location.matches(['frameworks', '*', 'dependencies']) || location.matches(['frameworks', '*', 'frameworkAssemblies']))) {
                var queryUrl;
                if (currentWord.length > 0) {
                    queryUrl = 'https://www.nuget.org/api/v2/Packages?' + '$filter=Id%20ge%20\'' + encodeURIComponent(currentWord) + '\'%20and%20Id%20lt%20\'' + encodeURIComponent(currentWord + 'z') + '\'%20and%20IsAbsoluteLatestVersion%20eq%20true' + '&$select=Id,Version,Description&$format=json&$top=' + LIMIT;
                } else {
                    queryUrl = 'https://www.nuget.org/api/v2/Packages?' + '$filter=IsAbsoluteLatestVersion%20eq%20true' + '&$orderby=DownloadCount%20desc&$top=' + LIMIT + '&$select=Id,Version,DownloadCount,Description&$format=json';
                }
                return _requestLight2.default.xhr({
                    url: queryUrl
                }).then(function (success) {
                    if (success.status === 200) {
                        try {
                            var obj = JSON.parse(success.responseText);
                            if (Array.isArray(obj.d)) {
                                var results = obj.d;
                                for (var i = 0; i < results.length; i++) {
                                    var curr = results[i];
                                    var name = curr.Id;
                                    var version = curr.Version;
                                    if (name) {
                                        var documentation = curr.Description;
                                        var typeLabel = curr.Version;
                                        var codeSnippet = JSON.stringify(name);
                                        if (addValue) {
                                            codeSnippet += ': "{{' + version + '}}"';
                                            if (!isLast) {
                                                codeSnippet += ',';
                                            }
                                        }
                                        result.add({ type: 'property', displayText: name, snippet: codeSnippet, className: typeLabel, description: documentation });
                                    }
                                }
                                if (results.length === LIMIT) {
                                    result.setAsIncomplete();
                                }
                            }
                        } catch (e) {}
                    } else {
                        result.error('Request to the nuget repository failed: ' + success.responseText);
                        return 0;
                    }
                }, function (error) {
                    result.error('Request to the nuget repository failed: ' + error.responseText);
                    return 0;
                });
            }
            return null;
        }
    }, {
        key: 'collectValueSuggestions',
        value: function collectValueSuggestions(resource, location, currentKey, result) {
            if (this.isProjectJSONFile(resource) && (location.matches(['dependencies']) || location.matches(['frameworks', '*', 'dependencies']) || location.matches(['frameworks', '*', 'frameworkAssemblies']))) {
                var queryUrl = 'https://www.myget.org/F/aspnetrelease/api/v2/Packages?' + '$filter=Id%20eq%20\'' + encodeURIComponent(currentKey) + '\'&$select=Version,IsAbsoluteLatestVersion&$format=json&$top=' + LIMIT;
                return _requestLight2.default.xhr({
                    url: queryUrl
                }).then(function (success) {
                    try {
                        var obj = JSON.parse(success.responseText);
                        if (Array.isArray(obj.d)) {
                            var results = obj.d;
                            for (var i = 0; i < results.length; i++) {
                                var curr = results[i];
                                var version = curr.Version;
                                if (version) {
                                    var name = JSON.stringify(version);
                                    var isLatest = curr.IsAbsoluteLatestVersion === 'true';
                                    var label = name;
                                    var documentationLabel = '';
                                    if (isLatest) {
                                        documentationLabel = 'The currently latest version of the package';
                                    }
                                    result.add({ type: 'class', displayText: label, snippet: name, description: documentationLabel });
                                }
                            }
                            if (results.length === LIMIT) {
                                result.setAsIncomplete();
                            }
                        }
                    } catch (e) {}
                    return 0;
                }, function (error) {
                    return 0;
                });
            }
            return null;
        }
    }, {
        key: 'getInfoContribution',
        value: function getInfoContribution(resource, location) {
            if (this.isProjectJSONFile(resource) && (location.matches(['dependencies', '*']) || location.matches(['frameworks', '*', 'dependencies', '*']) || location.matches(['frameworks', '*', 'frameworkAssemblies', '*']))) {
                var pack = location.getSegments()[location.getSegments().length - 1];
                var htmlContent = [];
                htmlContent.push({ className: 'type', text: pack });
                var queryUrl = 'https://www.myget.org/F/aspnetrelease/api/v2/Packages?' + '$filter=Id%20eq%20\'' + encodeURIComponent(pack) + '\'%20and%20IsAbsoluteLatestVersion%20eq%20true' + '&$select=Version,Description&$format=json&$top=5';
                return _requestLight2.default.xhr({
                    url: queryUrl
                }).then(function (success) {
                    var content = success.responseText;
                    if (content) {
                        try {
                            var obj = JSON.parse(content);
                            if (obj.d && obj.d[0]) {
                                var res = obj.d[0];
                                if (res.Description) {
                                    htmlContent.push({ className: 'documentation', text: res.Description });
                                }
                                if (res.Version) {
                                    htmlContent.push({ className: 'documentation', text: 'Latest version: ' + res.Version });
                                }
                            }
                        } catch (e) {}
                    }
                    return htmlContent;
                }, function (error) {
                    return htmlContent;
                });
            }
            return null;
        }
    }]);

    return ProjectJSONContribution;
}();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZzY29kZS9jb250cmlidXRpb25zL3Byb2plY3RKU09OQ29udHJpYnV0aW9uLnRzIiwidnNjb2RlL2NvbnRyaWJ1dGlvbnMvcHJvamVjdEpTT05Db250cmlidXRpb24uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBSUE7Ozs7Ozs7OztBQ0hBOzs7O0FBQ0E7Ozs7Ozs7O0FEV0EsSUFBSSxRQUFRLEVBQVo7O0lBRUEsdUIsV0FBQSx1QjtBQUVJLHVDQUFBO0FBQUE7QUFDQzs7OzswQ0FFeUIsUSxFQUFhO0FBQ25DLGdCQUFJLE9BQU8sU0FBUyxJQUFwQjtBQUNBLG1CQUFPLGtCQUFRLFFBQVIsQ0FBaUIsSUFBakIsRUFBdUIsZUFBdkIsQ0FBUDtBQUNIOzs7a0RBRWdDLFEsRUFBZSxNLEVBQXdDO0FBQ3BGLGdCQUFJLEtBQUssaUJBQUwsQ0FBdUIsUUFBdkIsQ0FBSixFQUFzQztBQUNsQyxvQkFBSSxlQUFlO0FBQ2YsK0JBQVcsYUFESTtBQUVmLG9DQUFnQixFQUZEO0FBR2Ysa0NBQWM7QUFDVixrQ0FBVSxFQURBO0FBRVYscUNBQWE7QUFGSDtBQUhDLGlCQUFuQjtBQVFBLHVCQUFPLEdBQVAsQ0FBVyxFQUFFLE1BQU0sU0FBUixFQUFtQixtQ0FBbkIsRUFBd0QsU0FBUyxLQUFLLFNBQUwsQ0FBZSxZQUFmLEVBQTZCLElBQTdCLEVBQW1DLElBQW5DLENBQWpFLEVBQTJHLGFBQWEsRUFBeEgsRUFBWDtBQUNIO0FBQ0QsbUJBQU8sSUFBUDtBQUNIOzs7bURBRWlDLFEsRUFBZSxRLEVBQXdCLFcsRUFBcUIsUSxFQUFtQixNLEVBQWdCLE0sRUFBd0M7QUFDckssZ0JBQUksS0FBSyxpQkFBTCxDQUF1QixRQUF2QixNQUFxQyxTQUFTLE9BQVQsQ0FBaUIsQ0FBQyxjQUFELENBQWpCLEtBQXNDLFNBQVMsT0FBVCxDQUFpQixDQUFDLFlBQUQsRUFBZSxHQUFmLEVBQW9CLGNBQXBCLENBQWpCLENBQXRDLElBQStGLFNBQVMsT0FBVCxDQUFpQixDQUFDLFlBQUQs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QUFPLFdBQVA7QUFDSCxpQkF2Qk0sQ0FBUDtBQXdCSDtBQUNELG1CQUFPLElBQVA7QUFDSCIsImZpbGUiOiJ2c2NvZGUvY29udHJpYnV0aW9ucy9wcm9qZWN0SlNPTkNvbnRyaWJ1dGlvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcbiAqICBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuICogIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS4gU2VlIExpY2Vuc2UudHh0IGluIHRoZSBwcm9qZWN0IHJvb3QgZm9yIGxpY2Vuc2UgaW5mb3JtYXRpb24uXHJcbiAqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qL1xyXG4ndXNlIHN0cmljdCc7XHJcblxyXG5pbXBvcnQgSHRtbENvbnRlbnQgZnJvbSAnLi4vY29tbW9uL2h0bWxDb250ZW50JztcclxuaW1wb3J0IFN0cmluZ3MgZnJvbSAnLi4vY29tbW9uL3N0cmluZ3MnO1xyXG5pbXBvcnQgSlNPTldvcmtlciBmcm9tICcuLi9qc29uV29ya2VyJztcclxuaW1wb3J0IHtKU09OTG9jYXRpb259IGZyb20gJy4uL3BhcnNlci9qc29uTG9jYXRpb24nO1xyXG5pbXBvcnQgVVJJIGZyb20gJy4uL2NvbW1vbi91cmknO1xyXG5pbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0LWxpZ2h0JztcclxuXHJcbnZhciBMSU1JVCA9IDQwO1xyXG5cclxuZXhwb3J0IGNsYXNzIFByb2plY3RKU09OQ29udHJpYnV0aW9uIGltcGxlbWVudHMgSlNPTldvcmtlci5JSlNPTldvcmtlckNvbnRyaWJ1dGlvbiB7XHJcblxyXG4gICAgcHVibGljIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaXNQcm9qZWN0SlNPTkZpbGUocmVzb3VyY2U6IFVSSSk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHZhciBwYXRoID0gcmVzb3VyY2UucGF0aDtcclxuICAgICAgICByZXR1cm4gU3RyaW5ncy5lbmRzV2l0aChwYXRoLCAnL3Byb2plY3QuanNvbicpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBjb2xsZWN0RGVmYXVsdFN1Z2dlc3Rpb25zKHJlc291cmNlOiBVUkksIHJlc3VsdDogSlNPTldvcmtlci5JU3VnZ2VzdGlvbnNDb2xsZWN0b3IpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgICAgIGlmICh0aGlzLmlzUHJvamVjdEpTT05GaWxlKHJlc291cmNlKSkge1xyXG4gICAgICAgICAgICB2YXIgZGVmYXVsdFZhbHVlID0ge1xyXG4gICAgICAgICAgICAgICAgJ3ZlcnNpb24nOiAne3sxLjAuMC0qfX0nLFxyXG4gICAgICAgICAgICAgICAgJ2RlcGVuZGVuY2llcyc6IHt9LFxyXG4gICAgICAgICAgICAgICAgJ2ZyYW1ld29ya3MnOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgJ2RueDQ1MSc6IHt9LFxyXG4gICAgICAgICAgICAgICAgICAgICdkbnhjb3JlNTAnOiB7fVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICByZXN1bHQuYWRkKHsgdHlwZTogJ3NuaXBwZXQnLCBkaXNwbGF5VGV4dDogYERlZmF1bHQgcHJvamVjdC5qc29uYCwgc25pcHBldDogSlNPTi5zdHJpbmdpZnkoZGVmYXVsdFZhbHVlLCBudWxsLCAnXFx0JyksIGRlc2NyaXB0aW9uOiAnJyB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNvbGxlY3RQcm9wZXJ0eVN1Z2dlc3Rpb25zKHJlc291cmNlOiBVUkksIGxvY2F0aW9uOiBKU09OTG9jYXRpb24sIGN1cnJlbnRXb3JkOiBzdHJpbmcsIGFkZFZhbHVlOiBib29sZWFuLCBpc0xhc3Q6Ym9vbGVhbiwgcmVzdWx0OiBKU09OV29ya2VyLklTdWdnZXN0aW9uc0NvbGxlY3RvcikgOiBQcm9taXNlPGFueT4ge1xyXG4gICAgICAgIGlmICh0aGlzLmlzUHJvamVjdEpTT05GaWxlKHJlc291cmNlKSAmJiAobG9jYXRpb24ubWF0Y2hlcyhbJ2RlcGVuZGVuY2llcyddKSB8fCBsb2NhdGlvbi5tYXRjaGVzKFsnZnJhbWV3b3JrcycsICcqJywgJ2RlcGVuZGVuY2llcyddKSB8fCBsb2NhdGlvbi5tYXRjaGVzKFsnZnJhbWV3b3JrcycsICcqJywgJ2ZyYW1ld29ya0Fzc2VtYmxpZXMnXSkpKSB7XHJcbiAgICAgICAgICAgIHZhciBxdWVyeVVybCA6IHN0cmluZztcclxuICAgICAgICAgICAgaWYgKGN1cnJlbnRXb3JkLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIHF1ZXJ5VXJsID0gJ2h0dHBzOi8vd3d3Lm51Z2V0Lm9yZy9hcGkvdjIvUGFja2FnZXM/J1xyXG4gICAgICAgICAgICAgICAgICAgICsgJyRmaWx0ZXI9SWQlMjBnZSUyMFxcJydcclxuICAgICAgICAgICAgICAgICAgICArIGVuY29kZVVSSUNvbXBvbmVudChjdXJyZW50V29yZClcclxuICAgICAgICAgICAgICAgICAgICArICdcXCclMjBhbmQlMjBJZCUyMGx0JTIwXFwnJ1xyXG4gICAgICAgICAgICAgICAgICAgICsgZW5jb2RlVVJJQ29tcG9uZW50KGN1cnJlbnRXb3JkICsgJ3onKVxyXG4gICAgICAgICAgICAgICAgICAgICsgJ1xcJyUyMGFuZCUyMElzQWJzb2x1dGVMYXRlc3RWZXJzaW9uJTIwZXElMjB0cnVlJ1xyXG4gICAgICAgICAgICAgICAgICAgICsgJyYkc2VsZWN0PUlkLFZlcnNpb24sRGVzY3JpcHRpb24mJGZvcm1hdD1qc29uJiR0b3A9JyArIExJTUlUO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcXVlcnlVcmwgPSAnaHR0cHM6Ly93d3cubnVnZXQub3JnL2FwaS92Mi9QYWNrYWdlcz8nXHJcbiAgICAgICAgICAgICAgICAgICAgKyAnJGZpbHRlcj1Jc0Fic29sdXRlTGF0ZXN0VmVyc2lvbiUyMGVxJTIwdHJ1ZSdcclxuICAgICAgICAgICAgICAgICAgICArICcmJG9yZGVyYnk9RG93bmxvYWRDb3VudCUyMGRlc2MmJHRvcD0nICsgTElNSVRcclxuICAgICAgICAgICAgICAgICAgICArICcmJHNlbGVjdD1JZCxWZXJzaW9uLERvd25sb2FkQ291bnQsRGVzY3JpcHRpb24mJGZvcm1hdD1qc29uJztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHJlcXVlc3QueGhyKHtcclxuICAgICAgICAgICAgICAgIHVybCA6IHF1ZXJ5VXJsXHJcbiAgICAgICAgICAgIH0pLnRoZW4oKHN1Y2Nlc3MpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChzdWNjZXNzLnN0YXR1cyA9PT0gMjAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9iaiA9IEpTT04ucGFyc2Uoc3VjY2Vzcy5yZXNwb25zZVRleHQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShvYmouZCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHRzID0gPGFueVtdPiBvYmouZDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzdWx0cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjdXJyID0gcmVzdWx0c1tpXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IGN1cnIuSWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZlcnNpb24gPSBjdXJyLlZlcnNpb247XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5hbWUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRvY3VtZW50YXRpb24gPSBjdXJyLkRlc2NyaXB0aW9uO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHlwZUxhYmVsID0gY3Vyci5WZXJzaW9uO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29kZVNuaXBwZXQgPSBKU09OLnN0cmluZ2lmeShuYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFkZFZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlU25pcHBldCArPSAnOiBcInt7JyArIHZlcnNpb24gKyAnfX1cIic7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTGFzdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvZGVTbmlwcGV0ICs9ICcsJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQuYWRkKHsgdHlwZTogJ3Byb3BlcnR5JywgZGlzcGxheVRleHQ6IG5hbWUsIHNuaXBwZXQ6IGNvZGVTbmlwcGV0LCBjbGFzc05hbWU6IHR5cGVMYWJlbCwgZGVzY3JpcHRpb246IGRvY3VtZW50YXRpb24gfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdHMubGVuZ3RoID09PSBMSU1JVCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5zZXRBc0luY29tcGxldGUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWdub3JlXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQuZXJyb3IoYFJlcXVlc3QgdG8gdGhlIG51Z2V0IHJlcG9zaXRvcnkgZmFpbGVkOiAke3N1Y2Nlc3MucmVzcG9uc2VUZXh0fWApO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LCAoZXJyb3IpID0+IHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5lcnJvcihgUmVxdWVzdCB0byB0aGUgbnVnZXQgcmVwb3NpdG9yeSBmYWlsZWQ6ICR7ZXJyb3IucmVzcG9uc2VUZXh0fWApO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgY29sbGVjdFZhbHVlU3VnZ2VzdGlvbnMocmVzb3VyY2U6IFVSSSwgbG9jYXRpb246IEpTT05Mb2NhdGlvbiwgY3VycmVudEtleTogc3RyaW5nLCByZXN1bHQ6IEpTT05Xb3JrZXIuSVN1Z2dlc3Rpb25zQ29sbGVjdG9yKTogUHJvbWlzZTxhbnk+IHtcclxuICAgICAgICBpZiAodGhpcy5pc1Byb2plY3RKU09ORmlsZShyZXNvdXJjZSkgJiYgKGxvY2F0aW9uLm1hdGNoZXMoWydkZXBlbmRlbmNpZXMnXSkgfHwgbG9jYXRpb24ubWF0Y2hlcyhbJ2ZyYW1ld29ya3MnLCAnKicsICdkZXBlbmRlbmNpZXMnXSkgfHwgbG9jYXRpb24ubWF0Y2hlcyhbJ2ZyYW1ld29ya3MnLCAnKicsICdmcmFtZXdvcmtBc3NlbWJsaWVzJ10pKSkge1xyXG4gICAgICAgICAgICB2YXIgcXVlcnlVcmwgPSAnaHR0cHM6Ly93d3cubXlnZXQub3JnL0YvYXNwbmV0cmVsZWFzZS9hcGkvdjIvUGFja2FnZXM/J1xyXG4gICAgICAgICAgICAgICAgICAgICsgJyRmaWx0ZXI9SWQlMjBlcSUyMFxcJydcclxuICAgICAgICAgICAgICAgICAgICArIGVuY29kZVVSSUNvbXBvbmVudChjdXJyZW50S2V5KVxyXG4gICAgICAgICAgICAgICAgICAgICsgJ1xcJyYkc2VsZWN0PVZlcnNpb24sSXNBYnNvbHV0ZUxhdGVzdFZlcnNpb24mJGZvcm1hdD1qc29uJiR0b3A9JyArIExJTUlUO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHJlcXVlc3QueGhyKHtcclxuICAgICAgICAgICAgICAgIHVybCA6IHF1ZXJ5VXJsXHJcbiAgICAgICAgICAgIH0pLnRoZW4oKHN1Y2Nlc3MpID0+IHtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG9iaiA9IEpTT04ucGFyc2Uoc3VjY2Vzcy5yZXNwb25zZVRleHQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KG9iai5kKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0cyA9IDxhbnlbXT4gb2JqLmQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzdWx0cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnIgPSByZXN1bHRzW2ldO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZlcnNpb24gPSBjdXJyLlZlcnNpb247XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmVyc2lvbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuYW1lID0gSlNPTi5zdHJpbmdpZnkodmVyc2lvbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlzTGF0ZXN0ID0gY3Vyci5Jc0Fic29sdXRlTGF0ZXN0VmVyc2lvbiA9PT0gJ3RydWUnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsYWJlbCA9IG5hbWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRvY3VtZW50YXRpb25MYWJlbCA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0xhdGVzdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudGF0aW9uTGFiZWwgPSBgVGhlIGN1cnJlbnRseSBsYXRlc3QgdmVyc2lvbiBvZiB0aGUgcGFja2FnZWA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5hZGQoeyB0eXBlOiAnY2xhc3MnLCBkaXNwbGF5VGV4dDogbGFiZWwsIHNuaXBwZXQ6IG5hbWUsIGRlc2NyaXB0aW9uOiBkb2N1bWVudGF0aW9uTGFiZWwgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdHMubGVuZ3RoID09PSBMSU1JVCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnNldEFzSW5jb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGlnbm9yZVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgICAgIH0sIChlcnJvcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0SW5mb0NvbnRyaWJ1dGlvbihyZXNvdXJjZTogVVJJLCBsb2NhdGlvbjogSlNPTkxvY2F0aW9uKTogUHJvbWlzZTxIdG1sQ29udGVudC5JSFRNTENvbnRlbnRFbGVtZW50W10+IHtcclxuICAgICAgICBpZiAodGhpcy5pc1Byb2plY3RKU09ORmlsZShyZXNvdXJjZSkgJiYgKGxvY2F0aW9uLm1hdGNoZXMoWydkZXBlbmRlbmNpZXMnLCAnKiddKSB8fCBsb2NhdGlvbi5tYXRjaGVzKFsnZnJhbWV3b3JrcycsICcqJywgJ2RlcGVuZGVuY2llcycsICcqJ10pIHx8IGxvY2F0aW9uLm1hdGNoZXMoWydmcmFtZXdvcmtzJywgJyonLCAnZnJhbWV3b3JrQXNzZW1ibGllcycsICcqJ10pKSkge1xyXG4gICAgICAgICAgICB2YXIgcGFjayA9IGxvY2F0aW9uLmdldFNlZ21lbnRzKClbbG9jYXRpb24uZ2V0U2VnbWVudHMoKS5sZW5ndGggLSAxXTtcclxuXHJcbiAgICAgICAgICAgIHZhciBodG1sQ29udGVudCA6IEh0bWxDb250ZW50LklIVE1MQ29udGVudEVsZW1lbnRbXSA9IFtdO1xyXG4gICAgICAgICAgICBodG1sQ29udGVudC5wdXNoKHtjbGFzc05hbWU6ICd0eXBlJywgdGV4dDogcGFjayB9KTtcclxuXHJcbiAgICAgICAgICAgIHZhciBxdWVyeVVybCA9ICdodHRwczovL3d3dy5teWdldC5vcmcvRi9hc3BuZXRyZWxlYXNlL2FwaS92Mi9QYWNrYWdlcz8nXHJcbiAgICAgICAgICAgICAgICArICckZmlsdGVyPUlkJTIwZXElMjBcXCcnXHJcbiAgICAgICAgICAgICAgICArIGVuY29kZVVSSUNvbXBvbmVudChwYWNrKVxyXG4gICAgICAgICAgICAgICAgKyAnXFwnJTIwYW5kJTIwSXNBYnNvbHV0ZUxhdGVzdFZlcnNpb24lMjBlcSUyMHRydWUnXHJcbiAgICAgICAgICAgICAgICArICcmJHNlbGVjdD1WZXJzaW9uLERlc2NyaXB0aW9uJiRmb3JtYXQ9anNvbiYkdG9wPTUnO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHJlcXVlc3QueGhyKHtcclxuICAgICAgICAgICAgICAgIHVybCA6IHF1ZXJ5VXJsXHJcbiAgICAgICAgICAgIH0pLnRoZW4oKHN1Y2Nlc3MpID0+IHtcclxuICAgICAgICAgICAgICAgIHZhciBjb250ZW50ID0gc3VjY2Vzcy5yZXNwb25zZVRleHQ7XHJcbiAgICAgICAgICAgICAgICBpZiAoY29udGVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvYmogPSBKU09OLnBhcnNlKGNvbnRlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob2JqLmQgJiYgb2JqLmRbMF0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXMgPSBvYmouZFswXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXMuRGVzY3JpcHRpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBodG1sQ29udGVudC5wdXNoKHtjbGFzc05hbWU6ICdkb2N1bWVudGF0aW9uJywgdGV4dDogcmVzLkRlc2NyaXB0aW9uIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5WZXJzaW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaHRtbENvbnRlbnQucHVzaCh7Y2xhc3NOYW1lOiAnZG9jdW1lbnRhdGlvbicsIHRleHQ6IGBMYXRlc3QgdmVyc2lvbjogJHtyZXMuVmVyc2lvbn1gIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBpZ25vcmVcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaHRtbENvbnRlbnQ7XHJcbiAgICAgICAgICAgIH0sIChlcnJvcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGh0bWxDb250ZW50O1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbn1cclxuIiwiJ3VzZSBzdHJpY3QnO1xuaW1wb3J0IFN0cmluZ3MgZnJvbSAnLi4vY29tbW9uL3N0cmluZ3MnO1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdC1saWdodCc7XG52YXIgTElNSVQgPSA0MDtcbmV4cG9ydCBjbGFzcyBQcm9qZWN0SlNPTkNvbnRyaWJ1dGlvbiB7XG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgfVxuICAgIGlzUHJvamVjdEpTT05GaWxlKHJlc291cmNlKSB7XG4gICAgICAgIHZhciBwYXRoID0gcmVzb3VyY2UucGF0aDtcbiAgICAgICAgcmV0dXJuIFN0cmluZ3MuZW5kc1dpdGgocGF0aCwgJy9wcm9qZWN0Lmpzb24nKTtcbiAgICB9XG4gICAgY29sbGVjdERlZmF1bHRTdWdnZXN0aW9ucyhyZXNvdXJjZSwgcmVzdWx0KSB7XG4gICAgICAgIGlmICh0aGlzLmlzUHJvamVjdEpTT05GaWxlKHJlc291cmNlKSkge1xuICAgICAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZSA9IHtcbiAgICAgICAgICAgICAgICAndmVyc2lvbic6ICd7ezEuMC4wLSp9fScsXG4gICAgICAgICAgICAgICAgJ2RlcGVuZGVuY2llcyc6IHt9LFxuICAgICAgICAgICAgICAgICdmcmFtZXdvcmtzJzoge1xuICAgICAgICAgICAgICAgICAgICAnZG54NDUxJzoge30sXG4gICAgICAgICAgICAgICAgICAgICdkbnhjb3JlNTAnOiB7fVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICByZXN1bHQuYWRkKHsgdHlwZTogJ3NuaXBwZXQnLCBkaXNwbGF5VGV4dDogYERlZmF1bHQgcHJvamVjdC5qc29uYCwgc25pcHBldDogSlNPTi5zdHJpbmdpZnkoZGVmYXVsdFZhbHVlLCBudWxsLCAnXFx0JyksIGRlc2NyaXB0aW9uOiAnJyB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29sbGVjdFByb3BlcnR5U3VnZ2VzdGlvbnMocmVzb3VyY2UsIGxvY2F0aW9uLCBjdXJyZW50V29yZCwgYWRkVmFsdWUsIGlzTGFzdCwgcmVzdWx0KSB7XG4gICAgICAgIGlmICh0aGlzLmlzUHJvamVjdEpTT05GaWxlKHJlc291cmNlKSAmJiAobG9jYXRpb24ubWF0Y2hlcyhbJ2RlcGVuZGVuY2llcyddKSB8fCBsb2NhdGlvbi5tYXRjaGVzKFsnZnJhbWV3b3JrcycsICcqJywgJ2RlcGVuZGVuY2llcyddKSB8fCBsb2NhdGlvbi5tYXRjaGVzKFsnZnJhbWV3b3JrcycsICcqJywgJ2ZyYW1ld29ya0Fzc2VtYmxpZXMnXSkpKSB7XG4gICAgICAgICAgICB2YXIgcXVlcnlVcmw7XG4gICAgICAgICAgICBpZiAoY3VycmVudFdvcmQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHF1ZXJ5VXJsID0gJ2h0dHBzOi8vd3d3Lm51Z2V0Lm9yZy9hcGkvdjIvUGFja2FnZXM/J1xuICAgICAgICAgICAgICAgICAgICArICckZmlsdGVyPUlkJTIwZ2UlMjBcXCcnXG4gICAgICAgICAgICAgICAgICAgICsgZW5jb2RlVVJJQ29tcG9uZW50KGN1cnJlbnRXb3JkKVxuICAgICAgICAgICAgICAgICAgICArICdcXCclMjBhbmQlMjBJZCUyMGx0JTIwXFwnJ1xuICAgICAgICAgICAgICAgICAgICArIGVuY29kZVVSSUNvbXBvbmVudChjdXJyZW50V29yZCArICd6JylcbiAgICAgICAgICAgICAgICAgICAgKyAnXFwnJTIwYW5kJTIwSXNBYnNvbHV0ZUxhdGVzdFZlcnNpb24lMjBlcSUyMHRydWUnXG4gICAgICAgICAgICAgICAgICAgICsgJyYkc2VsZWN0PUlkLFZlcnNpb24sRGVzY3JpcHRpb24mJGZvcm1hdD1qc29uJiR0b3A9JyArIExJTUlUO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcXVlcnlVcmwgPSAnaHR0cHM6Ly93d3cubnVnZXQub3JnL2FwaS92Mi9QYWNrYWdlcz8nXG4gICAgICAgICAgICAgICAgICAgICsgJyRmaWx0ZXI9SXNBYnNvbHV0ZUxhdGVzdFZlcnNpb24lMjBlcSUyMHRydWUnXG4gICAgICAgICAgICAgICAgICAgICsgJyYkb3JkZXJieT1Eb3dubG9hZENvdW50JTIwZGVzYyYkdG9wPScgKyBMSU1JVFxuICAgICAgICAgICAgICAgICAgICArICcmJHNlbGVjdD1JZCxWZXJzaW9uLERvd25sb2FkQ291bnQsRGVzY3JpcHRpb24mJGZvcm1hdD1qc29uJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByZXF1ZXN0Lnhocih7XG4gICAgICAgICAgICAgICAgdXJsOiBxdWVyeVVybFxuICAgICAgICAgICAgfSkudGhlbigoc3VjY2VzcykgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChzdWNjZXNzLnN0YXR1cyA9PT0gMjAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgb2JqID0gSlNPTi5wYXJzZShzdWNjZXNzLnJlc3BvbnNlVGV4dCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShvYmouZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0cyA9IG9iai5kO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzdWx0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY3VyciA9IHJlc3VsdHNbaV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuYW1lID0gY3Vyci5JZDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZlcnNpb24gPSBjdXJyLlZlcnNpb247XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZG9jdW1lbnRhdGlvbiA9IGN1cnIuRGVzY3JpcHRpb247XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHlwZUxhYmVsID0gY3Vyci5WZXJzaW9uO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNvZGVTbmlwcGV0ID0gSlNPTi5zdHJpbmdpZnkobmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWRkVmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2RlU25pcHBldCArPSAnOiBcInt7JyArIHZlcnNpb24gKyAnfX1cIic7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0xhc3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29kZVNuaXBwZXQgKz0gJywnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5hZGQoeyB0eXBlOiAncHJvcGVydHknLCBkaXNwbGF5VGV4dDogbmFtZSwgc25pcHBldDogY29kZVNuaXBwZXQsIGNsYXNzTmFtZTogdHlwZUxhYmVsLCBkZXNjcmlwdGlvbjogZG9jdW1lbnRhdGlvbiB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0cy5sZW5ndGggPT09IExJTUlUKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5zZXRBc0luY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LmVycm9yKGBSZXF1ZXN0IHRvIHRoZSBudWdldCByZXBvc2l0b3J5IGZhaWxlZDogJHtzdWNjZXNzLnJlc3BvbnNlVGV4dH1gKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LmVycm9yKGBSZXF1ZXN0IHRvIHRoZSBudWdldCByZXBvc2l0b3J5IGZhaWxlZDogJHtlcnJvci5yZXNwb25zZVRleHR9YCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29sbGVjdFZhbHVlU3VnZ2VzdGlvbnMocmVzb3VyY2UsIGxvY2F0aW9uLCBjdXJyZW50S2V5LCByZXN1bHQpIHtcbiAgICAgICAgaWYgKHRoaXMuaXNQcm9qZWN0SlNPTkZpbGUocmVzb3VyY2UpICYmIChsb2NhdGlvbi5tYXRjaGVzKFsnZGVwZW5kZW5jaWVzJ10pIHx8IGxvY2F0aW9uLm1hdGNoZXMoWydmcmFtZXdvcmtzJywgJyonLCAnZGVwZW5kZW5jaWVzJ10pIHx8IGxvY2F0aW9uLm1hdGNoZXMoWydmcmFtZXdvcmtzJywgJyonLCAnZnJhbWV3b3JrQXNzZW1ibGllcyddKSkpIHtcbiAgICAgICAgICAgIHZhciBxdWVyeVVybCA9ICdodHRwczovL3d3dy5teWdldC5vcmcvRi9hc3BuZXRyZWxlYXNlL2FwaS92Mi9QYWNrYWdlcz8nXG4gICAgICAgICAgICAgICAgKyAnJGZpbHRlcj1JZCUyMGVxJTIwXFwnJ1xuICAgICAgICAgICAgICAgICsgZW5jb2RlVVJJQ29tcG9uZW50KGN1cnJlbnRLZXkpXG4gICAgICAgICAgICAgICAgKyAnXFwnJiRzZWxlY3Q9VmVyc2lvbixJc0Fic29sdXRlTGF0ZXN0VmVyc2lvbiYkZm9ybWF0PWpzb24mJHRvcD0nICsgTElNSVQ7XG4gICAgICAgICAgICByZXR1cm4gcmVxdWVzdC54aHIoe1xuICAgICAgICAgICAgICAgIHVybDogcXVlcnlVcmxcbiAgICAgICAgICAgIH0pLnRoZW4oKHN1Y2Nlc3MpID0+IHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgb2JqID0gSlNPTi5wYXJzZShzdWNjZXNzLnJlc3BvbnNlVGV4dCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KG9iai5kKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdHMgPSBvYmouZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzdWx0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjdXJyID0gcmVzdWx0c1tpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmVyc2lvbiA9IGN1cnIuVmVyc2lvbjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmVyc2lvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IEpTT04uc3RyaW5naWZ5KHZlcnNpb24pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXNMYXRlc3QgPSBjdXJyLklzQWJzb2x1dGVMYXRlc3RWZXJzaW9uID09PSAndHJ1ZSc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsYWJlbCA9IG5hbWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkb2N1bWVudGF0aW9uTGFiZWwgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzTGF0ZXN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudGF0aW9uTGFiZWwgPSBgVGhlIGN1cnJlbnRseSBsYXRlc3QgdmVyc2lvbiBvZiB0aGUgcGFja2FnZWA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LmFkZCh7IHR5cGU6ICdjbGFzcycsIGRpc3BsYXlUZXh0OiBsYWJlbCwgc25pcHBldDogbmFtZSwgZGVzY3JpcHRpb246IGRvY3VtZW50YXRpb25MYWJlbCB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0cy5sZW5ndGggPT09IExJTUlUKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnNldEFzSW5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICAgICAgfSwgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgZ2V0SW5mb0NvbnRyaWJ1dGlvbihyZXNvdXJjZSwgbG9jYXRpb24pIHtcbiAgICAgICAgaWYgKHRoaXMuaXNQcm9qZWN0SlNPTkZpbGUocmVzb3VyY2UpICYmIChsb2NhdGlvbi5tYXRjaGVzKFsnZGVwZW5kZW5jaWVzJywgJyonXSkgfHwgbG9jYXRpb24ubWF0Y2hlcyhbJ2ZyYW1ld29ya3MnLCAnKicsICdkZXBlbmRlbmNpZXMnLCAnKiddKSB8fCBsb2NhdGlvbi5tYXRjaGVzKFsnZnJhbWV3b3JrcycsICcqJywgJ2ZyYW1ld29ya0Fzc2VtYmxpZXMnLCAnKiddKSkpIHtcbiAgICAgICAgICAgIHZhciBwYWNrID0gbG9jYXRpb24uZ2V0U2VnbWVudHMoKVtsb2NhdGlvbi5nZXRTZWdtZW50cygpLmxlbmd0aCAtIDFdO1xuICAgICAgICAgICAgdmFyIGh0bWxDb250ZW50ID0gW107XG4gICAgICAgICAgICBodG1sQ29udGVudC5wdXNoKHsgY2xhc3NOYW1lOiAndHlwZScsIHRleHQ6IHBhY2sgfSk7XG4gICAgICAgICAgICB2YXIgcXVlcnlVcmwgPSAnaHR0cHM6Ly93d3cubXlnZXQub3JnL0YvYXNwbmV0cmVsZWFzZS9hcGkvdjIvUGFja2FnZXM/J1xuICAgICAgICAgICAgICAgICsgJyRmaWx0ZXI9SWQlMjBlcSUyMFxcJydcbiAgICAgICAgICAgICAgICArIGVuY29kZVVSSUNvbXBvbmVudChwYWNrKVxuICAgICAgICAgICAgICAgICsgJ1xcJyUyMGFuZCUyMElzQWJzb2x1dGVMYXRlc3RWZXJzaW9uJTIwZXElMjB0cnVlJ1xuICAgICAgICAgICAgICAgICsgJyYkc2VsZWN0PVZlcnNpb24sRGVzY3JpcHRpb24mJGZvcm1hdD1qc29uJiR0b3A9NSc7XG4gICAgICAgICAgICByZXR1cm4gcmVxdWVzdC54aHIoe1xuICAgICAgICAgICAgICAgIHVybDogcXVlcnlVcmxcbiAgICAgICAgICAgIH0pLnRoZW4oKHN1Y2Nlc3MpID0+IHtcbiAgICAgICAgICAgICAgICB2YXIgY29udGVudCA9IHN1Y2Nlc3MucmVzcG9uc2VUZXh0O1xuICAgICAgICAgICAgICAgIGlmIChjb250ZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgb2JqID0gSlNPTi5wYXJzZShjb250ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvYmouZCAmJiBvYmouZFswXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXMgPSBvYmouZFswXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzLkRlc2NyaXB0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0bWxDb250ZW50LnB1c2goeyBjbGFzc05hbWU6ICdkb2N1bWVudGF0aW9uJywgdGV4dDogcmVzLkRlc2NyaXB0aW9uIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzLlZlcnNpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaHRtbENvbnRlbnQucHVzaCh7IGNsYXNzTmFtZTogJ2RvY3VtZW50YXRpb24nLCB0ZXh0OiBgTGF0ZXN0IHZlcnNpb246ICR7cmVzLlZlcnNpb259YCB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gaHRtbENvbnRlbnQ7XG4gICAgICAgICAgICB9LCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gaHRtbENvbnRlbnQ7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG59XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
