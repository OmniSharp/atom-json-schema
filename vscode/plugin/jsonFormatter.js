'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.format = format;

var _jsoncParser = require('jsonc-parser');

var _jsoncParser2 = _interopRequireDefault(_jsoncParser);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function format(document, range, options) {
    var documentText = document.getText();
    var initialIndentLevel = void 0;
    var value = void 0;
    var rangeOffset = void 0;
    if (range) {
        var startPosition = Position.create(range.start.line, 0);
        rangeOffset = document.offsetAt(startPosition);
        var endOffset = document.offsetAt(Position.create(range.end.line + 1, 0));
        var endLineStart = document.offsetAt(Position.create(range.end.line, 0));
        while (endOffset > endLineStart && isEOL(documentText, endOffset - 1)) {
            endOffset--;
        }
        range = new Range(startPosition, document.positionAt(endOffset));
        value = documentText.substring(rangeOffset, endOffset);
        initialIndentLevel = computeIndentLevel(value, 0, options);
    } else {
        value = documentText;
        range = new Range(Position.create(0, 0), document.positionAt(value.length));
        initialIndentLevel = 0;
        rangeOffset = 0;
    }
    var eol = getEOL(document);
    var lineBreak = false;
    var indentLevel = 0;
    var indentValue = void 0;
    if (options.insertSpaces) {
        indentValue = repeat(' ', options.tabSize);
    } else {
        indentValue = '\t';
    }
    var scanner = _jsoncParser2.default.createScanner(value, false);
    function newLineAndIndent() {
        return eol + repeat(indentValue, initialIndentLevel + indentLevel);
    }
    function scanNext() {
        var token = scanner.scan();
        lineBreak = false;
        while (token === _jsoncParser2.default.SyntaxKind.Trivia || token === _jsoncParser2.default.SyntaxKind.LineBreakTrivia) {
            lineBreak = lineBreak || token === _jsoncParser2.default.SyntaxKind.LineBreakTrivia;
            token = scanner.scan();
        }
        return token;
    }
    var editOperations = [];
    function addEdit(text, startOffset, endOffset) {
        if (documentText.substring(startOffset, endOffset) !== text) {
            var replaceRange = new Range(document.positionAt(startOffset), document.positionAt(endOffset));
            editOperations.push(TextEdit.replace(replaceRange, text));
        }
    }
    var firstToken = scanNext();
    if (firstToken !== _jsoncParser2.default.SyntaxKind.EOF) {
        var firstTokenStart = scanner.getTokenOffset() + rangeOffset;
        var initialIndent = repeat(indentValue, initialIndentLevel);
        addEdit(initialIndent, rangeOffset, firstTokenStart);
    }
    while (firstToken !== _jsoncParser2.default.SyntaxKind.EOF) {
        var firstTokenEnd = scanner.getTokenOffset() + scanner.getTokenLength() + rangeOffset;
        var secondToken = scanNext();
        var replaceContent = '';
        while (!lineBreak && (secondToken === _jsoncParser2.default.SyntaxKind.LineCommentTrivia || secondToken === _jsoncParser2.default.SyntaxKind.BlockCommentTrivia)) {
            var commentTokenStart = scanner.getTokenOffset() + rangeOffset;
            addEdit(' ', firstTokenEnd, commentTokenStart);
            firstTokenEnd = scanner.getTokenOffset() + scanner.getTokenLength() + rangeOffset;
            replaceContent = secondToken === _jsoncParser2.default.SyntaxKind.LineCommentTrivia ? newLineAndIndent() : '';
            secondToken = scanNext();
        }
        if (secondToken === _jsoncParser2.default.SyntaxKind.CloseBraceToken) {
            if (firstToken !== _jsoncParser2.default.SyntaxKind.OpenBraceToken) {
                indentLevel--;
                replaceContent = newLineAndIndent();
            }
        } else if (secondToken === _jsoncParser2.default.SyntaxKind.CloseBracketToken) {
            if (firstToken !== _jsoncParser2.default.SyntaxKind.OpenBracketToken) {
                indentLevel--;
                replaceContent = newLineAndIndent();
            }
        } else {
            switch (firstToken) {
                case _jsoncParser2.default.SyntaxKind.OpenBracketToken:
                case _jsoncParser2.default.SyntaxKind.OpenBraceToken:
                    indentLevel++;
                    replaceContent = newLineAndIndent();
                    break;
                case _jsoncParser2.default.SyntaxKind.CommaToken:
                case _jsoncParser2.default.SyntaxKind.LineCommentTrivia:
                    replaceContent = newLineAndIndent();
                    break;
                case _jsoncParser2.default.SyntaxKind.BlockCommentTrivia:
                    if (lineBreak) {
                        replaceContent = newLineAndIndent();
                    } else {
                        replaceContent = ' ';
                    }
                    break;
                case _jsoncParser2.default.SyntaxKind.ColonToken:
                    replaceContent = ' ';
                    break;
                case _jsoncParser2.default.SyntaxKind.NullKeyword:
                case _jsoncParser2.default.SyntaxKind.TrueKeyword:
                case _jsoncParser2.default.SyntaxKind.FalseKeyword:
                case _jsoncParser2.default.SyntaxKind.NumericLiteral:
                    if (secondToken === _jsoncParser2.default.SyntaxKind.NullKeyword || secondToken === _jsoncParser2.default.SyntaxKind.FalseKeyword || secondToken === _jsoncParser2.default.SyntaxKind.NumericLiteral) {
                        replaceContent = ' ';
                    }
                    break;
            }
            if (lineBreak && (secondToken === _jsoncParser2.default.SyntaxKind.LineCommentTrivia || secondToken === _jsoncParser2.default.SyntaxKind.BlockCommentTrivia)) {
                replaceContent = newLineAndIndent();
            }
        }
        var secondTokenStart = scanner.getTokenOffset() + rangeOffset;
        addEdit(replaceContent, firstTokenEnd, secondTokenStart);
        firstToken = secondToken;
    }
    return editOperations;
}
function repeat(s, count) {
    var result = '';
    for (var i = 0; i < count; i++) {
        result += s;
    }
    return result;
}
function computeIndentLevel(content, offset, options) {
    var i = 0;
    var nChars = 0;
    var tabSize = options.tabSize || 4;
    while (i < content.length) {
        var ch = content.charAt(i);
        if (ch === ' ') {
            nChars++;
        } else if (ch === '\t') {
            nChars += tabSize;
        } else {
            break;
        }
        i++;
    }
    return Math.floor(nChars / tabSize);
}
function getEOL(document) {
    var text = document.getText();
    if (document.lineCount > 1) {
        var to = document.offsetAt(Position.create(1, 0));
        var from = to;
        while (from > 0 && isEOL(text, from - 1)) {
            from--;
        }
        return text.substr(from, to - from);
    }
    return '\n';
}
function isEOL(text, offset) {
    return '\r\n'.indexOf(text.charAt(offset)) !== -1;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZzY29kZS9wbHVnaW4vanNvbkZvcm1hdHRlci50cyIsInZzY29kZS9wbHVnaW4vanNvbkZvcm1hdHRlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFJQTs7Ozs7UUFJQSxNLEdBQUEsTTs7QUNQQTs7Ozs7O0FET0EsU0FBQSxNQUFBLENBQXVCLFFBQXZCLEVBQWtELEtBQWxELEVBQWdFLE9BQWhFLEVBQTBGO0FBQ3pGLFFBQU0sZUFBZSxTQUFTLE9BQVQsRUFBckI7QUFDQSxRQUFJLDJCQUFKO0FBQ0EsUUFBSSxjQUFKO0FBQ0EsUUFBSSxvQkFBSjtBQUNBLFFBQUksS0FBSixFQUFXO0FBQ1YsWUFBSSxnQkFBZ0IsU0FBUyxNQUFULENBQWdCLE1BQU0sS0FBTixDQUFZLElBQTVCLEVBQWtDLENBQWxDLENBQXBCO0FBQ0Esc0JBQWMsU0FBUyxRQUFULENBQWtCLGFBQWxCLENBQWQ7QUFFQSxZQUFJLFlBQVksU0FBUyxRQUFULENBQWtCLFNBQVMsTUFBVCxDQUFnQixNQUFNLEdBQU4sQ0FBVSxJQUFWLEdBQWlCLENBQWpDLEVBQW9DLENBQXBDLENBQWxCLENBQWhCO0FBQ0EsWUFBSSxlQUFlLFNBQVMsUUFBVCxDQUFrQixTQUFTLE1BQVQsQ0FBZ0IsTUFBTSxHQUFOLENBQVUsSUFBMUIsRUFBZ0MsQ0FBaEMsQ0FBbEIsQ0FBbkI7QUFDQSxlQUFPLFlBQVksWUFBWixJQUE0QixNQUFNLFlBQU4sRUFBb0IsWUFBWSxDQUFoQyxDQUFuQyxFQUF1RTtBQUN0RTtBQUNBO0FBQ0QsZ0JBQVEsSUFBSSxLQUFKLENBQVUsYUFBVixFQUF5QixTQUFTLFVBQVQsQ0FBb0IsU0FBcEIsQ0FBekIsQ0FBUjtBQUNBLGdCQUFRLGFBQWEsU0FBYixDQUF1QixXQUF2QixFQUFvQyxTQUFwQyxDQUFSO0FBQ0EsNkJBQXFCLG1CQUFtQixLQUFuQixFQUEwQixDQUExQixFQUE2QixPQUE3QixDQUFyQjtBQUNBLEtBWkQsTUFZTztBQUNOLGdCQUFRLFlBQVI7QUFDQSxnQkFB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QVQ7QUFDQSxZQUFJLE9BQU8sRUFBWDtBQUNBLGVBQU8sT0FBTyxDQUFQLElBQVksTUFBTSxJQUFOLEVBQVksT0FBTyxDQUFuQixDQUFuQixFQUEwQztBQUN6QztBQUNBO0FBQ0QsZUFBTyxLQUFLLE1BQUwsQ0FBWSxJQUFaLEVBQWtCLEtBQUssSUFBdkIsQ0FBUDtBQUNBO0FBQ0QsV0FBTyxJQUFQO0FBQ0E7QUFFRCxTQUFBLEtBQUEsQ0FBZSxJQUFmLEVBQTZCLE1BQTdCLEVBQTJDO0FBQzFDLFdBQU8sT0FBTyxPQUFQLENBQWUsS0FBSyxNQUFMLENBQVksTUFBWixDQUFmLE1BQXdDLENBQUMsQ0FBaEQ7QUFDQSIsImZpbGUiOiJ2c2NvZGUvcGx1Z2luL2pzb25Gb3JtYXR0ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4gKiAgQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuIFNlZSBMaWNlbnNlLnR4dCBpbiB0aGUgcHJvamVjdCByb290IGZvciBsaWNlbnNlIGluZm9ybWF0aW9uLlxyXG4gKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi9cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuaW1wb3J0IEpzb24gZnJvbSAnanNvbmMtcGFyc2VyJztcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBmb3JtYXQoZG9jdW1lbnQ6IEF0b20uVGV4dEVkaXRvciwgcmFuZ2U6IFJhbmdlLCBvcHRpb25zOiBGb3JtYXR0aW5nT3B0aW9ucyk6IFRleHRFZGl0W10ge1xyXG5cdGNvbnN0IGRvY3VtZW50VGV4dCA9IGRvY3VtZW50LmdldFRleHQoKTtcclxuXHRsZXQgaW5pdGlhbEluZGVudExldmVsOiBudW1iZXI7XHJcblx0bGV0IHZhbHVlOiBzdHJpbmc7XHJcblx0bGV0IHJhbmdlT2Zmc2V0OiBudW1iZXI7XHJcblx0aWYgKHJhbmdlKSB7XHJcblx0XHRsZXQgc3RhcnRQb3NpdGlvbiA9IFBvc2l0aW9uLmNyZWF0ZShyYW5nZS5zdGFydC5saW5lLCAwKTtcclxuXHRcdHJhbmdlT2Zmc2V0ID0gZG9jdW1lbnQub2Zmc2V0QXQoc3RhcnRQb3NpdGlvbik7XHJcblxyXG5cdFx0bGV0IGVuZE9mZnNldCA9IGRvY3VtZW50Lm9mZnNldEF0KFBvc2l0aW9uLmNyZWF0ZShyYW5nZS5lbmQubGluZSArIDEsIDApKTtcclxuXHRcdGxldCBlbmRMaW5lU3RhcnQgPSBkb2N1bWVudC5vZmZzZXRBdChQb3NpdGlvbi5jcmVhdGUocmFuZ2UuZW5kLmxpbmUsIDApKTtcclxuXHRcdHdoaWxlIChlbmRPZmZzZXQgPiBlbmRMaW5lU3RhcnQgJiYgaXNFT0woZG9jdW1lbnRUZXh0LCBlbmRPZmZzZXQgLSAxKSkge1xyXG5cdFx0XHRlbmRPZmZzZXQtLTtcclxuXHRcdH1cclxuXHRcdHJhbmdlID0gbmV3IFJhbmdlKHN0YXJ0UG9zaXRpb24sIGRvY3VtZW50LnBvc2l0aW9uQXQoZW5kT2Zmc2V0KSk7XHJcblx0XHR2YWx1ZSA9IGRvY3VtZW50VGV4dC5zdWJzdHJpbmcocmFuZ2VPZmZzZXQsIGVuZE9mZnNldCk7XHJcblx0XHRpbml0aWFsSW5kZW50TGV2ZWwgPSBjb21wdXRlSW5kZW50TGV2ZWwodmFsdWUsIDAsIG9wdGlvbnMpO1xyXG5cdH0gZWxzZSB7XHJcblx0XHR2YWx1ZSA9IGRvY3VtZW50VGV4dDtcclxuXHRcdHJhbmdlID0gbmV3IFJhbmdlKFBvc2l0aW9uLmNyZWF0ZSgwLCAwKSwgZG9jdW1lbnQucG9zaXRpb25BdCh2YWx1ZS5sZW5ndGgpKTtcclxuXHRcdGluaXRpYWxJbmRlbnRMZXZlbCA9IDA7XHJcblx0XHRyYW5nZU9mZnNldCA9IDA7XHJcblx0fVxyXG5cdGxldCBlb2wgPSBnZXRFT0woZG9jdW1lbnQpO1xyXG5cclxuXHRsZXQgbGluZUJyZWFrID0gZmFsc2U7XHJcblx0bGV0IGluZGVudExldmVsID0gMDtcclxuXHRsZXQgaW5kZW50VmFsdWU6IHN0cmluZztcclxuXHRpZiAob3B0aW9ucy5pbnNlcnRTcGFjZXMpIHtcclxuXHRcdGluZGVudFZhbHVlID0gcmVwZWF0KCcgJywgb3B0aW9ucy50YWJTaXplKTtcclxuXHR9IGVsc2Uge1xyXG5cdFx0aW5kZW50VmFsdWUgPSAnXFx0JztcclxuXHR9XHJcblxyXG5cdGxldCBzY2FubmVyID0gSnNvbi5jcmVhdGVTY2FubmVyKHZhbHVlLCBmYWxzZSk7XHJcblxyXG5cdGZ1bmN0aW9uIG5ld0xpbmVBbmRJbmRlbnQoKTogc3RyaW5nIHtcclxuXHRcdHJldHVybiBlb2wgKyByZXBlYXQoaW5kZW50VmFsdWUsIGluaXRpYWxJbmRlbnRMZXZlbCArIGluZGVudExldmVsKTtcclxuXHR9XHJcblx0ZnVuY3Rpb24gc2Nhbk5leHQoKTogSnNvbi5TeW50YXhLaW5kIHtcclxuXHRcdGxldCB0b2tlbiA9IHNjYW5uZXIuc2NhbigpO1xyXG5cdFx0bGluZUJyZWFrID0gZmFsc2U7XHJcblx0XHR3aGlsZSAodG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5Ucml2aWEgfHwgdG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5MaW5lQnJlYWtUcml2aWEpIHtcclxuXHRcdFx0bGluZUJyZWFrID0gbGluZUJyZWFrIHx8ICh0b2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkxpbmVCcmVha1RyaXZpYSk7XHJcblx0XHRcdHRva2VuID0gc2Nhbm5lci5zY2FuKCk7XHJcblx0XHR9XHJcblx0XHRyZXR1cm4gdG9rZW47XHJcblx0fVxyXG5cdGxldCBlZGl0T3BlcmF0aW9uczogVGV4dEVkaXRbXSA9IFtdO1xyXG5cdGZ1bmN0aW9uIGFkZEVkaXQodGV4dDogc3RyaW5nLCBzdGFydE9mZnNldDogbnVtYmVyLCBlbmRPZmZzZXQ6IG51bWJlcikge1xyXG5cdFx0aWYgKGRvY3VtZW50VGV4dC5zdWJzdHJpbmcoc3RhcnRPZmZzZXQsIGVuZE9mZnNldCkgIT09IHRleHQpIHtcclxuXHRcdFx0bGV0IHJlcGxhY2VSYW5nZSA9IG5ldyBSYW5nZShkb2N1bWVudC5wb3NpdGlvbkF0KHN0YXJ0T2Zmc2V0KSwgZG9jdW1lbnQucG9zaXRpb25BdChlbmRPZmZzZXQpKTtcclxuXHRcdFx0ZWRpdE9wZXJhdGlvbnMucHVzaChUZXh0RWRpdC5yZXBsYWNlKHJlcGxhY2VSYW5nZSwgdGV4dCkpO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0bGV0IGZpcnN0VG9rZW4gPSBzY2FuTmV4dCgpO1xyXG5cdGlmIChmaXJzdFRva2VuICE9PSBKc29uLlN5bnRheEtpbmQuRU9GKSB7XHJcblx0XHRsZXQgZmlyc3RUb2tlblN0YXJ0ID0gc2Nhbm5lci5nZXRUb2tlbk9mZnNldCgpICsgcmFuZ2VPZmZzZXQ7XHJcblx0XHRsZXQgaW5pdGlhbEluZGVudCA9IHJlcGVhdChpbmRlbnRWYWx1ZSwgaW5pdGlhbEluZGVudExldmVsKTtcclxuXHRcdGFkZEVkaXQoaW5pdGlhbEluZGVudCwgcmFuZ2VPZmZzZXQsIGZpcnN0VG9rZW5TdGFydCk7XHJcblx0fVxyXG5cclxuXHR3aGlsZSAoZmlyc3RUb2tlbiAhPT0gSnNvbi5TeW50YXhLaW5kLkVPRikge1xyXG5cdFx0bGV0IGZpcnN0VG9rZW5FbmQgPSBzY2FubmVyLmdldFRva2VuT2Zmc2V0KCkgKyBzY2FubmVyLmdldFRva2VuTGVuZ3RoKCkgKyByYW5nZU9mZnNldDtcclxuXHRcdGxldCBzZWNvbmRUb2tlbiA9IHNjYW5OZXh0KCk7XHJcblxyXG5cdFx0bGV0IHJlcGxhY2VDb250ZW50ID0gJyc7XHJcblx0XHR3aGlsZSAoIWxpbmVCcmVhayAmJiAoc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5MaW5lQ29tbWVudFRyaXZpYSB8fCBzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkJsb2NrQ29tbWVudFRyaXZpYSkpIHtcclxuXHRcdFx0Ly8gY29tbWVudHMgb24gdGhlIHNhbWUgbGluZToga2VlcCB0aGVtIG9uIHRoZSBzYW1lIGxpbmUsIGJ1dCBpZ25vcmUgdGhlbSBvdGhlcndpc2VcclxuXHRcdFx0bGV0IGNvbW1lbnRUb2tlblN0YXJ0ID0gc2Nhbm5lci5nZXRUb2tlbk9mZnNldCgpICsgcmFuZ2VPZmZzZXQ7XHJcblx0XHRcdGFkZEVkaXQoJyAnLCBmaXJzdFRva2VuRW5kLCBjb21tZW50VG9rZW5TdGFydCk7XHJcblx0XHRcdGZpcnN0VG9rZW5FbmQgPSBzY2FubmVyLmdldFRva2VuT2Zmc2V0KCkgKyBzY2FubmVyLmdldFRva2VuTGVuZ3RoKCkgKyByYW5nZU9mZnNldDtcclxuXHRcdFx0cmVwbGFjZUNvbnRlbnQgPSBzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkxpbmVDb21tZW50VHJpdmlhID8gbmV3TGluZUFuZEluZGVudCgpIDogJyc7XHJcblx0XHRcdHNlY29uZFRva2VuID0gc2Nhbk5leHQoKTtcclxuXHRcdH1cclxuXHJcblx0XHRpZiAoc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5DbG9zZUJyYWNlVG9rZW4pIHtcclxuXHRcdFx0aWYgKGZpcnN0VG9rZW4gIT09IEpzb24uU3ludGF4S2luZC5PcGVuQnJhY2VUb2tlbikge1xyXG5cdFx0XHRcdGluZGVudExldmVsLS07XHJcblx0XHRcdFx0cmVwbGFjZUNvbnRlbnQgPSBuZXdMaW5lQW5kSW5kZW50KCk7XHJcblx0XHRcdH1cclxuXHRcdH0gZWxzZSBpZiAoc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5DbG9zZUJyYWNrZXRUb2tlbikge1xyXG5cdFx0XHRpZiAoZmlyc3RUb2tlbiAhPT0gSnNvbi5TeW50YXhLaW5kLk9wZW5CcmFja2V0VG9rZW4pIHtcclxuXHRcdFx0XHRpbmRlbnRMZXZlbC0tO1xyXG5cdFx0XHRcdHJlcGxhY2VDb250ZW50ID0gbmV3TGluZUFuZEluZGVudCgpO1xyXG5cdFx0XHR9XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHRzd2l0Y2ggKGZpcnN0VG9rZW4pIHtcclxuXHRcdFx0XHRjYXNlIEpzb24uU3ludGF4S2luZC5PcGVuQnJhY2tldFRva2VuOlxyXG5cdFx0XHRcdGNhc2UgSnNvbi5TeW50YXhLaW5kLk9wZW5CcmFjZVRva2VuOlxyXG5cdFx0XHRcdFx0aW5kZW50TGV2ZWwrKztcclxuXHRcdFx0XHRcdHJlcGxhY2VDb250ZW50ID0gbmV3TGluZUFuZEluZGVudCgpO1xyXG5cdFx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdFx0Y2FzZSBKc29uLlN5bnRheEtpbmQuQ29tbWFUb2tlbjpcclxuXHRcdFx0XHRjYXNlIEpzb24uU3ludGF4S2luZC5MaW5lQ29tbWVudFRyaXZpYTpcclxuXHRcdFx0XHRcdHJlcGxhY2VDb250ZW50ID0gbmV3TGluZUFuZEluZGVudCgpO1xyXG5cdFx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdFx0Y2FzZSBKc29uLlN5bnRheEtpbmQuQmxvY2tDb21tZW50VHJpdmlhOlxyXG5cdFx0XHRcdFx0aWYgKGxpbmVCcmVhaykge1xyXG5cdFx0XHRcdFx0XHRyZXBsYWNlQ29udGVudCA9IG5ld0xpbmVBbmRJbmRlbnQoKTtcclxuXHRcdFx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0XHRcdC8vIHN5bWJvbCBmb2xsb3dpbmcgY29tbWVudCBvbiB0aGUgc2FtZSBsaW5lOiBrZWVwIG9uIHNhbWUgbGluZSwgc2VwYXJhdGUgd2l0aCAnICdcclxuXHRcdFx0XHRcdFx0cmVwbGFjZUNvbnRlbnQgPSAnICc7XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHRicmVhaztcclxuXHRcdFx0XHRjYXNlIEpzb24uU3ludGF4S2luZC5Db2xvblRva2VuOlxyXG5cdFx0XHRcdFx0cmVwbGFjZUNvbnRlbnQgPSAnICc7XHJcblx0XHRcdFx0XHRicmVhaztcclxuXHRcdFx0XHRjYXNlIEpzb24uU3ludGF4S2luZC5OdWxsS2V5d29yZDpcclxuXHRcdFx0XHRjYXNlIEpzb24uU3ludGF4S2luZC5UcnVlS2V5d29yZDpcclxuXHRcdFx0XHRjYXNlIEpzb24uU3ludGF4S2luZC5GYWxzZUtleXdvcmQ6XHJcblx0XHRcdFx0Y2FzZSBKc29uLlN5bnRheEtpbmQuTnVtZXJpY0xpdGVyYWw6XHJcblx0XHRcdFx0XHRpZiAoc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5OdWxsS2V5d29yZCB8fCBzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkZhbHNlS2V5d29yZCB8fCBzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLk51bWVyaWNMaXRlcmFsKSB7XHJcblx0XHRcdFx0XHRcdHJlcGxhY2VDb250ZW50ID0gJyAnO1xyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdH1cclxuXHRcdFx0aWYgKGxpbmVCcmVhayAmJiAoc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5MaW5lQ29tbWVudFRyaXZpYSB8fCBzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkJsb2NrQ29tbWVudFRyaXZpYSkpIHtcclxuXHRcdFx0XHRyZXBsYWNlQ29udGVudCA9IG5ld0xpbmVBbmRJbmRlbnQoKTtcclxuXHRcdFx0fVxyXG5cclxuXHRcdH1cclxuXHRcdGxldCBzZWNvbmRUb2tlblN0YXJ0ID0gc2Nhbm5lci5nZXRUb2tlbk9mZnNldCgpICsgcmFuZ2VPZmZzZXQ7XHJcblx0XHRhZGRFZGl0KHJlcGxhY2VDb250ZW50LCBmaXJzdFRva2VuRW5kLCBzZWNvbmRUb2tlblN0YXJ0KTtcclxuXHRcdGZpcnN0VG9rZW4gPSBzZWNvbmRUb2tlbjtcclxuXHR9XHJcblx0cmV0dXJuIGVkaXRPcGVyYXRpb25zO1xyXG59XHJcblxyXG5mdW5jdGlvbiByZXBlYXQoczogc3RyaW5nLCBjb3VudDogbnVtYmVyKTogc3RyaW5nIHtcclxuXHRsZXQgcmVzdWx0ID0gJyc7XHJcblx0Zm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7XHJcblx0XHRyZXN1bHQgKz0gcztcclxuXHR9XHJcblx0cmV0dXJuIHJlc3VsdDtcclxufVxyXG5cclxuZnVuY3Rpb24gY29tcHV0ZUluZGVudExldmVsKGNvbnRlbnQ6IHN0cmluZywgb2Zmc2V0OiBudW1iZXIsIG9wdGlvbnM6IEZvcm1hdHRpbmdPcHRpb25zKTogbnVtYmVyIHtcclxuXHRsZXQgaSA9IDA7XHJcblx0bGV0IG5DaGFycyA9IDA7XHJcblx0bGV0IHRhYlNpemUgPSBvcHRpb25zLnRhYlNpemUgfHwgNDtcclxuXHR3aGlsZSAoaSA8IGNvbnRlbnQubGVuZ3RoKSB7XHJcblx0XHRsZXQgY2ggPSBjb250ZW50LmNoYXJBdChpKTtcclxuXHRcdGlmIChjaCA9PT0gJyAnKSB7XHJcblx0XHRcdG5DaGFycysrO1xyXG5cdFx0fSBlbHNlIGlmIChjaCA9PT0gJ1xcdCcpIHtcclxuXHRcdFx0bkNoYXJzICs9IHRhYlNpemU7XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHRicmVhaztcclxuXHRcdH1cclxuXHRcdGkrKztcclxuXHR9XHJcblx0cmV0dXJuIE1hdGguZmxvb3IobkNoYXJzIC8gdGFiU2l6ZSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldEVPTChkb2N1bWVudDogQXRvbS5UZXh0RWRpdG9yKTogc3RyaW5nIHtcclxuXHRsZXQgdGV4dCA9IGRvY3VtZW50LmdldFRleHQoKTtcclxuXHRpZiAoZG9jdW1lbnQubGluZUNvdW50ID4gMSkge1xyXG5cdFx0bGV0IHRvID0gZG9jdW1lbnQub2Zmc2V0QXQoUG9zaXRpb24uY3JlYXRlKDEsIDApKTtcclxuXHRcdGxldCBmcm9tID0gdG87XHJcblx0XHR3aGlsZSAoZnJvbSA+IDAgJiYgaXNFT0wodGV4dCwgZnJvbSAtIDEpKSB7XHJcblx0XHRcdGZyb20tLTtcclxuXHRcdH1cclxuXHRcdHJldHVybiB0ZXh0LnN1YnN0cihmcm9tLCB0byAtIGZyb20pO1xyXG5cdH1cclxuXHRyZXR1cm4gJ1xcbic7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzRU9MKHRleHQ6IHN0cmluZywgb2Zmc2V0OiBudW1iZXIpIHtcclxuXHRyZXR1cm4gJ1xcclxcbicuaW5kZXhPZih0ZXh0LmNoYXJBdChvZmZzZXQpKSAhPT0gLTE7XHJcbn0iLCIndXNlIHN0cmljdCc7XG5pbXBvcnQgSnNvbiBmcm9tICdqc29uYy1wYXJzZXInO1xuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdChkb2N1bWVudCwgcmFuZ2UsIG9wdGlvbnMpIHtcbiAgICBjb25zdCBkb2N1bWVudFRleHQgPSBkb2N1bWVudC5nZXRUZXh0KCk7XG4gICAgbGV0IGluaXRpYWxJbmRlbnRMZXZlbDtcbiAgICBsZXQgdmFsdWU7XG4gICAgbGV0IHJhbmdlT2Zmc2V0O1xuICAgIGlmIChyYW5nZSkge1xuICAgICAgICBsZXQgc3RhcnRQb3NpdGlvbiA9IFBvc2l0aW9uLmNyZWF0ZShyYW5nZS5zdGFydC5saW5lLCAwKTtcbiAgICAgICAgcmFuZ2VPZmZzZXQgPSBkb2N1bWVudC5vZmZzZXRBdChzdGFydFBvc2l0aW9uKTtcbiAgICAgICAgbGV0IGVuZE9mZnNldCA9IGRvY3VtZW50Lm9mZnNldEF0KFBvc2l0aW9uLmNyZWF0ZShyYW5nZS5lbmQubGluZSArIDEsIDApKTtcbiAgICAgICAgbGV0IGVuZExpbmVTdGFydCA9IGRvY3VtZW50Lm9mZnNldEF0KFBvc2l0aW9uLmNyZWF0ZShyYW5nZS5lbmQubGluZSwgMCkpO1xuICAgICAgICB3aGlsZSAoZW5kT2Zmc2V0ID4gZW5kTGluZVN0YXJ0ICYmIGlzRU9MKGRvY3VtZW50VGV4dCwgZW5kT2Zmc2V0IC0gMSkpIHtcbiAgICAgICAgICAgIGVuZE9mZnNldC0tO1xuICAgICAgICB9XG4gICAgICAgIHJhbmdlID0gbmV3IFJhbmdlKHN0YXJ0UG9zaXRpb24sIGRvY3VtZW50LnBvc2l0aW9uQXQoZW5kT2Zmc2V0KSk7XG4gICAgICAgIHZhbHVlID0gZG9jdW1lbnRUZXh0LnN1YnN0cmluZyhyYW5nZU9mZnNldCwgZW5kT2Zmc2V0KTtcbiAgICAgICAgaW5pdGlhbEluZGVudExldmVsID0gY29tcHV0ZUluZGVudExldmVsKHZhbHVlLCAwLCBvcHRpb25zKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIHZhbHVlID0gZG9jdW1lbnRUZXh0O1xuICAgICAgICByYW5nZSA9IG5ldyBSYW5nZShQb3NpdGlvbi5jcmVhdGUoMCwgMCksIGRvY3VtZW50LnBvc2l0aW9uQXQodmFsdWUubGVuZ3RoKSk7XG4gICAgICAgIGluaXRpYWxJbmRlbnRMZXZlbCA9IDA7XG4gICAgICAgIHJhbmdlT2Zmc2V0ID0gMDtcbiAgICB9XG4gICAgbGV0IGVvbCA9IGdldEVPTChkb2N1bWVudCk7XG4gICAgbGV0IGxpbmVCcmVhayA9IGZhbHNlO1xuICAgIGxldCBpbmRlbnRMZXZlbCA9IDA7XG4gICAgbGV0IGluZGVudFZhbHVlO1xuICAgIGlmIChvcHRpb25zLmluc2VydFNwYWNlcykge1xuICAgICAgICBpbmRlbnRWYWx1ZSA9IHJlcGVhdCgnICcsIG9wdGlvbnMudGFiU2l6ZSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBpbmRlbnRWYWx1ZSA9ICdcXHQnO1xuICAgIH1cbiAgICBsZXQgc2Nhbm5lciA9IEpzb24uY3JlYXRlU2Nhbm5lcih2YWx1ZSwgZmFsc2UpO1xuICAgIGZ1bmN0aW9uIG5ld0xpbmVBbmRJbmRlbnQoKSB7XG4gICAgICAgIHJldHVybiBlb2wgKyByZXBlYXQoaW5kZW50VmFsdWUsIGluaXRpYWxJbmRlbnRMZXZlbCArIGluZGVudExldmVsKTtcbiAgICB9XG4gICAgZnVuY3Rpb24gc2Nhbk5leHQoKSB7XG4gICAgICAgIGxldCB0b2tlbiA9IHNjYW5uZXIuc2NhbigpO1xuICAgICAgICBsaW5lQnJlYWsgPSBmYWxzZTtcbiAgICAgICAgd2hpbGUgKHRva2VuID09PSBKc29uLlN5bnRheEtpbmQuVHJpdmlhIHx8IHRva2VuID09PSBKc29uLlN5bnRheEtpbmQuTGluZUJyZWFrVHJpdmlhKSB7XG4gICAgICAgICAgICBsaW5lQnJlYWsgPSBsaW5lQnJlYWsgfHwgKHRva2VuID09PSBKc29uLlN5bnRheEtpbmQuTGluZUJyZWFrVHJpdmlhKTtcbiAgICAgICAgICAgIHRva2VuID0gc2Nhbm5lci5zY2FuKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRva2VuO1xuICAgIH1cbiAgICBsZXQgZWRpdE9wZXJhdGlvbnMgPSBbXTtcbiAgICBmdW5jdGlvbiBhZGRFZGl0KHRleHQsIHN0YXJ0T2Zmc2V0LCBlbmRPZmZzZXQpIHtcbiAgICAgICAgaWYgKGRvY3VtZW50VGV4dC5zdWJzdHJpbmcoc3RhcnRPZmZzZXQsIGVuZE9mZnNldCkgIT09IHRleHQpIHtcbiAgICAgICAgICAgIGxldCByZXBsYWNlUmFuZ2UgPSBuZXcgUmFuZ2UoZG9jdW1lbnQucG9zaXRpb25BdChzdGFydE9mZnNldCksIGRvY3VtZW50LnBvc2l0aW9uQXQoZW5kT2Zmc2V0KSk7XG4gICAgICAgICAgICBlZGl0T3BlcmF0aW9ucy5wdXNoKFRleHRFZGl0LnJlcGxhY2UocmVwbGFjZVJhbmdlLCB0ZXh0KSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgbGV0IGZpcnN0VG9rZW4gPSBzY2FuTmV4dCgpO1xuICAgIGlmIChmaXJzdFRva2VuICE9PSBKc29uLlN5bnRheEtpbmQuRU9GKSB7XG4gICAgICAgIGxldCBmaXJzdFRva2VuU3RhcnQgPSBzY2FubmVyLmdldFRva2VuT2Zmc2V0KCkgKyByYW5nZU9mZnNldDtcbiAgICAgICAgbGV0IGluaXRpYWxJbmRlbnQgPSByZXBlYXQoaW5kZW50VmFsdWUsIGluaXRpYWxJbmRlbnRMZXZlbCk7XG4gICAgICAgIGFkZEVkaXQoaW5pdGlhbEluZGVudCwgcmFuZ2VPZmZzZXQsIGZpcnN0VG9rZW5TdGFydCk7XG4gICAgfVxuICAgIHdoaWxlIChmaXJzdFRva2VuICE9PSBKc29uLlN5bnRheEtpbmQuRU9GKSB7XG4gICAgICAgIGxldCBmaXJzdFRva2VuRW5kID0gc2Nhbm5lci5nZXRUb2tlbk9mZnNldCgpICsgc2Nhbm5lci5nZXRUb2tlbkxlbmd0aCgpICsgcmFuZ2VPZmZzZXQ7XG4gICAgICAgIGxldCBzZWNvbmRUb2tlbiA9IHNjYW5OZXh0KCk7XG4gICAgICAgIGxldCByZXBsYWNlQ29udGVudCA9ICcnO1xuICAgICAgICB3aGlsZSAoIWxpbmVCcmVhayAmJiAoc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5MaW5lQ29tbWVudFRyaXZpYSB8fCBzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkJsb2NrQ29tbWVudFRyaXZpYSkpIHtcbiAgICAgICAgICAgIGxldCBjb21tZW50VG9rZW5TdGFydCA9IHNjYW5uZXIuZ2V0VG9rZW5PZmZzZXQoKSArIHJhbmdlT2Zmc2V0O1xuICAgICAgICAgICAgYWRkRWRpdCgnICcsIGZpcnN0VG9rZW5FbmQsIGNvbW1lbnRUb2tlblN0YXJ0KTtcbiAgICAgICAgICAgIGZpcnN0VG9rZW5FbmQgPSBzY2FubmVyLmdldFRva2VuT2Zmc2V0KCkgKyBzY2FubmVyLmdldFRva2VuTGVuZ3RoKCkgKyByYW5nZU9mZnNldDtcbiAgICAgICAgICAgIHJlcGxhY2VDb250ZW50ID0gc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5MaW5lQ29tbWVudFRyaXZpYSA/IG5ld0xpbmVBbmRJbmRlbnQoKSA6ICcnO1xuICAgICAgICAgICAgc2Vjb25kVG9rZW4gPSBzY2FuTmV4dCgpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkNsb3NlQnJhY2VUb2tlbikge1xuICAgICAgICAgICAgaWYgKGZpcnN0VG9rZW4gIT09IEpzb24uU3ludGF4S2luZC5PcGVuQnJhY2VUb2tlbikge1xuICAgICAgICAgICAgICAgIGluZGVudExldmVsLS07XG4gICAgICAgICAgICAgICAgcmVwbGFjZUNvbnRlbnQgPSBuZXdMaW5lQW5kSW5kZW50KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5DbG9zZUJyYWNrZXRUb2tlbikge1xuICAgICAgICAgICAgaWYgKGZpcnN0VG9rZW4gIT09IEpzb24uU3ludGF4S2luZC5PcGVuQnJhY2tldFRva2VuKSB7XG4gICAgICAgICAgICAgICAgaW5kZW50TGV2ZWwtLTtcbiAgICAgICAgICAgICAgICByZXBsYWNlQ29udGVudCA9IG5ld0xpbmVBbmRJbmRlbnQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHN3aXRjaCAoZmlyc3RUb2tlbikge1xuICAgICAgICAgICAgICAgIGNhc2UgSnNvbi5TeW50YXhLaW5kLk9wZW5CcmFja2V0VG9rZW46XG4gICAgICAgICAgICAgICAgY2FzZSBKc29uLlN5bnRheEtpbmQuT3BlbkJyYWNlVG9rZW46XG4gICAgICAgICAgICAgICAgICAgIGluZGVudExldmVsKys7XG4gICAgICAgICAgICAgICAgICAgIHJlcGxhY2VDb250ZW50ID0gbmV3TGluZUFuZEluZGVudCgpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlIEpzb24uU3ludGF4S2luZC5Db21tYVRva2VuOlxuICAgICAgICAgICAgICAgIGNhc2UgSnNvbi5TeW50YXhLaW5kLkxpbmVDb21tZW50VHJpdmlhOlxuICAgICAgICAgICAgICAgICAgICByZXBsYWNlQ29udGVudCA9IG5ld0xpbmVBbmRJbmRlbnQoKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSBKc29uLlN5bnRheEtpbmQuQmxvY2tDb21tZW50VHJpdmlhOlxuICAgICAgICAgICAgICAgICAgICBpZiAobGluZUJyZWFrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlQ29udGVudCA9IG5ld0xpbmVBbmRJbmRlbnQoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VDb250ZW50ID0gJyAnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgSnNvbi5TeW50YXhLaW5kLkNvbG9uVG9rZW46XG4gICAgICAgICAgICAgICAgICAgIHJlcGxhY2VDb250ZW50ID0gJyAnO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlIEpzb24uU3ludGF4S2luZC5OdWxsS2V5d29yZDpcbiAgICAgICAgICAgICAgICBjYXNlIEpzb24uU3ludGF4S2luZC5UcnVlS2V5d29yZDpcbiAgICAgICAgICAgICAgICBjYXNlIEpzb24uU3ludGF4S2luZC5GYWxzZUtleXdvcmQ6XG4gICAgICAgICAgICAgICAgY2FzZSBKc29uLlN5bnRheEtpbmQuTnVtZXJpY0xpdGVyYWw6XG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLk51bGxLZXl3b3JkIHx8IHNlY29uZFRva2VuID09PSBKc29uLlN5bnRheEtpbmQuRmFsc2VLZXl3b3JkIHx8IHNlY29uZFRva2VuID09PSBKc29uLlN5bnRheEtpbmQuTnVtZXJpY0xpdGVyYWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VDb250ZW50ID0gJyAnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGxpbmVCcmVhayAmJiAoc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5MaW5lQ29tbWVudFRyaXZpYSB8fCBzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkJsb2NrQ29tbWVudFRyaXZpYSkpIHtcbiAgICAgICAgICAgICAgICByZXBsYWNlQ29udGVudCA9IG5ld0xpbmVBbmRJbmRlbnQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBsZXQgc2Vjb25kVG9rZW5TdGFydCA9IHNjYW5uZXIuZ2V0VG9rZW5PZmZzZXQoKSArIHJhbmdlT2Zmc2V0O1xuICAgICAgICBhZGRFZGl0KHJlcGxhY2VDb250ZW50LCBmaXJzdFRva2VuRW5kLCBzZWNvbmRUb2tlblN0YXJ0KTtcbiAgICAgICAgZmlyc3RUb2tlbiA9IHNlY29uZFRva2VuO1xuICAgIH1cbiAgICByZXR1cm4gZWRpdE9wZXJhdGlvbnM7XG59XG5mdW5jdGlvbiByZXBlYXQocywgY291bnQpIHtcbiAgICBsZXQgcmVzdWx0ID0gJyc7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7XG4gICAgICAgIHJlc3VsdCArPSBzO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xufVxuZnVuY3Rpb24gY29tcHV0ZUluZGVudExldmVsKGNvbnRlbnQsIG9mZnNldCwgb3B0aW9ucykge1xuICAgIGxldCBpID0gMDtcbiAgICBsZXQgbkNoYXJzID0gMDtcbiAgICBsZXQgdGFiU2l6ZSA9IG9wdGlvbnMudGFiU2l6ZSB8fCA0O1xuICAgIHdoaWxlIChpIDwgY29udGVudC5sZW5ndGgpIHtcbiAgICAgICAgbGV0IGNoID0gY29udGVudC5jaGFyQXQoaSk7XG4gICAgICAgIGlmIChjaCA9PT0gJyAnKSB7XG4gICAgICAgICAgICBuQ2hhcnMrKztcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChjaCA9PT0gJ1xcdCcpIHtcbiAgICAgICAgICAgIG5DaGFycyArPSB0YWJTaXplO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgaSsrO1xuICAgIH1cbiAgICByZXR1cm4gTWF0aC5mbG9vcihuQ2hhcnMgLyB0YWJTaXplKTtcbn1cbmZ1bmN0aW9uIGdldEVPTChkb2N1bWVudCkge1xuICAgIGxldCB0ZXh0ID0gZG9jdW1lbnQuZ2V0VGV4dCgpO1xuICAgIGlmIChkb2N1bWVudC5saW5lQ291bnQgPiAxKSB7XG4gICAgICAgIGxldCB0byA9IGRvY3VtZW50Lm9mZnNldEF0KFBvc2l0aW9uLmNyZWF0ZSgxLCAwKSk7XG4gICAgICAgIGxldCBmcm9tID0gdG87XG4gICAgICAgIHdoaWxlIChmcm9tID4gMCAmJiBpc0VPTCh0ZXh0LCBmcm9tIC0gMSkpIHtcbiAgICAgICAgICAgIGZyb20tLTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGV4dC5zdWJzdHIoZnJvbSwgdG8gLSBmcm9tKTtcbiAgICB9XG4gICAgcmV0dXJuICdcXG4nO1xufVxuZnVuY3Rpb24gaXNFT0wodGV4dCwgb2Zmc2V0KSB7XG4gICAgcmV0dXJuICdcXHJcXG4nLmluZGV4T2YodGV4dC5jaGFyQXQob2Zmc2V0KSkgIT09IC0xO1xufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
