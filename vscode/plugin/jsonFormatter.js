'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.format = format;

var _jsoncParser = require('jsonc-parser');

var _jsoncParser2 = _interopRequireDefault(_jsoncParser);

var _atom = require('atom');

var _textBuffer = require('text-buffer');

var _textBuffer2 = _interopRequireDefault(_textBuffer);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var Range = _textBuffer2.default.Range;
function format(document, range, options) {
    var documentText = document.getText();
    var initialIndentLevel = void 0;
    var value = void 0;
    var rangeOffset = void 0;
    if (range) {
        var startPosition = new _atom.Point(range.start.row, 0);
        rangeOffset = document.getBuffer().characterIndexForPosition(startPosition);
        var endOffset = document.getBuffer().characterIndexForPosition(new _atom.Point(range.end.row + 1, 0));
        var endLineStart = document.getBuffer().characterIndexForPosition(new _atom.Point(range.end.row, 0));
        while (endOffset > endLineStart && isEOL(documentText, endOffset - 1)) {
            endOffset--;
        }
        range = new Range(startPosition, document.getBuffer().positionForCharacterIndex(endOffset));
        value = documentText.substring(rangeOffset, endOffset);
        initialIndentLevel = computeIndentLevel(value, 0, options);
    } else {
        value = documentText;
        range = new Range(new _atom.Point(0, 0), document.getBuffer().getEndPosition());
        initialIndentLevel = 0;
        rangeOffset = 0;
    }
    var eol = getEOL(document);
    var lineBreak = false;
    var indentLevel = 0;
    var indentValue = void 0;
    if (options.insertSpaces) {
        indentValue = repeat(' ', options.tabSize);
    } else {
        indentValue = '\t';
    }
    var scanner = _jsoncParser2.default.createScanner(value, false);
    function newLineAndIndent() {
        return eol + repeat(indentValue, initialIndentLevel + indentLevel);
    }
    function scanNext() {
        var token = scanner.scan();
        lineBreak = false;
        while (token === _jsoncParser2.default.SyntaxKind.Trivia || token === _jsoncParser2.default.SyntaxKind.LineBreakTrivia) {
            lineBreak = lineBreak || token === _jsoncParser2.default.SyntaxKind.LineBreakTrivia;
            token = scanner.scan();
        }
        return token;
    }
    var editOperations = [];
    function addEdit(text, startOffset, endOffset) {
        if (documentText.substring(startOffset, endOffset) !== text) {
            var replaceRange = new Range(document.getBuffer().positionForCharacterIndex(startOffset), document.getBuffer().positionForCharacterIndex(endOffset));
            editOperations.push({ range: replaceRange, text: text });
        }
    }
    var firstToken = scanNext();
    if (firstToken !== _jsoncParser2.default.SyntaxKind.EOF) {
        var firstTokenStart = scanner.getTokenOffset() + rangeOffset;
        var initialIndent = repeat(indentValue, initialIndentLevel);
        addEdit(initialIndent, rangeOffset, firstTokenStart);
    }
    while (firstToken !== _jsoncParser2.default.SyntaxKind.EOF) {
        var firstTokenEnd = scanner.getTokenOffset() + scanner.getTokenLength() + rangeOffset;
        var secondToken = scanNext();
        var replaceContent = '';
        while (!lineBreak && (secondToken === _jsoncParser2.default.SyntaxKind.LineCommentTrivia || secondToken === _jsoncParser2.default.SyntaxKind.BlockCommentTrivia)) {
            var commentTokenStart = scanner.getTokenOffset() + rangeOffset;
            addEdit(' ', firstTokenEnd, commentTokenStart);
            firstTokenEnd = scanner.getTokenOffset() + scanner.getTokenLength() + rangeOffset;
            replaceContent = secondToken === _jsoncParser2.default.SyntaxKind.LineCommentTrivia ? newLineAndIndent() : '';
            secondToken = scanNext();
        }
        if (secondToken === _jsoncParser2.default.SyntaxKind.CloseBraceToken) {
            if (firstToken !== _jsoncParser2.default.SyntaxKind.OpenBraceToken) {
                indentLevel--;
                replaceContent = newLineAndIndent();
            }
        } else if (secondToken === _jsoncParser2.default.SyntaxKind.CloseBracketToken) {
            if (firstToken !== _jsoncParser2.default.SyntaxKind.OpenBracketToken) {
                indentLevel--;
                replaceContent = newLineAndIndent();
            }
        } else {
            switch (firstToken) {
                case _jsoncParser2.default.SyntaxKind.OpenBracketToken:
                case _jsoncParser2.default.SyntaxKind.OpenBraceToken:
                    indentLevel++;
                    replaceContent = newLineAndIndent();
                    break;
                case _jsoncParser2.default.SyntaxKind.CommaToken:
                case _jsoncParser2.default.SyntaxKind.LineCommentTrivia:
                    replaceContent = newLineAndIndent();
                    break;
                case _jsoncParser2.default.SyntaxKind.BlockCommentTrivia:
                    if (lineBreak) {
                        replaceContent = newLineAndIndent();
                    } else {
                        replaceContent = ' ';
                    }
                    break;
                case _jsoncParser2.default.SyntaxKind.ColonToken:
                    replaceContent = ' ';
                    break;
                case _jsoncParser2.default.SyntaxKind.NullKeyword:
                case _jsoncParser2.default.SyntaxKind.TrueKeyword:
                case _jsoncParser2.default.SyntaxKind.FalseKeyword:
                case _jsoncParser2.default.SyntaxKind.NumericLiteral:
                    if (secondToken === _jsoncParser2.default.SyntaxKind.NullKeyword || secondToken === _jsoncParser2.default.SyntaxKind.FalseKeyword || secondToken === _jsoncParser2.default.SyntaxKind.NumericLiteral) {
                        replaceContent = ' ';
                    }
                    break;
            }
            if (lineBreak && (secondToken === _jsoncParser2.default.SyntaxKind.LineCommentTrivia || secondToken === _jsoncParser2.default.SyntaxKind.BlockCommentTrivia)) {
                replaceContent = newLineAndIndent();
            }
        }
        var secondTokenStart = scanner.getTokenOffset() + rangeOffset;
        addEdit(replaceContent, firstTokenEnd, secondTokenStart);
        firstToken = secondToken;
    }
    return editOperations;
}
function repeat(s, count) {
    var result = '';
    for (var i = 0; i < count; i++) {
        result += s;
    }
    return result;
}
function computeIndentLevel(content, offset, options) {
    var i = 0;
    var nChars = 0;
    var tabSize = options.tabSize || 4;
    while (i < content.length) {
        var ch = content.charAt(i);
        if (ch === ' ') {
            nChars++;
        } else if (ch === '\t') {
            nChars += tabSize;
        } else {
            break;
        }
        i++;
    }
    return Math.floor(nChars / tabSize);
}
function getEOL(document) {
    var text = document.getText();
    if (document.getLineCount() > 1) {
        var to = document.getBuffer().characterIndexForPosition(new _atom.Point(1, 0));
        var from = to;
        while (from > 0 && isEOL(text, from - 1)) {
            from--;
        }
        return text.substr(from, to - from);
    }
    return '\n';
}
function isEOL(text, offset) {
    return '\r\n'.indexOf(text.charAt(offset)) !== -1;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZzY29kZS9wbHVnaW4vanNvbkZvcm1hdHRlci50cyIsInZzY29kZS9wbHVnaW4vanNvbkZvcm1hdHRlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFJQTs7Ozs7UUFPQSxNLEdBQUEsTTs7QUNWQTs7OztBQUNBOztBQUNBOzs7Ozs7QURNQSxJQUFNLFFBQVEscUJBQVcsS0FBekI7QUFFQSxTQUFBLE1BQUEsQ0FBdUIsUUFBdkIsRUFBa0QsS0FBbEQsRUFBMkUsT0FBM0UsRUFBK0g7QUFDM0gsUUFBTSxlQUFlLFNBQVMsT0FBVCxFQUFyQjtBQUNBLFFBQUksMkJBQUo7QUFDQSxRQUFJLGNBQUo7QUFDQSxRQUFJLG9CQUFKO0FBQ0EsUUFBSSxLQUFKLEVBQVc7QUFDUCxZQUFJLGdCQUFnQixnQkFBVSxNQUFNLEtBQU4sQ0FBWSxHQUF0QixFQUEyQixDQUEzQixDQUFwQjtBQUNBLHNCQUFjLFNBQVMsU0FBVCxHQUFxQix5QkFBckIsQ0FBK0MsYUFBL0MsQ0FBZDtBQUVBLFlBQUksWUFBWSxTQUFTLFNBQVQsR0FBcUIseUJBQXJCLENBQStDLGdCQUFVLE1BQU0sR0FBTixDQUFVLEdBQVYsR0FBZ0IsQ0FBMUIsRUFBNkIsQ0FBN0IsQ0FBL0MsQ0FBaEI7QUFDQSxZQUFJLGVBQWUsU0FBUyxTQUFULEdBQXFCLHlCQUFyQixDQUErQyxnQkFBVSxNQUFNLEdBQU4sQ0FBVSxHQUFwQixFQUF5QixDQUF6QixDQUEvQyxDQUFuQjtBQUNBLGVBQU8sWUFBWSxZQUFaLElBQTRCLE1BQU0sWUFBTixFQUFvQixZQUFZLENBQWhDLENBQW5DLEVBQXVFO0FBQ25FO0FBQ0g7QUFDRCxnQkFBUSxJQUFJLEtBQUosQ0FBVSxhQUFWLEVBQXlCLFNBQVMsU0FBVCxHQUFxQix5QkFBckIsQ0FBK0MsU0FBL0MsQ0FBekIsQ0FBUjtBQUNBLGdCQUFRLGFBQWEsU0FBYixDQUF1QixXQUF2QixFQUFvQyxTQUFwQyxDQUFSO0FBQ0EsNkJBQXFCLG1CQUFtQixLQUFuQixFQUEwQixD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LEtBQUssU0FBUyxTQUFULEdBQXFCLHlCQUFyQixDQUErQyxnQkFBVSxDQUFWLEVBQWEsQ0FBYixDQUEvQyxDQUFUO0FBQ0EsWUFBSSxPQUFPLEVBQVg7QUFDQSxlQUFPLE9BQU8sQ0FBUCxJQUFZLE1BQU0sSUFBTixFQUFZLE9BQU8sQ0FBbkIsQ0FBbkIsRUFBMEM7QUFDdEM7QUFDSDtBQUNELGVBQU8sS0FBSyxNQUFMLENBQVksSUFBWixFQUFrQixLQUFLLElBQXZCLENBQVA7QUFDSDtBQUNELFdBQU8sSUFBUDtBQUNIO0FBRUQsU0FBQSxLQUFBLENBQWUsSUFBZixFQUE2QixNQUE3QixFQUEyQztBQUN2QyxXQUFPLE9BQU8sT0FBUCxDQUFlLEtBQUssTUFBTCxDQUFZLE1BQVosQ0FBZixNQUF3QyxDQUFDLENBQWhEO0FBQ0giLCJmaWxlIjoidnNjb2RlL3BsdWdpbi9qc29uRm9ybWF0dGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICogIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4gKiAgTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLiBTZWUgTGljZW5zZS50eHQgaW4gdGhlIHByb2plY3Qgcm9vdCBmb3IgbGljZW5zZSBpbmZvcm1hdGlvbi5cclxuICotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbmltcG9ydCBKc29uIGZyb20gJ2pzb25jLXBhcnNlcic7XHJcbmltcG9ydCB7UG9pbnR9IGZyb20gXCJhdG9tXCI7XHJcbmltcG9ydCBUZXh0QnVmZmVyIGZyb20gXCJ0ZXh0LWJ1ZmZlclwiO1xyXG5jb25zdCBSYW5nZSA9IFRleHRCdWZmZXIuUmFuZ2U7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0KGRvY3VtZW50OiBBdG9tLlRleHRFZGl0b3IsIHJhbmdlOiBUZXh0QnVmZmVyLlJhbmdlLCBvcHRpb25zOiB7IHRhYlNpemU6IG51bWJlcjsgaW5zZXJ0U3BhY2VzOiBib29sZWFuOyB9KTogeyByYW5nZTogVGV4dEJ1ZmZlci5SYW5nZSwgdGV4dDogc3RyaW5nIH1bXSB7XHJcbiAgICBjb25zdCBkb2N1bWVudFRleHQgPSBkb2N1bWVudC5nZXRUZXh0KCk7XHJcbiAgICBsZXQgaW5pdGlhbEluZGVudExldmVsOiBudW1iZXI7XHJcbiAgICBsZXQgdmFsdWU6IHN0cmluZztcclxuICAgIGxldCByYW5nZU9mZnNldDogbnVtYmVyO1xyXG4gICAgaWYgKHJhbmdlKSB7XHJcbiAgICAgICAgbGV0IHN0YXJ0UG9zaXRpb24gPSBuZXcgUG9pbnQocmFuZ2Uuc3RhcnQucm93LCAwKTtcclxuICAgICAgICByYW5nZU9mZnNldCA9IGRvY3VtZW50LmdldEJ1ZmZlcigpLmNoYXJhY3RlckluZGV4Rm9yUG9zaXRpb24oc3RhcnRQb3NpdGlvbik7XHJcblxyXG4gICAgICAgIGxldCBlbmRPZmZzZXQgPSBkb2N1bWVudC5nZXRCdWZmZXIoKS5jaGFyYWN0ZXJJbmRleEZvclBvc2l0aW9uKG5ldyBQb2ludChyYW5nZS5lbmQucm93ICsgMSwgMCkpO1xyXG4gICAgICAgIGxldCBlbmRMaW5lU3RhcnQgPSBkb2N1bWVudC5nZXRCdWZmZXIoKS5jaGFyYWN0ZXJJbmRleEZvclBvc2l0aW9uKG5ldyBQb2ludChyYW5nZS5lbmQucm93LCAwKSk7XHJcbiAgICAgICAgd2hpbGUgKGVuZE9mZnNldCA+IGVuZExpbmVTdGFydCAmJiBpc0VPTChkb2N1bWVudFRleHQsIGVuZE9mZnNldCAtIDEpKSB7XHJcbiAgICAgICAgICAgIGVuZE9mZnNldC0tO1xyXG4gICAgICAgIH1cclxuICAgICAgICByYW5nZSA9IG5ldyBSYW5nZShzdGFydFBvc2l0aW9uLCBkb2N1bWVudC5nZXRCdWZmZXIoKS5wb3NpdGlvbkZvckNoYXJhY3RlckluZGV4KGVuZE9mZnNldCkpO1xyXG4gICAgICAgIHZhbHVlID0gZG9jdW1lbnRUZXh0LnN1YnN0cmluZyhyYW5nZU9mZnNldCwgZW5kT2Zmc2V0KTtcclxuICAgICAgICBpbml0aWFsSW5kZW50TGV2ZWwgPSBjb21wdXRlSW5kZW50TGV2ZWwodmFsdWUsIDAsIG9wdGlvbnMpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICB2YWx1ZSA9IGRvY3VtZW50VGV4dDtcclxuICAgICAgICByYW5nZSA9IG5ldyBSYW5nZShuZXcgUG9pbnQoMCwgMCksIGRvY3VtZW50LmdldEJ1ZmZlcigpLmdldEVuZFBvc2l0aW9uKCkpO1xyXG4gICAgICAgIGluaXRpYWxJbmRlbnRMZXZlbCA9IDA7XHJcbiAgICAgICAgcmFuZ2VPZmZzZXQgPSAwO1xyXG4gICAgfVxyXG4gICAgbGV0IGVvbCA9IGdldEVPTChkb2N1bWVudCk7XHJcblxyXG4gICAgbGV0IGxpbmVCcmVhayA9IGZhbHNlO1xyXG4gICAgbGV0IGluZGVudExldmVsID0gMDtcclxuICAgIGxldCBpbmRlbnRWYWx1ZTogc3RyaW5nO1xyXG4gICAgaWYgKG9wdGlvbnMuaW5zZXJ0U3BhY2VzKSB7XHJcbiAgICAgICAgaW5kZW50VmFsdWUgPSByZXBlYXQoJyAnLCBvcHRpb25zLnRhYlNpemUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBpbmRlbnRWYWx1ZSA9ICdcXHQnO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBzY2FubmVyID0gSnNvbi5jcmVhdGVTY2FubmVyKHZhbHVlLCBmYWxzZSk7XHJcblxyXG4gICAgZnVuY3Rpb24gbmV3TGluZUFuZEluZGVudCgpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiBlb2wgKyByZXBlYXQoaW5kZW50VmFsdWUsIGluaXRpYWxJbmRlbnRMZXZlbCArIGluZGVudExldmVsKTtcclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIHNjYW5OZXh0KCk6IEpzb24uU3ludGF4S2luZCB7XHJcbiAgICAgICAgbGV0IHRva2VuID0gc2Nhbm5lci5zY2FuKCk7XHJcbiAgICAgICAgbGluZUJyZWFrID0gZmFsc2U7XHJcbiAgICAgICAgd2hpbGUgKHRva2VuID09PSBKc29uLlN5bnRheEtpbmQuVHJpdmlhIHx8IHRva2VuID09PSBKc29uLlN5bnRheEtpbmQuTGluZUJyZWFrVHJpdmlhKSB7XHJcbiAgICAgICAgICAgIGxpbmVCcmVhayA9IGxpbmVCcmVhayB8fCAodG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5MaW5lQnJlYWtUcml2aWEpO1xyXG4gICAgICAgICAgICB0b2tlbiA9IHNjYW5uZXIuc2NhbigpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdG9rZW47XHJcbiAgICB9XHJcbiAgICBsZXQgZWRpdE9wZXJhdGlvbnM6IHsgcmFuZ2U6IFRleHRCdWZmZXIuUmFuZ2UsIHRleHQ6IHN0cmluZyB9W10gPSBbXTtcclxuICAgIGZ1bmN0aW9uIGFkZEVkaXQodGV4dDogc3RyaW5nLCBzdGFydE9mZnNldDogbnVtYmVyLCBlbmRPZmZzZXQ6IG51bWJlcikge1xyXG4gICAgICAgIGlmIChkb2N1bWVudFRleHQuc3Vic3RyaW5nKHN0YXJ0T2Zmc2V0LCBlbmRPZmZzZXQpICE9PSB0ZXh0KSB7XHJcbiAgICAgICAgICAgIGxldCByZXBsYWNlUmFuZ2UgPSBuZXcgUmFuZ2UoZG9jdW1lbnQuZ2V0QnVmZmVyKCkucG9zaXRpb25Gb3JDaGFyYWN0ZXJJbmRleChzdGFydE9mZnNldCksIGRvY3VtZW50LmdldEJ1ZmZlcigpLnBvc2l0aW9uRm9yQ2hhcmFjdGVySW5kZXgoZW5kT2Zmc2V0KSk7XHJcbiAgICAgICAgICAgIGVkaXRPcGVyYXRpb25zLnB1c2goeyByYW5nZTogcmVwbGFjZVJhbmdlLCB0ZXh0IH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBsZXQgZmlyc3RUb2tlbiA9IHNjYW5OZXh0KCk7XHJcbiAgICBpZiAoZmlyc3RUb2tlbiAhPT0gSnNvbi5TeW50YXhLaW5kLkVPRikge1xyXG4gICAgICAgIGxldCBmaXJzdFRva2VuU3RhcnQgPSBzY2FubmVyLmdldFRva2VuT2Zmc2V0KCkgKyByYW5nZU9mZnNldDtcclxuICAgICAgICBsZXQgaW5pdGlhbEluZGVudCA9IHJlcGVhdChpbmRlbnRWYWx1ZSwgaW5pdGlhbEluZGVudExldmVsKTtcclxuICAgICAgICBhZGRFZGl0KGluaXRpYWxJbmRlbnQsIHJhbmdlT2Zmc2V0LCBmaXJzdFRva2VuU3RhcnQpO1xyXG4gICAgfVxyXG5cclxuICAgIHdoaWxlIChmaXJzdFRva2VuICE9PSBKc29uLlN5bnRheEtpbmQuRU9GKSB7XHJcbiAgICAgICAgbGV0IGZpcnN0VG9rZW5FbmQgPSBzY2FubmVyLmdldFRva2VuT2Zmc2V0KCkgKyBzY2FubmVyLmdldFRva2VuTGVuZ3RoKCkgKyByYW5nZU9mZnNldDtcclxuICAgICAgICBsZXQgc2Vjb25kVG9rZW4gPSBzY2FuTmV4dCgpO1xyXG5cclxuICAgICAgICBsZXQgcmVwbGFjZUNvbnRlbnQgPSAnJztcclxuICAgICAgICB3aGlsZSAoIWxpbmVCcmVhayAmJiAoc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5MaW5lQ29tbWVudFRyaXZpYSB8fCBzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkJsb2NrQ29tbWVudFRyaXZpYSkpIHtcclxuICAgICAgICAgICAgLy8gY29tbWVudHMgb24gdGhlIHNhbWUgbGluZToga2VlcCB0aGVtIG9uIHRoZSBzYW1lIGxpbmUsIGJ1dCBpZ25vcmUgdGhlbSBvdGhlcndpc2VcclxuICAgICAgICAgICAgbGV0IGNvbW1lbnRUb2tlblN0YXJ0ID0gc2Nhbm5lci5nZXRUb2tlbk9mZnNldCgpICsgcmFuZ2VPZmZzZXQ7XHJcbiAgICAgICAgICAgIGFkZEVkaXQoJyAnLCBmaXJzdFRva2VuRW5kLCBjb21tZW50VG9rZW5TdGFydCk7XHJcbiAgICAgICAgICAgIGZpcnN0VG9rZW5FbmQgPSBzY2FubmVyLmdldFRva2VuT2Zmc2V0KCkgKyBzY2FubmVyLmdldFRva2VuTGVuZ3RoKCkgKyByYW5nZU9mZnNldDtcclxuICAgICAgICAgICAgcmVwbGFjZUNvbnRlbnQgPSBzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkxpbmVDb21tZW50VHJpdmlhID8gbmV3TGluZUFuZEluZGVudCgpIDogJyc7XHJcbiAgICAgICAgICAgIHNlY29uZFRva2VuID0gc2Nhbk5leHQoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkNsb3NlQnJhY2VUb2tlbikge1xyXG4gICAgICAgICAgICBpZiAoZmlyc3RUb2tlbiAhPT0gSnNvbi5TeW50YXhLaW5kLk9wZW5CcmFjZVRva2VuKSB7XHJcbiAgICAgICAgICAgICAgICBpbmRlbnRMZXZlbC0tO1xyXG4gICAgICAgICAgICAgICAgcmVwbGFjZUNvbnRlbnQgPSBuZXdMaW5lQW5kSW5kZW50KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2UgaWYgKHNlY29uZFRva2VuID09PSBKc29uLlN5bnRheEtpbmQuQ2xvc2VCcmFja2V0VG9rZW4pIHtcclxuICAgICAgICAgICAgaWYgKGZpcnN0VG9rZW4gIT09IEpzb24uU3ludGF4S2luZC5PcGVuQnJhY2tldFRva2VuKSB7XHJcbiAgICAgICAgICAgICAgICBpbmRlbnRMZXZlbC0tO1xyXG4gICAgICAgICAgICAgICAgcmVwbGFjZUNvbnRlbnQgPSBuZXdMaW5lQW5kSW5kZW50KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzd2l0Y2ggKGZpcnN0VG9rZW4pIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgSnNvbi5TeW50YXhLaW5kLk9wZW5CcmFja2V0VG9rZW46XHJcbiAgICAgICAgICAgICAgICBjYXNlIEpzb24uU3ludGF4S2luZC5PcGVuQnJhY2VUb2tlbjpcclxuICAgICAgICAgICAgICAgICAgICBpbmRlbnRMZXZlbCsrO1xyXG4gICAgICAgICAgICAgICAgICAgIHJlcGxhY2VDb250ZW50ID0gbmV3TGluZUFuZEluZGVudCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBKc29uLlN5bnRheEtpbmQuQ29tbWFUb2tlbjpcclxuICAgICAgICAgICAgICAgIGNhc2UgSnNvbi5TeW50YXhLaW5kLkxpbmVDb21tZW50VHJpdmlhOlxyXG4gICAgICAgICAgICAgICAgICAgIHJlcGxhY2VDb250ZW50ID0gbmV3TGluZUFuZEluZGVudCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBKc29uLlN5bnRheEtpbmQuQmxvY2tDb21tZW50VHJpdmlhOlxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChsaW5lQnJlYWspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZUNvbnRlbnQgPSBuZXdMaW5lQW5kSW5kZW50KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3ltYm9sIGZvbGxvd2luZyBjb21tZW50IG9uIHRoZSBzYW1lIGxpbmU6IGtlZXAgb24gc2FtZSBsaW5lLCBzZXBhcmF0ZSB3aXRoICcgJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlQ29udGVudCA9ICcgJztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIEpzb24uU3ludGF4S2luZC5Db2xvblRva2VuOlxyXG4gICAgICAgICAgICAgICAgICAgIHJlcGxhY2VDb250ZW50ID0gJyAnO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBKc29uLlN5bnRheEtpbmQuTnVsbEtleXdvcmQ6XHJcbiAgICAgICAgICAgICAgICBjYXNlIEpzb24uU3ludGF4S2luZC5UcnVlS2V5d29yZDpcclxuICAgICAgICAgICAgICAgIGNhc2UgSnNvbi5TeW50YXhLaW5kLkZhbHNlS2V5d29yZDpcclxuICAgICAgICAgICAgICAgIGNhc2UgSnNvbi5TeW50YXhLaW5kLk51bWVyaWNMaXRlcmFsOlxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLk51bGxLZXl3b3JkIHx8IHNlY29uZFRva2VuID09PSBKc29uLlN5bnRheEtpbmQuRmFsc2VLZXl3b3JkIHx8IHNlY29uZFRva2VuID09PSBKc29uLlN5bnRheEtpbmQuTnVtZXJpY0xpdGVyYWwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZUNvbnRlbnQgPSAnICc7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChsaW5lQnJlYWsgJiYgKHNlY29uZFRva2VuID09PSBKc29uLlN5bnRheEtpbmQuTGluZUNvbW1lbnRUcml2aWEgfHwgc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5CbG9ja0NvbW1lbnRUcml2aWEpKSB7XHJcbiAgICAgICAgICAgICAgICByZXBsYWNlQ29udGVudCA9IG5ld0xpbmVBbmRJbmRlbnQoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHNlY29uZFRva2VuU3RhcnQgPSBzY2FubmVyLmdldFRva2VuT2Zmc2V0KCkgKyByYW5nZU9mZnNldDtcclxuICAgICAgICBhZGRFZGl0KHJlcGxhY2VDb250ZW50LCBmaXJzdFRva2VuRW5kLCBzZWNvbmRUb2tlblN0YXJ0KTtcclxuICAgICAgICBmaXJzdFRva2VuID0gc2Vjb25kVG9rZW47XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZWRpdE9wZXJhdGlvbnM7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJlcGVhdChzOiBzdHJpbmcsIGNvdW50OiBudW1iZXIpOiBzdHJpbmcge1xyXG4gICAgbGV0IHJlc3VsdCA9ICcnO1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7XHJcbiAgICAgICAgcmVzdWx0ICs9IHM7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG59XHJcblxyXG5mdW5jdGlvbiBjb21wdXRlSW5kZW50TGV2ZWwoY29udGVudDogc3RyaW5nLCBvZmZzZXQ6IG51bWJlciwgb3B0aW9uczogeyB0YWJTaXplOiBudW1iZXI7IGluc2VydFNwYWNlczogYm9vbGVhbjsgfSk6IG51bWJlciB7XHJcbiAgICBsZXQgaSA9IDA7XHJcbiAgICBsZXQgbkNoYXJzID0gMDtcclxuICAgIGxldCB0YWJTaXplID0gb3B0aW9ucy50YWJTaXplIHx8IDQ7XHJcbiAgICB3aGlsZSAoaSA8IGNvbnRlbnQubGVuZ3RoKSB7XHJcbiAgICAgICAgbGV0IGNoID0gY29udGVudC5jaGFyQXQoaSk7XHJcbiAgICAgICAgaWYgKGNoID09PSAnICcpIHtcclxuICAgICAgICAgICAgbkNoYXJzKys7XHJcbiAgICAgICAgfSBlbHNlIGlmIChjaCA9PT0gJ1xcdCcpIHtcclxuICAgICAgICAgICAgbkNoYXJzICs9IHRhYlNpemU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGkrKztcclxuICAgIH1cclxuICAgIHJldHVybiBNYXRoLmZsb29yKG5DaGFycyAvIHRhYlNpemUpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRFT0woZG9jdW1lbnQ6IEF0b20uVGV4dEVkaXRvcik6IHN0cmluZyB7XHJcbiAgICBsZXQgdGV4dCA9IGRvY3VtZW50LmdldFRleHQoKTtcclxuICAgIGlmIChkb2N1bWVudC5nZXRMaW5lQ291bnQoKSA+IDEpIHtcclxuICAgICAgICBsZXQgdG8gPSBkb2N1bWVudC5nZXRCdWZmZXIoKS5jaGFyYWN0ZXJJbmRleEZvclBvc2l0aW9uKG5ldyBQb2ludCgxLCAwKSk7XHJcbiAgICAgICAgbGV0IGZyb20gPSB0bztcclxuICAgICAgICB3aGlsZSAoZnJvbSA+IDAgJiYgaXNFT0wodGV4dCwgZnJvbSAtIDEpKSB7XHJcbiAgICAgICAgICAgIGZyb20tLTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRleHQuc3Vic3RyKGZyb20sIHRvIC0gZnJvbSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gJ1xcbic7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzRU9MKHRleHQ6IHN0cmluZywgb2Zmc2V0OiBudW1iZXIpIHtcclxuICAgIHJldHVybiAnXFxyXFxuJy5pbmRleE9mKHRleHQuY2hhckF0KG9mZnNldCkpICE9PSAtMTtcclxufVxyXG4iLCIndXNlIHN0cmljdCc7XG5pbXBvcnQgSnNvbiBmcm9tICdqc29uYy1wYXJzZXInO1xuaW1wb3J0IHsgUG9pbnQgfSBmcm9tIFwiYXRvbVwiO1xuaW1wb3J0IFRleHRCdWZmZXIgZnJvbSBcInRleHQtYnVmZmVyXCI7XG5jb25zdCBSYW5nZSA9IFRleHRCdWZmZXIuUmFuZ2U7XG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0KGRvY3VtZW50LCByYW5nZSwgb3B0aW9ucykge1xuICAgIGNvbnN0IGRvY3VtZW50VGV4dCA9IGRvY3VtZW50LmdldFRleHQoKTtcbiAgICBsZXQgaW5pdGlhbEluZGVudExldmVsO1xuICAgIGxldCB2YWx1ZTtcbiAgICBsZXQgcmFuZ2VPZmZzZXQ7XG4gICAgaWYgKHJhbmdlKSB7XG4gICAgICAgIGxldCBzdGFydFBvc2l0aW9uID0gbmV3IFBvaW50KHJhbmdlLnN0YXJ0LnJvdywgMCk7XG4gICAgICAgIHJhbmdlT2Zmc2V0ID0gZG9jdW1lbnQuZ2V0QnVmZmVyKCkuY2hhcmFjdGVySW5kZXhGb3JQb3NpdGlvbihzdGFydFBvc2l0aW9uKTtcbiAgICAgICAgbGV0IGVuZE9mZnNldCA9IGRvY3VtZW50LmdldEJ1ZmZlcigpLmNoYXJhY3RlckluZGV4Rm9yUG9zaXRpb24obmV3IFBvaW50KHJhbmdlLmVuZC5yb3cgKyAxLCAwKSk7XG4gICAgICAgIGxldCBlbmRMaW5lU3RhcnQgPSBkb2N1bWVudC5nZXRCdWZmZXIoKS5jaGFyYWN0ZXJJbmRleEZvclBvc2l0aW9uKG5ldyBQb2ludChyYW5nZS5lbmQucm93LCAwKSk7XG4gICAgICAgIHdoaWxlIChlbmRPZmZzZXQgPiBlbmRMaW5lU3RhcnQgJiYgaXNFT0woZG9jdW1lbnRUZXh0LCBlbmRPZmZzZXQgLSAxKSkge1xuICAgICAgICAgICAgZW5kT2Zmc2V0LS07XG4gICAgICAgIH1cbiAgICAgICAgcmFuZ2UgPSBuZXcgUmFuZ2Uoc3RhcnRQb3NpdGlvbiwgZG9jdW1lbnQuZ2V0QnVmZmVyKCkucG9zaXRpb25Gb3JDaGFyYWN0ZXJJbmRleChlbmRPZmZzZXQpKTtcbiAgICAgICAgdmFsdWUgPSBkb2N1bWVudFRleHQuc3Vic3RyaW5nKHJhbmdlT2Zmc2V0LCBlbmRPZmZzZXQpO1xuICAgICAgICBpbml0aWFsSW5kZW50TGV2ZWwgPSBjb21wdXRlSW5kZW50TGV2ZWwodmFsdWUsIDAsIG9wdGlvbnMpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgdmFsdWUgPSBkb2N1bWVudFRleHQ7XG4gICAgICAgIHJhbmdlID0gbmV3IFJhbmdlKG5ldyBQb2ludCgwLCAwKSwgZG9jdW1lbnQuZ2V0QnVmZmVyKCkuZ2V0RW5kUG9zaXRpb24oKSk7XG4gICAgICAgIGluaXRpYWxJbmRlbnRMZXZlbCA9IDA7XG4gICAgICAgIHJhbmdlT2Zmc2V0ID0gMDtcbiAgICB9XG4gICAgbGV0IGVvbCA9IGdldEVPTChkb2N1bWVudCk7XG4gICAgbGV0IGxpbmVCcmVhayA9IGZhbHNlO1xuICAgIGxldCBpbmRlbnRMZXZlbCA9IDA7XG4gICAgbGV0IGluZGVudFZhbHVlO1xuICAgIGlmIChvcHRpb25zLmluc2VydFNwYWNlcykge1xuICAgICAgICBpbmRlbnRWYWx1ZSA9IHJlcGVhdCgnICcsIG9wdGlvbnMudGFiU2l6ZSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBpbmRlbnRWYWx1ZSA9ICdcXHQnO1xuICAgIH1cbiAgICBsZXQgc2Nhbm5lciA9IEpzb24uY3JlYXRlU2Nhbm5lcih2YWx1ZSwgZmFsc2UpO1xuICAgIGZ1bmN0aW9uIG5ld0xpbmVBbmRJbmRlbnQoKSB7XG4gICAgICAgIHJldHVybiBlb2wgKyByZXBlYXQoaW5kZW50VmFsdWUsIGluaXRpYWxJbmRlbnRMZXZlbCArIGluZGVudExldmVsKTtcbiAgICB9XG4gICAgZnVuY3Rpb24gc2Nhbk5leHQoKSB7XG4gICAgICAgIGxldCB0b2tlbiA9IHNjYW5uZXIuc2NhbigpO1xuICAgICAgICBsaW5lQnJlYWsgPSBmYWxzZTtcbiAgICAgICAgd2hpbGUgKHRva2VuID09PSBKc29uLlN5bnRheEtpbmQuVHJpdmlhIHx8IHRva2VuID09PSBKc29uLlN5bnRheEtpbmQuTGluZUJyZWFrVHJpdmlhKSB7XG4gICAgICAgICAgICBsaW5lQnJlYWsgPSBsaW5lQnJlYWsgfHwgKHRva2VuID09PSBKc29uLlN5bnRheEtpbmQuTGluZUJyZWFrVHJpdmlhKTtcbiAgICAgICAgICAgIHRva2VuID0gc2Nhbm5lci5zY2FuKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRva2VuO1xuICAgIH1cbiAgICBsZXQgZWRpdE9wZXJhdGlvbnMgPSBbXTtcbiAgICBmdW5jdGlvbiBhZGRFZGl0KHRleHQsIHN0YXJ0T2Zmc2V0LCBlbmRPZmZzZXQpIHtcbiAgICAgICAgaWYgKGRvY3VtZW50VGV4dC5zdWJzdHJpbmcoc3RhcnRPZmZzZXQsIGVuZE9mZnNldCkgIT09IHRleHQpIHtcbiAgICAgICAgICAgIGxldCByZXBsYWNlUmFuZ2UgPSBuZXcgUmFuZ2UoZG9jdW1lbnQuZ2V0QnVmZmVyKCkucG9zaXRpb25Gb3JDaGFyYWN0ZXJJbmRleChzdGFydE9mZnNldCksIGRvY3VtZW50LmdldEJ1ZmZlcigpLnBvc2l0aW9uRm9yQ2hhcmFjdGVySW5kZXgoZW5kT2Zmc2V0KSk7XG4gICAgICAgICAgICBlZGl0T3BlcmF0aW9ucy5wdXNoKHsgcmFuZ2U6IHJlcGxhY2VSYW5nZSwgdGV4dCB9KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBsZXQgZmlyc3RUb2tlbiA9IHNjYW5OZXh0KCk7XG4gICAgaWYgKGZpcnN0VG9rZW4gIT09IEpzb24uU3ludGF4S2luZC5FT0YpIHtcbiAgICAgICAgbGV0IGZpcnN0VG9rZW5TdGFydCA9IHNjYW5uZXIuZ2V0VG9rZW5PZmZzZXQoKSArIHJhbmdlT2Zmc2V0O1xuICAgICAgICBsZXQgaW5pdGlhbEluZGVudCA9IHJlcGVhdChpbmRlbnRWYWx1ZSwgaW5pdGlhbEluZGVudExldmVsKTtcbiAgICAgICAgYWRkRWRpdChpbml0aWFsSW5kZW50LCByYW5nZU9mZnNldCwgZmlyc3RUb2tlblN0YXJ0KTtcbiAgICB9XG4gICAgd2hpbGUgKGZpcnN0VG9rZW4gIT09IEpzb24uU3ludGF4S2luZC5FT0YpIHtcbiAgICAgICAgbGV0IGZpcnN0VG9rZW5FbmQgPSBzY2FubmVyLmdldFRva2VuT2Zmc2V0KCkgKyBzY2FubmVyLmdldFRva2VuTGVuZ3RoKCkgKyByYW5nZU9mZnNldDtcbiAgICAgICAgbGV0IHNlY29uZFRva2VuID0gc2Nhbk5leHQoKTtcbiAgICAgICAgbGV0IHJlcGxhY2VDb250ZW50ID0gJyc7XG4gICAgICAgIHdoaWxlICghbGluZUJyZWFrICYmIChzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkxpbmVDb21tZW50VHJpdmlhIHx8IHNlY29uZFRva2VuID09PSBKc29uLlN5bnRheEtpbmQuQmxvY2tDb21tZW50VHJpdmlhKSkge1xuICAgICAgICAgICAgbGV0IGNvbW1lbnRUb2tlblN0YXJ0ID0gc2Nhbm5lci5nZXRUb2tlbk9mZnNldCgpICsgcmFuZ2VPZmZzZXQ7XG4gICAgICAgICAgICBhZGRFZGl0KCcgJywgZmlyc3RUb2tlbkVuZCwgY29tbWVudFRva2VuU3RhcnQpO1xuICAgICAgICAgICAgZmlyc3RUb2tlbkVuZCA9IHNjYW5uZXIuZ2V0VG9rZW5PZmZzZXQoKSArIHNjYW5uZXIuZ2V0VG9rZW5MZW5ndGgoKSArIHJhbmdlT2Zmc2V0O1xuICAgICAgICAgICAgcmVwbGFjZUNvbnRlbnQgPSBzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkxpbmVDb21tZW50VHJpdmlhID8gbmV3TGluZUFuZEluZGVudCgpIDogJyc7XG4gICAgICAgICAgICBzZWNvbmRUb2tlbiA9IHNjYW5OZXh0KCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNlY29uZFRva2VuID09PSBKc29uLlN5bnRheEtpbmQuQ2xvc2VCcmFjZVRva2VuKSB7XG4gICAgICAgICAgICBpZiAoZmlyc3RUb2tlbiAhPT0gSnNvbi5TeW50YXhLaW5kLk9wZW5CcmFjZVRva2VuKSB7XG4gICAgICAgICAgICAgICAgaW5kZW50TGV2ZWwtLTtcbiAgICAgICAgICAgICAgICByZXBsYWNlQ29udGVudCA9IG5ld0xpbmVBbmRJbmRlbnQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkNsb3NlQnJhY2tldFRva2VuKSB7XG4gICAgICAgICAgICBpZiAoZmlyc3RUb2tlbiAhPT0gSnNvbi5TeW50YXhLaW5kLk9wZW5CcmFja2V0VG9rZW4pIHtcbiAgICAgICAgICAgICAgICBpbmRlbnRMZXZlbC0tO1xuICAgICAgICAgICAgICAgIHJlcGxhY2VDb250ZW50ID0gbmV3TGluZUFuZEluZGVudCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgc3dpdGNoIChmaXJzdFRva2VuKSB7XG4gICAgICAgICAgICAgICAgY2FzZSBKc29uLlN5bnRheEtpbmQuT3BlbkJyYWNrZXRUb2tlbjpcbiAgICAgICAgICAgICAgICBjYXNlIEpzb24uU3ludGF4S2luZC5PcGVuQnJhY2VUb2tlbjpcbiAgICAgICAgICAgICAgICAgICAgaW5kZW50TGV2ZWwrKztcbiAgICAgICAgICAgICAgICAgICAgcmVwbGFjZUNvbnRlbnQgPSBuZXdMaW5lQW5kSW5kZW50KCk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgSnNvbi5TeW50YXhLaW5kLkNvbW1hVG9rZW46XG4gICAgICAgICAgICAgICAgY2FzZSBKc29uLlN5bnRheEtpbmQuTGluZUNvbW1lbnRUcml2aWE6XG4gICAgICAgICAgICAgICAgICAgIHJlcGxhY2VDb250ZW50ID0gbmV3TGluZUFuZEluZGVudCgpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlIEpzb24uU3ludGF4S2luZC5CbG9ja0NvbW1lbnRUcml2aWE6XG4gICAgICAgICAgICAgICAgICAgIGlmIChsaW5lQnJlYWspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VDb250ZW50ID0gbmV3TGluZUFuZEluZGVudCgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZUNvbnRlbnQgPSAnICc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSBKc29uLlN5bnRheEtpbmQuQ29sb25Ub2tlbjpcbiAgICAgICAgICAgICAgICAgICAgcmVwbGFjZUNvbnRlbnQgPSAnICc7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgSnNvbi5TeW50YXhLaW5kLk51bGxLZXl3b3JkOlxuICAgICAgICAgICAgICAgIGNhc2UgSnNvbi5TeW50YXhLaW5kLlRydWVLZXl3b3JkOlxuICAgICAgICAgICAgICAgIGNhc2UgSnNvbi5TeW50YXhLaW5kLkZhbHNlS2V5d29yZDpcbiAgICAgICAgICAgICAgICBjYXNlIEpzb24uU3ludGF4S2luZC5OdW1lcmljTGl0ZXJhbDpcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNlY29uZFRva2VuID09PSBKc29uLlN5bnRheEtpbmQuTnVsbEtleXdvcmQgfHwgc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5GYWxzZUtleXdvcmQgfHwgc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5OdW1lcmljTGl0ZXJhbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZUNvbnRlbnQgPSAnICc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobGluZUJyZWFrICYmIChzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkxpbmVDb21tZW50VHJpdmlhIHx8IHNlY29uZFRva2VuID09PSBKc29uLlN5bnRheEtpbmQuQmxvY2tDb21tZW50VHJpdmlhKSkge1xuICAgICAgICAgICAgICAgIHJlcGxhY2VDb250ZW50ID0gbmV3TGluZUFuZEluZGVudCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGxldCBzZWNvbmRUb2tlblN0YXJ0ID0gc2Nhbm5lci5nZXRUb2tlbk9mZnNldCgpICsgcmFuZ2VPZmZzZXQ7XG4gICAgICAgIGFkZEVkaXQocmVwbGFjZUNvbnRlbnQsIGZpcnN0VG9rZW5FbmQsIHNlY29uZFRva2VuU3RhcnQpO1xuICAgICAgICBmaXJzdFRva2VuID0gc2Vjb25kVG9rZW47XG4gICAgfVxuICAgIHJldHVybiBlZGl0T3BlcmF0aW9ucztcbn1cbmZ1bmN0aW9uIHJlcGVhdChzLCBjb3VudCkge1xuICAgIGxldCByZXN1bHQgPSAnJztcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHtcbiAgICAgICAgcmVzdWx0ICs9IHM7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG59XG5mdW5jdGlvbiBjb21wdXRlSW5kZW50TGV2ZWwoY29udGVudCwgb2Zmc2V0LCBvcHRpb25zKSB7XG4gICAgbGV0IGkgPSAwO1xuICAgIGxldCBuQ2hhcnMgPSAwO1xuICAgIGxldCB0YWJTaXplID0gb3B0aW9ucy50YWJTaXplIHx8IDQ7XG4gICAgd2hpbGUgKGkgPCBjb250ZW50Lmxlbmd0aCkge1xuICAgICAgICBsZXQgY2ggPSBjb250ZW50LmNoYXJBdChpKTtcbiAgICAgICAgaWYgKGNoID09PSAnICcpIHtcbiAgICAgICAgICAgIG5DaGFycysrO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGNoID09PSAnXFx0Jykge1xuICAgICAgICAgICAgbkNoYXJzICs9IHRhYlNpemU7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBpKys7XG4gICAgfVxuICAgIHJldHVybiBNYXRoLmZsb29yKG5DaGFycyAvIHRhYlNpemUpO1xufVxuZnVuY3Rpb24gZ2V0RU9MKGRvY3VtZW50KSB7XG4gICAgbGV0IHRleHQgPSBkb2N1bWVudC5nZXRUZXh0KCk7XG4gICAgaWYgKGRvY3VtZW50LmdldExpbmVDb3VudCgpID4gMSkge1xuICAgICAgICBsZXQgdG8gPSBkb2N1bWVudC5nZXRCdWZmZXIoKS5jaGFyYWN0ZXJJbmRleEZvclBvc2l0aW9uKG5ldyBQb2ludCgxLCAwKSk7XG4gICAgICAgIGxldCBmcm9tID0gdG87XG4gICAgICAgIHdoaWxlIChmcm9tID4gMCAmJiBpc0VPTCh0ZXh0LCBmcm9tIC0gMSkpIHtcbiAgICAgICAgICAgIGZyb20tLTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGV4dC5zdWJzdHIoZnJvbSwgdG8gLSBmcm9tKTtcbiAgICB9XG4gICAgcmV0dXJuICdcXG4nO1xufVxuZnVuY3Rpb24gaXNFT0wodGV4dCwgb2Zmc2V0KSB7XG4gICAgcmV0dXJuICdcXHJcXG4nLmluZGV4T2YodGV4dC5jaGFyQXQob2Zmc2V0KSkgIT09IC0xO1xufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
