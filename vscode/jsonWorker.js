'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.Location = exports.JSONWorker = undefined;

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol ? "symbol" : typeof obj; };

var _severity = require("./common/severity");

var _severity2 = _interopRequireDefault(_severity);

var _jsonParser = require("./parser/jsonParser");

var _jsonParser2 = _interopRequireDefault(_jsonParser);

var _jsonFormatter = require("./common/jsonFormatter");

var _jsonFormatter2 = _interopRequireDefault(_jsonFormatter);

var _jsonSchemaService = require("./jsonSchemaService");

var _jsonSchemaService2 = _interopRequireDefault(_jsonSchemaService);

var _jsonIntellisense = require("./jsonIntellisense");

var _jsonIntellisense2 = _interopRequireDefault(_jsonIntellisense);

var _strings = require("./common/strings");

var _strings2 = _interopRequireDefault(_strings);

var _projectJSONContribution = require("./contributions/projectJSONContribution");

var _projectJSONContribution2 = _interopRequireDefault(_projectJSONContribution);

var _packageJSONContribution = require("./contributions/packageJSONContribution");

var _packageJSONContribution2 = _interopRequireDefault(_packageJSONContribution);

var _bowerJSONContribution = require("./contributions/bowerJSONContribution");

var _bowerJSONContribution2 = _interopRequireDefault(_bowerJSONContribution);

var _globPatternContribution = require("./contributions/globPatternContribution");

var _globPatternContribution2 = _interopRequireDefault(_globPatternContribution);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var __decorate = undefined && undefined.__decorate || function (decorators, target, key, desc) {
    var c = arguments.length,
        r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
        d;
    if ((typeof Reflect === "undefined" ? "undefined" : _typeof(Reflect)) === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) {
        if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    }return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __param = undefined && undefined.__param || function (paramIndex, decorator) {
    return function (target, key) {
        decorator(target, key, paramIndex);
    };
};

var JSONWorker = exports.JSONWorker = function () {
    function JSONWorker(modeId, resourceService, markerService, contextService, instantiationService) {
        var _this = this;

        _classCallCheck(this, JSONWorker);

        this._modeId = modeId;
        this.resourceService = resourceService;
        this.markerService = markerService;
        this._validationHelper = new ValidationHelper(this.resourceService, this._modeId, function (toValidate) {
            return _this.doValidate(toValidate);
        });
        this.contextService = contextService;
        this.schemaService = instantiationService.createInstance(_jsonSchemaService2.default.JSONSchemaService);
        this.contributions = [instantiationService.createInstance(_projectJSONContribution2.default.ProjectJSONContribution), instantiationService.createInstance(_packageJSONContribution2.default.PackageJSONContribution), instantiationService.createInstance(_bowerJSONContribution2.default.BowerJSONContribution), instantiationService.createInstance(_globPatternContribution2.default.GlobPatternContribution)];
        this.jsonIntellisense = new _jsonIntellisense2.default.JSONIntellisenese(this.schemaService, this.contributions);
    }

    _createClass(JSONWorker, [{
        key: "navigateValueSet",
        value: function navigateValueSet(resource, range, up) {
            var _this2 = this;

            var modelMirror = this.resourceService.get(resource);
            var offset = modelMirror.getOffsetFromPosition({ lineNumber: range.startLineNumber, column: range.startColumn });
            var parser = new _jsonParser2.default.JSONParser();
            var config = new _jsonParser2.default.JSONDocumentConfig();
            config.ignoreDanglingComma = true;
            var doc = parser.parse(modelMirror.getValue(), config);
            var node = doc.getNodeFromOffsetEndInclusive(offset);
            if (node && (node.type === 'string' || node.type === 'number' || node.type === 'boolean' || node.type === 'null')) {
                return this.schemaService.getSchemaForResource(resource.toString(), doc).then(function (schema) {
                    if (schema) {
                        var proposals = [];
                        var proposed = {};
                        var collector = {
                            add: function add(suggestion) {
                                if (!proposed[suggestion.text]) {
                                    proposed[suggestion.text] = true;
                                    proposals.push(suggestion);
                                }
                            },
                            setAsIncomplete: function setAsIncomplete() {},
                            error: function error(message) {
                                throw new Error(message);
                            }
                        };
                        _this2.jsonIntellisense.getValueSuggestions(resource, schema, doc, node.parent, node.start, collector);
                        var range = modelMirror.getRangeFromOffsetAndLength(node.start, node.end - node.start);
                        var text = modelMirror.getValueInRange(range);
                        for (var i = 0, len = proposals.length; i < len; i++) {
                            if (_strings2.default.equalsIgnoreCase(proposals[i].text, text)) {
                                var nextIdx = i;
                                if (up) {
                                    nextIdx = (i + 1) % len;
                                } else {
                                    nextIdx = i - 1;
                                    if (nextIdx < 0) {
                                        nextIdx = len - 1;
                                    }
                                }
                                return {
                                    value: proposals[nextIdx].text,
                                    range: range
                                };
                            }
                        }
                        return null;
                    }
                });
            }
            return null;
        }
    }, {
        key: "_doConfigure",
        value: function _doConfigure(options) {
            var _this3 = this;

            if (options && options.schemas) {
                this.schemaService.clearExternalSchemas();
                options.schemas.forEach(function (schema) {
                    if (schema.url && (schema.fileMatch || schema.schema)) {
                        var url = schema.url;
                        if (!_strings2.default.startsWith(url, 'http://') && !_strings2.default.startsWith(url, 'https://') && !_strings2.default.startsWith(url, 'file://')) {
                            var resourceURL = _this3.contextService.toResource(url);
                            if (resourceURL) {
                                url = resourceURL.toString();
                            }
                        }
                        if (url) {
                            _this3.schemaService.registerExternalSchema(url, schema.fileMatch, schema.schema);
                        }
                    } else if (schema.filePattern && schema.schemaPath) {
                        var url = _this3.contextService.toResource(schema.schemaPath).toString();
                        var patterns = schema.filePattern ? [schema.filePattern] : [];
                        _this3.schemaService.registerExternalSchema(url, patterns);
                    }
                });
            }
            this._validationHelper.triggerDueToConfigurationChange();
            return Promise.resolve(void 0);
        }
    }, {
        key: "setSchemaContributions",
        value: function setSchemaContributions(contributions) {
            this.schemaService.setSchemaContributions(contributions);
            return Promise.resolve(true);
        }
    }, {
        key: "enableValidator",
        value: function enableValidator() {
            this._validationHelper.enable();
            return Promise.resolve(null);
        }
    }, {
        key: "doValidate",
        value: function doValidate(resources) {
            for (var i = 0; i < resources.length; i++) {
                this.doValidate1(resources[i]);
            }
        }
    }, {
        key: "doValidate1",
        value: function doValidate1(resource) {
            var _this4 = this;

            var modelMirror = this.resourceService.get(resource);
            var parser = new _jsonParser2.default.JSONParser();
            var content = modelMirror.getValue();
            if (content.length === 0) {
                return;
            }
            var result = parser.parse(content);
            this.schemaService.getSchemaForResource(resource.toString(), result).then(function (schema) {
                if (schema) {
                    if (schema.errors.length && result.root) {
                        var property = result.root.type === 'object' ? result.root.getFirstProperty('$schema') : null;
                        if (property) {
                            var node = property.value || property;
                            result.warnings.push({ location: { start: node.start, end: node.end }, message: schema.errors[0] });
                        } else {
                            result.warnings.push({ location: { start: result.root.start, end: result.root.start + 1 }, message: schema.errors[0] });
                        }
                    } else {
                        result.validate(schema.schema);
                    }
                }
                var added = {};
                var markerData = [];
                result.errors.concat(result.warnings).forEach(function (error, idx) {
                    var signature = error.location.start + ' ' + error.location.end + ' ' + error.message;
                    if (!added[signature]) {
                        added[signature] = true;
                        var startPosition = modelMirror.getPositionFromOffset(error.location.start);
                        var endPosition = modelMirror.getPositionFromOffset(error.location.end);
                        markerData.push({
                            message: error.message,
                            severity: idx >= result.errors.length ? _severity2.default.Warning : _severity2.default.Error,
                            startLineNumber: startPosition.lineNumber,
                            startColumn: startPosition.column,
                            endLineNumber: endPosition.lineNumber,
                            endColumn: endPosition.column
                        });
                    }
                });
                _this4.markerService.changeOne(_this4._modeId, resource, markerData);
            });
        }
    }, {
        key: "provideCompletionItems",
        value: function provideCompletionItems(resource, position) {
            return this.doSuggest(resource, position).then(function (value) {
                return filterSuggestions(value);
            });
        }
    }, {
        key: "doSuggest",
        value: function doSuggest(resource, position) {
            var modelMirror = this.resourceService.get(resource);
            return this.jsonIntellisense.doSuggest(resource, modelMirror, position);
        }
    }, {
        key: "provideHover",
        value: function provideHover(resource, position) {
            var _this5 = this;

            var modelMirror = this.resourceService.get(resource);
            var parser = new _jsonParser2.default.JSONParser();
            var doc = parser.parse(modelMirror.getValue());
            var offset = modelMirror.getOffsetFromPosition(position);
            var node = doc.getNodeFromOffset(offset);
            var originalNode = node;
            if (node && node.type === 'string') {
                var stringNode = node;
                if (stringNode.isKey) {
                    var propertyNode = node.parent;
                    node = propertyNode.value;
                }
            }
            if (!node) {
                return Promise.resolve(null);
            }
            return this.schemaService.getSchemaForResource(resource.toString(), doc).then(function (schema) {
                if (schema) {
                    var matchingSchemas = [];
                    doc.validate(schema.schema, matchingSchemas, node.start);
                    var description = null;
                    var contributonId = null;
                    matchingSchemas.every(function (s) {
                        if (s.node === node && !s.inverted && s.schema) {
                            description = description || s.schema.description;
                            contributonId = contributonId || s.schema.id;
                        }
                        return true;
                    });
                    var location = node.getNodeLocation();
                    for (var i = _this5.contributions.length - 1; i >= 0; i--) {
                        var contribution = _this5.contributions[i];
                        var promise = contribution.getInfoContribution(resource, location);
                        if (promise) {
                            return promise.then(function (htmlContent) {
                                return _this5.createInfoResult(htmlContent, originalNode, modelMirror);
                            });
                        }
                    }
                    if (description) {
                        var htmlContent = [{ className: 'documentation', text: description }];
                        return _this5.createInfoResult(htmlContent, originalNode, modelMirror);
                    }
                }
                return null;
            });
        }
    }, {
        key: "createInfoResult",
        value: function createInfoResult(htmlContent, node, modelMirror) {
            var range = modelMirror.getRangeFromOffsetAndLength(node.start, node.end - node.start);
            var result = {
                htmlContent: htmlContent,
                range: range
            };
            return result;
        }
    }, {
        key: "provideDocumentSymbols",
        value: function provideDocumentSymbols(resource) {
            var modelMirror = this.resourceService.get(resource);
            var parser = new _jsonParser2.default.JSONParser();
            var doc = parser.parse(modelMirror.getValue());
            var root = doc.root;
            if (!root) {
                return Promise.resolve(null);
            }
            var resourceString = resource.toString();
            if (resourceString === 'vscode://defaultsettings/keybindings.json' || _strings2.default.endsWith(resourceString.toLowerCase(), '/user/keybindings.json')) {
                if (root.type === 'array') {
                    var result = [];
                    root.items.forEach(function (item) {
                        if (item.type === 'object') {
                            var property = item.getFirstProperty('key');
                            if (property && property.value) {
                                var range = modelMirror.getRangeFromOffsetAndLength(item.start, item.end - item.start);
                                result.push({
                                    name: property.value.getValue(),
                                    kind: "string",
                                    location: {
                                        uri: resource,
                                        range: range
                                    }
                                });
                            }
                        }
                    });
                    return Promise.resolve(result);
                }
            }
            function collectOutlineEntries(result, node, containerName) {
                if (node.type === 'array') {
                    node.items.forEach(function (node) {
                        collectOutlineEntries(result, node, containerName);
                    });
                } else if (node.type === 'object') {
                    var objectNode = node;
                    objectNode.properties.forEach(function (property) {
                        var range = modelMirror.getRangeFromOffsetAndLength(property.start, property.end - property.start);
                        var valueNode = property.value;
                        if (valueNode) {
                            var childContainerName = containerName ? containerName + '.' + property.key.name : property.key.name;
                            result.push({
                                name: property.key.getValue(),
                                kind: getSymbolKind(valueNode.type),
                                location: {
                                    uri: resource,
                                    range: range
                                },
                                containerName: containerName
                            });
                            collectOutlineEntries(result, valueNode, childContainerName);
                        }
                    });
                }
                return result;
            }
            var result = collectOutlineEntries([], root, void 0);
            return Promise.resolve(result);
        }
    }, {
        key: "format",
        value: function format(resource, range, options) {
            var model = this.resourceService.get(resource);
            var formatRange = range ? model.getOffsetAndLengthFromRange(range) : void 0;
            var edits = _jsonFormatter2.default.format(model.getValue(), formatRange, { insertSpaces: options.insertSpaces, tabSize: options.tabSize, eol: model.getEOL() });
            var operations = edits.map(function (e) {
                return { range: model.getRangeFromOffsetAndLength(e.offset, e.length), text: e.content };
            });
            return Promise.resolve(operations);
        }
    }]);

    return JSONWorker;
}();

exports.JSONWorker = JSONWorker = __decorate([__param(1, IResourceService), __param(2, IMarkerService), __param(3, IWorkspaceContextService), __param(4, IInstantiationService)], JSONWorker);
function getSymbolKind(nodeType) {
    switch (nodeType) {
        case 'object':
        case 'string':
        case 'number':
        case 'array':
        case 'boolean':
            return nodeType;
        default:
            return "variable";
    }
}

var Location = exports.Location = function Location() {
    _classCallCheck(this, Location);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZzY29kZS9qc29uV29ya2VyLnRzIiwidnNjb2RlL2pzb25Xb3JrZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBSUE7Ozs7Ozs7Ozs7O0FDTUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7Ozs7O0FBbEJBLElBQUksYUFBYyxhQUFRLFVBQUssVUFBZCxJQUE2QixVQUFVLFVBQVYsRUFBc0IsTUFBdEIsRUFBOEIsR0FBOUIsRUFBbUMsSUFBbkMsRUFBeUM7QUFDbkYsUUFBSSxJQUFJLFVBQVUsTUFBbEI7UUFBMEIsSUFBSSxJQUFJLENBQUosR0FBUSxNQUFSLEdBQWlCLFNBQVMsSUFBVCxHQUFnQixPQUFPLE9BQU8sd0JBQVAsQ0FBZ0MsTUFBaEMsRUFBd0MsR0FBeEMsQ0FBdkIsR0FBc0UsSUFBckg7UUFBMkgsQ0FBM0g7QUFDQSxRQUFJLFFBQU8sT0FBUCx5Q0FBTyxPQUFQLE9BQW1CLFFBQW5CLElBQStCLE9BQU8sUUFBUSxRQUFmLEtBQTRCLFVBQS9ELEVBQTJFLElBQUksUUFBUSxRQUFSLENBQWlCLFVBQWpCLEVBQTZCLE1BQTdCLEVBQXFDLEdBQXJDLEVBQTBDLElBQTFDLENBQUosQ0FBM0UsS0FDSyxLQUFLLElBQUksSUFBSSxXQUFXLE1BQVgsR0FBb0IsQ0FBakMsRUFBb0MsS0FBSyxDQUF6QyxFQUE0QyxHQUE1QztBQUFpRCxZQUFJLElBQUksV0FBVyxDQUFYLENBQVIsRUFBdUIsSUFBSSxDQUFDLElBQUksQ0FBSixHQUFRLEVBQUUsQ0FBRixDQUFSLEdBQWUsSUFBSSxDQUFKLEdBQVEsRUFBRSxNQUFGLEVBQVUsR0FBVixFQUFlLENBQWYsQ0FBUixHQUE0QixFQUFFLE1BQUYsRUFBVSxHQUFWLENBQTVDLEtBQStELENBQW5FO0FBQXhFLEtBQ0wsT0FBTyxJQUFJLENBQUosSUFBUyxDQUFULElBQWMsT0FBTyxjQUFQLENBQXNCLE1BQXRCLEVB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LGdCQUFBLFdBQUEsQ0N3T0osUUFBUSxDQUFSLEVEeE9LLGdCQ3dPTCxDRHhPSSxFQ3lPSixRQUFRLENBQVIsRUR4T0ssY0N3T0wsQ0R6T0ksRUMwT0osUUFBUSxDQUFSLEVEeE9LLHdCQ3dPTCxDRDFPSSxFQzJPSixRQUFRLENBQVIsRUR4T0sscUJDd09MLENEM09JLENBQUEsRUM0T0wsVUQ1T0ssQ0FBQTtBQWdWUixTQUFBLGFBQUEsQ0FBdUIsUUFBdkIsRUFBdUM7QUFDbkMsWUFBUSxRQUFSO0FBQ0ksYUFBSyxRQUFMO0FBQ0EsYUFBSyxRQUFMO0FBQ0EsYUFBSyxRQUFMO0FBQ0EsYUFBSyxPQUFMO0FBQ0EsYUFBSyxTQUFMO0FBQ0ksbUJBQU8sUUFBUDtBQUNKO0FBQ0ksbUJBQU8sVUFBUDtBQVJSO0FBVUg7O0lBY0QsUSxXQUFBLFEiLCJmaWxlIjoidnNjb2RlL2pzb25Xb3JrZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4gKiAgQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuIFNlZSBMaWNlbnNlLnR4dCBpbiB0aGUgcHJvamVjdCByb290IGZvciBsaWNlbnNlIGluZm9ybWF0aW9uLlxyXG4gKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi9cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuaW1wb3J0IFVSSSBmcm9tICcuL2NvbW1vbi91cmknO1xyXG5pbXBvcnQgU2V2ZXJpdHkgZnJvbSAnLi9jb21tb24vc2V2ZXJpdHknO1xyXG5pbXBvcnQgSHRtbENvbnRlbnQgZnJvbSAnLi9jb21tb24vaHRtbENvbnRlbnQnO1xyXG5pbXBvcnQgUGFyc2VyIGZyb20gJy4vcGFyc2VyL2pzb25QYXJzZXInO1xyXG5pbXBvcnQgSlNPTkZvcm1hdHRlciBmcm9tICcuL2NvbW1vbi9qc29uRm9ybWF0dGVyJztcclxuaW1wb3J0IFNjaGVtYVNlcnZpY2UgZnJvbSAnLi9qc29uU2NoZW1hU2VydmljZSc7XHJcbmltcG9ydCBKU09OU2NoZW1hIGZyb20gJy4vY29tbW9uL2pzb25TY2hlbWEnO1xyXG5pbXBvcnQgSlNPTkludGVsbGlzZW5zZSBmcm9tICcuL2pzb25JbnRlbGxpc2Vuc2UnO1xyXG5pbXBvcnQgU3RyaW5ncyBmcm9tICcuL2NvbW1vbi9zdHJpbmdzJztcclxuaW1wb3J0IFByb2plY3RKU09OQ29udHJpYnV0aW9uIGZyb20gJy4vY29udHJpYnV0aW9ucy9wcm9qZWN0SlNPTkNvbnRyaWJ1dGlvbic7XHJcbmltcG9ydCBQYWNrYWdlSlNPTkNvbnRyaWJ1dGlvbiBmcm9tICcuL2NvbnRyaWJ1dGlvbnMvcGFja2FnZUpTT05Db250cmlidXRpb24nO1xyXG5pbXBvcnQgQm93ZXJKU09OQ29udHJpYnV0aW9uIGZyb20gJy4vY29udHJpYnV0aW9ucy9ib3dlckpTT05Db250cmlidXRpb24nO1xyXG5pbXBvcnQgR2xvYlBhdHRlcm5Db250cmlidXRpb24gZnJvbSAnLi9jb250cmlidXRpb25zL2dsb2JQYXR0ZXJuQ29udHJpYnV0aW9uJztcclxuaW1wb3J0IHtKU09OTG9jYXRpb259IGZyb20gJy4vcGFyc2VyL2pzb25Mb2NhdGlvbic7XHJcbmltcG9ydCByZXF1ZXN0IGZyb20gJ3JlcXVlc3QtbGlnaHQnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJT3B0aW9uc1NjaGVtYSB7XHJcbiAgICAvKipcclxuICAgICAqIEhUVFAgc2NoZW1hIFVSTCBvciBhIHJlbGF0aXZlIHBhdGggdG8gc2NoZW1hIGZpbGUgaW4gd29ya3NwYWNlXHJcbiAgICAgKi9cclxuICAgIHVybDogc3RyaW5nO1xyXG4gICAgLyoqXHJcbiAgICAgKiBUaGUgcGF0dGVybnMgKGUuZy4gKi5wYWNrLmpzb24pIHRvIG1hcCBmaWxlcyB0byB0aGlzIHNjaGVtYVxyXG4gICAgICovXHJcbiAgICBmaWxlTWF0Y2g6IHN0cmluZ1tdO1xyXG4gICAgLyoqXHJcbiAgICAgKiBBIHVucmVzb2x2ZWQgc2NoZW1hIGRlZmluaXRpb24uIE9wdGlvbmFsLCB0byBhdm9pZCBmZXRjaGluZyBmcm9tIGEgVVJMLlxyXG4gICAgICovXHJcbiAgICBzY2hlbWE/OiBKU09OU2NoZW1hLklKU09OU2NoZW1hO1xyXG5cclxuICAgIC8qIGRlcHJlY2F0ZWQgKi9cclxuICAgIHNjaGVtYVBhdGg6IHN0cmluZztcclxuICAgIC8qIGRlcHJlY2F0ZWQgKi9cclxuICAgIGZpbGVQYXR0ZXJuOiBzdHJpbmc7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgSU9wdGlvbnMge1xyXG4gICAgc2NoZW1hczogSU9wdGlvbnNTY2hlbWFbXTtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJU3VnZ2VzdGlvbnNDb2xsZWN0b3Ige1xyXG4gICAgYWRkKHN1Z2dlc3Rpb246IFN1Z2dlc3Rpb24pOiB2b2lkO1xyXG4gICAgc2V0QXNJbmNvbXBsZXRlKCkgOiB2b2lkO1xyXG4gICAgZXJyb3IobWVzc2FnZTpzdHJpbmcpOiB2b2lkO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIElKU09OV29ya2VyQ29udHJpYnV0aW9uIHtcclxuICAgIGdldEluZm9Db250cmlidXRpb24ocmVzb3VyY2U6IFVSSSwgbG9jYXRpb246IEpTT05Mb2NhdGlvbikgOiBQcm9taXNlPEh0bWxDb250ZW50LklIVE1MQ29udGVudEVsZW1lbnRbXT47XHJcbiAgICBjb2xsZWN0UHJvcGVydHlTdWdnZXN0aW9ucyhyZXNvdXJjZTogVVJJLCBsb2NhdGlvbjogSlNPTkxvY2F0aW9uLCBjdXJyZW50V29yZDogc3RyaW5nLCBhZGRWYWx1ZTogYm9vbGVhbiwgaXNMYXN0OmJvb2xlYW4sIHJlc3VsdDogSVN1Z2dlc3Rpb25zQ29sbGVjdG9yKSA6IFByb21pc2U8YW55PjtcclxuICAgIGNvbGxlY3RWYWx1ZVN1Z2dlc3Rpb25zKHJlc291cmNlOiBVUkksIGxvY2F0aW9uOiBKU09OTG9jYXRpb24sIHByb3BlcnR5S2V5OiBzdHJpbmcsIHJlc3VsdDogSVN1Z2dlc3Rpb25zQ29sbGVjdG9yKTogUHJvbWlzZTxhbnk+O1xyXG4gICAgY29sbGVjdERlZmF1bHRTdWdnZXN0aW9ucyhyZXNvdXJjZTogVVJJLCByZXN1bHQ6IElTdWdnZXN0aW9uc0NvbGxlY3Rvcik6IFByb21pc2U8YW55PjtcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEpTT05Xb3JrZXIge1xyXG5cclxuICAgIHByaXZhdGUgc2NoZW1hU2VydmljZTogU2NoZW1hU2VydmljZS5JSlNPTlNjaGVtYVNlcnZpY2U7XHJcbiAgICBwcml2YXRlIGNvbnRleHRTZXJ2aWNlOiBJV29ya3NwYWNlQ29udGV4dFNlcnZpY2U7XHJcbiAgICBwcml2YXRlIGpzb25JbnRlbGxpc2Vuc2UgOiBKU09OSW50ZWxsaXNlbnNlLkpTT05JbnRlbGxpc2Vuc2U7XHJcbiAgICBwcml2YXRlIGNvbnRyaWJ1dGlvbnM6IElKU09OV29ya2VyQ29udHJpYnV0aW9uW107XHJcbiAgICBwcml2YXRlIF92YWxpZGF0aW9uSGVscGVyOiBWYWxpZGF0aW9uSGVscGVyO1xyXG4gICAgcHJpdmF0ZSByZXNvdXJjZVNlcnZpY2U6SVJlc291cmNlU2VydmljZTtcclxuICAgIHByaXZhdGUgbWFya2VyU2VydmljZTogSU1hcmtlclNlcnZpY2U7XHJcbiAgICBwcml2YXRlIF9tb2RlSWQ6IHN0cmluZztcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBtb2RlSWQ6IHN0cmluZyxcclxuICAgICAgICBASVJlc291cmNlU2VydmljZSByZXNvdXJjZVNlcnZpY2U6IElSZXNvdXJjZVNlcnZpY2UsXHJcbiAgICAgICAgQElNYXJrZXJTZXJ2aWNlIG1hcmtlclNlcnZpY2U6IElNYXJrZXJTZXJ2aWNlLFxyXG4gICAgICAgIEBJV29ya3NwYWNlQ29udGV4dFNlcnZpY2UgY29udGV4dFNlcnZpY2U6IElXb3Jrc3BhY2VDb250ZXh0U2VydmljZSxcclxuICAgICAgICBASUluc3RhbnRpYXRpb25TZXJ2aWNlIGluc3RhbnRpYXRpb25TZXJ2aWNlOiBJSW5zdGFudGlhdGlvblNlcnZpY2VcclxuICAgICkge1xyXG5cclxuICAgICAgICB0aGlzLl9tb2RlSWQgPSBtb2RlSWQ7XHJcbiAgICAgICAgdGhpcy5yZXNvdXJjZVNlcnZpY2UgPSByZXNvdXJjZVNlcnZpY2U7XHJcbiAgICAgICAgdGhpcy5tYXJrZXJTZXJ2aWNlID0gbWFya2VyU2VydmljZTtcclxuXHJcbiAgICAgICAgdGhpcy5fdmFsaWRhdGlvbkhlbHBlciA9IG5ldyBWYWxpZGF0aW9uSGVscGVyKFxyXG4gICAgICAgICAgICB0aGlzLnJlc291cmNlU2VydmljZSxcclxuICAgICAgICAgICAgdGhpcy5fbW9kZUlkLFxyXG4gICAgICAgICAgICAodG9WYWxpZGF0ZSkgPT4gdGhpcy5kb1ZhbGlkYXRlKHRvVmFsaWRhdGUpXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgdGhpcy5jb250ZXh0U2VydmljZSA9IGNvbnRleHRTZXJ2aWNlO1xyXG4gICAgICAgIHRoaXMuc2NoZW1hU2VydmljZSA9IGluc3RhbnRpYXRpb25TZXJ2aWNlLmNyZWF0ZUluc3RhbmNlKFNjaGVtYVNlcnZpY2UuSlNPTlNjaGVtYVNlcnZpY2UpO1xyXG5cclxuICAgICAgICB0aGlzLmNvbnRyaWJ1dGlvbnMgPSBbXHJcbiAgICAgICAgICAgIGluc3RhbnRpYXRpb25TZXJ2aWNlLmNyZWF0ZUluc3RhbmNlKFByb2plY3RKU09OQ29udHJpYnV0aW9uLlByb2plY3RKU09OQ29udHJpYnV0aW9uKSxcclxuICAgICAgICAgICAgaW5zdGFudGlhdGlvblNlcnZpY2UuY3JlYXRlSW5zdGFuY2UoUGFja2FnZUpTT05Db250cmlidXRpb24uUGFja2FnZUpTT05Db250cmlidXRpb24pLFxyXG4gICAgICAgICAgICBpbnN0YW50aWF0aW9uU2VydmljZS5jcmVhdGVJbnN0YW5jZShCb3dlckpTT05Db250cmlidXRpb24uQm93ZXJKU09OQ29udHJpYnV0aW9uKSxcclxuICAgICAgICAgICAgaW5zdGFudGlhdGlvblNlcnZpY2UuY3JlYXRlSW5zdGFuY2UoR2xvYlBhdHRlcm5Db250cmlidXRpb24uR2xvYlBhdHRlcm5Db250cmlidXRpb24pXHJcbiAgICAgICAgXTtcclxuXHJcbiAgICAgICAgdGhpcy5qc29uSW50ZWxsaXNlbnNlID0gbmV3IEpTT05JbnRlbGxpc2Vuc2UuSlNPTkludGVsbGlzZW5lc2UodGhpcy5zY2hlbWFTZXJ2aWNlLCB0aGlzLmNvbnRyaWJ1dGlvbnMpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBuYXZpZ2F0ZVZhbHVlU2V0KHJlc291cmNlOlVSSSwgcmFuZ2U6RWRpdG9yQ29tbW9uLklSYW5nZSwgdXA6Ym9vbGVhbik6UHJvbWlzZTxJSW5wbGFjZVJlcGxhY2VTdXBwb3J0UmVzdWx0PiB7XHJcbiAgICAgICAgdmFyIG1vZGVsTWlycm9yID0gdGhpcy5yZXNvdXJjZVNlcnZpY2UuZ2V0KHJlc291cmNlKTtcclxuICAgICAgICB2YXIgb2Zmc2V0ID0gbW9kZWxNaXJyb3IuZ2V0T2Zmc2V0RnJvbVBvc2l0aW9uKHsgbGluZU51bWJlcjogcmFuZ2Uuc3RhcnRMaW5lTnVtYmVyLCBjb2x1bW46IHJhbmdlLnN0YXJ0Q29sdW1uIH0pO1xyXG5cclxuICAgICAgICB2YXIgcGFyc2VyID0gbmV3IFBhcnNlci5KU09OUGFyc2VyKCk7XHJcbiAgICAgICAgdmFyIGNvbmZpZyA9IG5ldyBQYXJzZXIuSlNPTkRvY3VtZW50Q29uZmlnKCk7XHJcbiAgICAgICAgY29uZmlnLmlnbm9yZURhbmdsaW5nQ29tbWEgPSB0cnVlO1xyXG4gICAgICAgIHZhciBkb2MgPSBwYXJzZXIucGFyc2UobW9kZWxNaXJyb3IuZ2V0VmFsdWUoKSwgY29uZmlnKTtcclxuICAgICAgICB2YXIgbm9kZSA9IGRvYy5nZXROb2RlRnJvbU9mZnNldEVuZEluY2x1c2l2ZShvZmZzZXQpO1xyXG5cclxuICAgICAgICBpZiAobm9kZSAmJiAobm9kZS50eXBlID09PSAnc3RyaW5nJyB8fCBub2RlLnR5cGUgPT09ICdudW1iZXInIHx8IG5vZGUudHlwZSA9PT0gJ2Jvb2xlYW4nIHx8IG5vZGUudHlwZSA9PT0gJ251bGwnKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zY2hlbWFTZXJ2aWNlLmdldFNjaGVtYUZvclJlc291cmNlKHJlc291cmNlLnRvU3RyaW5nKCksIGRvYykudGhlbigoc2NoZW1hKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoc2NoZW1hKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHByb3Bvc2FscyA6IFN1Z2dlc3Rpb25bXSA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBwcm9wb3NlZDogYW55ID0ge307XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbGxlY3RvciA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYWRkOiAoc3VnZ2VzdGlvbjogU3VnZ2VzdGlvbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFwcm9wb3NlZFtzdWdnZXN0aW9uLnRleHRdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcG9zZWRbc3VnZ2VzdGlvbi50ZXh0XSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcG9zYWxzLnB1c2goc3VnZ2VzdGlvbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldEFzSW5jb21wbGV0ZTogKCkgPT4geyAvKiBpZ25vcmUgKi8gfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IChtZXNzYWdlOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihtZXNzYWdlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuanNvbkludGVsbGlzZW5zZS5nZXRWYWx1ZVN1Z2dlc3Rpb25zKHJlc291cmNlLCBzY2hlbWEsIGRvYywgbm9kZS5wYXJlbnQsIG5vZGUuc3RhcnQsIGNvbGxlY3Rvcik7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHZhciByYW5nZSA9IG1vZGVsTWlycm9yLmdldFJhbmdlRnJvbU9mZnNldEFuZExlbmd0aChub2RlLnN0YXJ0LCBub2RlLmVuZCAtIG5vZGUuc3RhcnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gbW9kZWxNaXJyb3IuZ2V0VmFsdWVJblJhbmdlKHJhbmdlKTtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gcHJvcG9zYWxzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChTdHJpbmdzLmVxdWFsc0lnbm9yZUNhc2UocHJvcG9zYWxzW2ldLnRleHQsIHRleHQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dElkeCA9IGk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodXApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0SWR4ID0gKGkgKyAxKSAlIGxlbjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dElkeCA9ICBpIC0gMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dElkeCA8IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dElkeCA9IGxlbiAtIDE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogcHJvcG9zYWxzW25leHRJZHhdLnRleHQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2U6IHJhbmdlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAcmV0dXJuIHRydWUgaWYgeW91IHdhbnQgdG8gcmV2YWxpZGF0ZSB5b3VyIG1vZGVsc1xyXG4gICAgICovXHJcbiAgICBfZG9Db25maWd1cmUob3B0aW9uczpJT3B0aW9ucyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuc2NoZW1hcykge1xyXG4gICAgICAgICAgICB0aGlzLnNjaGVtYVNlcnZpY2UuY2xlYXJFeHRlcm5hbFNjaGVtYXMoKTtcclxuICAgICAgICAgICAgb3B0aW9ucy5zY2hlbWFzLmZvckVhY2goKHNjaGVtYSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHNjaGVtYS51cmwgJiYgKHNjaGVtYS5maWxlTWF0Y2ggfHwgc2NoZW1hLnNjaGVtYSkpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgdXJsID0gc2NoZW1hLnVybDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIVN0cmluZ3Muc3RhcnRzV2l0aCh1cmwsICdodHRwOi8vJykgJiYgIVN0cmluZ3Muc3RhcnRzV2l0aCh1cmwsICdodHRwczovLycpICYmICFTdHJpbmdzLnN0YXJ0c1dpdGgodXJsLCAnZmlsZTovLycpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXNvdXJjZVVSTCA9IHRoaXMuY29udGV4dFNlcnZpY2UudG9SZXNvdXJjZSh1cmwpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzb3VyY2VVUkwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybCA9IHJlc291cmNlVVJMLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHVybCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNjaGVtYVNlcnZpY2UucmVnaXN0ZXJFeHRlcm5hbFNjaGVtYSh1cmwsIHNjaGVtYS5maWxlTWF0Y2gsIHNjaGVtYS5zY2hlbWEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2NoZW1hLmZpbGVQYXR0ZXJuICYmIHNjaGVtYS5zY2hlbWFQYXRoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHVybCA9IHRoaXMuY29udGV4dFNlcnZpY2UudG9SZXNvdXJjZShzY2hlbWEuc2NoZW1hUGF0aCkudG9TdHJpbmcoKTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgcGF0dGVybnMgPSBzY2hlbWEuZmlsZVBhdHRlcm4gPyBbIHNjaGVtYS5maWxlUGF0dGVybiBdIDogW107XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zY2hlbWFTZXJ2aWNlLnJlZ2lzdGVyRXh0ZXJuYWxTY2hlbWEodXJsLCBwYXR0ZXJucyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLl92YWxpZGF0aW9uSGVscGVyLnRyaWdnZXJEdWVUb0NvbmZpZ3VyYXRpb25DaGFuZ2UoKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh2b2lkIDApO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzZXRTY2hlbWFDb250cmlidXRpb25zKGNvbnRyaWJ1dGlvbnM6SVNjaGVtYUNvbnRyaWJ1dGlvbnMpOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuICAgICAgICB0aGlzLnNjaGVtYVNlcnZpY2Uuc2V0U2NoZW1hQ29udHJpYnV0aW9ucyhjb250cmlidXRpb25zKTtcclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRydWUpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBlbmFibGVWYWxpZGF0b3IoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgdGhpcy5fdmFsaWRhdGlvbkhlbHBlci5lbmFibGUoKTtcclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG51bGwpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBkb1ZhbGlkYXRlKHJlc291cmNlczogVVJJW10pOnZvaWQge1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzb3VyY2VzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZG9WYWxpZGF0ZTEocmVzb3VyY2VzW2ldKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBkb1ZhbGlkYXRlMShyZXNvdXJjZTogVVJJKTp2b2lkIHtcclxuICAgICAgICB2YXIgbW9kZWxNaXJyb3IgPSB0aGlzLnJlc291cmNlU2VydmljZS5nZXQocmVzb3VyY2UpO1xyXG4gICAgICAgIHZhciBwYXJzZXIgPSBuZXcgUGFyc2VyLkpTT05QYXJzZXIoKTtcclxuICAgICAgICB2YXIgY29udGVudCA9IG1vZGVsTWlycm9yLmdldFZhbHVlKCk7XHJcblxyXG4gICAgICAgIGlmIChjb250ZW50Lmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICAvLyBpZ25vcmUgZW1wdHkgY29udGVudCwgbm8gbWFya2VyIGNhbiBiZSBzZXQgYW55d2F5XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHJlc3VsdCA9IHBhcnNlci5wYXJzZShjb250ZW50KTtcclxuICAgICAgICB0aGlzLnNjaGVtYVNlcnZpY2UuZ2V0U2NoZW1hRm9yUmVzb3VyY2UocmVzb3VyY2UudG9TdHJpbmcoKSwgcmVzdWx0KS50aGVuKChzY2hlbWEpID0+IHtcclxuICAgICAgICAgICAgaWYgKHNjaGVtYSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHNjaGVtYS5lcnJvcnMubGVuZ3RoICYmIHJlc3VsdC5yb290KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5ID0gcmVzdWx0LnJvb3QudHlwZSA9PT0gJ29iamVjdCcgPyAoPFBhcnNlci5PYmplY3RBU1ROb2RlPiByZXN1bHQucm9vdCkuZ2V0Rmlyc3RQcm9wZXJ0eSgnJHNjaGVtYScpIDogbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocHJvcGVydHkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBwcm9wZXJ0eS52YWx1ZSB8fCBwcm9wZXJ0eTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lndhcm5pbmdzLnB1c2goeyBsb2NhdGlvbjogeyBzdGFydDogbm9kZS5zdGFydCwgZW5kOiBub2RlLmVuZCB9LCBtZXNzYWdlOiBzY2hlbWEuZXJyb3JzWzBdIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC53YXJuaW5ncy5wdXNoKHsgbG9jYXRpb246IHsgc3RhcnQ6IHJlc3VsdC5yb290LnN0YXJ0LCBlbmQ6IHJlc3VsdC5yb290LnN0YXJ0ICsgMSB9LCBtZXNzYWdlOiBzY2hlbWEuZXJyb3JzWzBdIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnZhbGlkYXRlKHNjaGVtYS5zY2hlbWEpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBhZGRlZCA6IHsgW3NpZ25hdHVyZTpzdHJpbmddOiBib29sZWFufSA9IHt9O1xyXG4gICAgICAgICAgICB2YXIgbWFya2VyRGF0YTogSU1hcmtlckRhdGFbXSA9IFtdO1xyXG5cclxuICAgICAgICAgICAgcmVzdWx0LmVycm9ycy5jb25jYXQocmVzdWx0Lndhcm5pbmdzKS5mb3JFYWNoKChlcnJvciwgaWR4KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyByZW1vdmUgZHVwbGljYXRlZCBtZXNzYWdlc1xyXG4gICAgICAgICAgICAgICAgdmFyIHNpZ25hdHVyZSA9IGVycm9yLmxvY2F0aW9uLnN0YXJ0ICsgJyAnICsgZXJyb3IubG9jYXRpb24uZW5kICsgJyAnICsgZXJyb3IubWVzc2FnZTtcclxuICAgICAgICAgICAgICAgIGlmICghYWRkZWRbc2lnbmF0dXJlXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFkZGVkW3NpZ25hdHVyZV0gPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBzdGFydFBvc2l0aW9uID0gbW9kZWxNaXJyb3IuZ2V0UG9zaXRpb25Gcm9tT2Zmc2V0KGVycm9yLmxvY2F0aW9uLnN0YXJ0KTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZW5kUG9zaXRpb24gPSBtb2RlbE1pcnJvci5nZXRQb3NpdGlvbkZyb21PZmZzZXQoZXJyb3IubG9jYXRpb24uZW5kKTtcclxuICAgICAgICAgICAgICAgICAgICBtYXJrZXJEYXRhLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXZlcml0eTogaWR4ID49IHJlc3VsdC5lcnJvcnMubGVuZ3RoID8gU2V2ZXJpdHkuV2FybmluZyA6IFNldmVyaXR5LkVycm9yLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGFydExpbmVOdW1iZXI6IHN0YXJ0UG9zaXRpb24ubGluZU51bWJlcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRDb2x1bW46IHN0YXJ0UG9zaXRpb24uY29sdW1uLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbmRMaW5lTnVtYmVyOiBlbmRQb3NpdGlvbi5saW5lTnVtYmVyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbmRDb2x1bW46IGVuZFBvc2l0aW9uLmNvbHVtblxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMubWFya2VyU2VydmljZS5jaGFuZ2VPbmUodGhpcy5fbW9kZUlkLCByZXNvdXJjZSwgbWFya2VyRGF0YSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBwcm92aWRlQ29tcGxldGlvbkl0ZW1zKHJlc291cmNlOlVSSSwgcG9zaXRpb246RWRpdG9yQ29tbW9uLklQb3NpdGlvbik6UHJvbWlzZTxTdWdnZXN0aW9uW10+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5kb1N1Z2dlc3QocmVzb3VyY2UsIHBvc2l0aW9uKS50aGVuKHZhbHVlID0+IGZpbHRlclN1Z2dlc3Rpb25zKHZhbHVlKSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBkb1N1Z2dlc3QocmVzb3VyY2U6VVJJLCBwb3NpdGlvbjpFZGl0b3JDb21tb24uSVBvc2l0aW9uKTpQcm9taXNlPFN1Z2dlc3Rpb24+IHtcclxuICAgICAgICB2YXIgbW9kZWxNaXJyb3IgPSB0aGlzLnJlc291cmNlU2VydmljZS5nZXQocmVzb3VyY2UpO1xyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5qc29uSW50ZWxsaXNlbnNlLmRvU3VnZ2VzdChyZXNvdXJjZSwgbW9kZWxNaXJyb3IsIHBvc2l0aW9uKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgcHJvdmlkZUhvdmVyKHJlc291cmNlOlVSSSwgcG9zaXRpb246RWRpdG9yQ29tbW9uLklQb3NpdGlvbik6IFByb21pc2U8SG92ZXI+IHtcclxuXHJcbiAgICAgICAgdmFyIG1vZGVsTWlycm9yID0gdGhpcy5yZXNvdXJjZVNlcnZpY2UuZ2V0KHJlc291cmNlKTtcclxuXHJcbiAgICAgICAgdmFyIHBhcnNlciA9IG5ldyBQYXJzZXIuSlNPTlBhcnNlcigpO1xyXG4gICAgICAgIHZhciBkb2MgPSBwYXJzZXIucGFyc2UobW9kZWxNaXJyb3IuZ2V0VmFsdWUoKSk7XHJcblxyXG4gICAgICAgIHZhciBvZmZzZXQgPSBtb2RlbE1pcnJvci5nZXRPZmZzZXRGcm9tUG9zaXRpb24ocG9zaXRpb24pO1xyXG4gICAgICAgIHZhciBub2RlID0gZG9jLmdldE5vZGVGcm9tT2Zmc2V0KG9mZnNldCk7XHJcbiAgICAgICAgdmFyIG9yaWdpbmFsTm9kZSA9IG5vZGU7XHJcblxyXG4gICAgICAgIC8vIHVzZSB0aGUgcHJvcGVydHkgZGVzY3JpcHRpb24gd2hlbiBob3ZlcmluZyBvdmVyIGFuIG9iamVjdCBrZXlcclxuICAgICAgICBpZiAobm9kZSAmJiBub2RlLnR5cGUgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgIHZhciBzdHJpbmdOb2RlID0gPFBhcnNlci5TdHJpbmdBU1ROb2RlPm5vZGU7XHJcbiAgICAgICAgICAgIGlmIChzdHJpbmdOb2RlLmlzS2V5KSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcHJvcGVydHlOb2RlID0gPFBhcnNlci5Qcm9wZXJ0eUFTVE5vZGU+bm9kZS5wYXJlbnQ7XHJcbiAgICAgICAgICAgICAgICBub2RlID0gcHJvcGVydHlOb2RlLnZhbHVlO1xyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCFub2RlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobnVsbCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5zY2hlbWFTZXJ2aWNlLmdldFNjaGVtYUZvclJlc291cmNlKHJlc291cmNlLnRvU3RyaW5nKCksIGRvYykudGhlbigoc2NoZW1hKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChzY2hlbWEpIHtcclxuICAgICAgICAgICAgICAgIHZhciBtYXRjaGluZ1NjaGVtYXMgOiBQYXJzZXIuSUFwcGxpY2FibGVTY2hlbWFbXSA9IFtdO1xyXG4gICAgICAgICAgICAgICAgZG9jLnZhbGlkYXRlKHNjaGVtYS5zY2hlbWEsIG1hdGNoaW5nU2NoZW1hcywgbm9kZS5zdGFydCk7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIGRlc2NyaXB0aW9uOiBzdHJpbmcgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgdmFyIGNvbnRyaWJ1dG9uSWQ6IHN0cmluZyA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICBtYXRjaGluZ1NjaGVtYXMuZXZlcnkoKHMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocy5ub2RlID09PSBub2RlICYmICFzLmludmVydGVkICYmIHMuc2NoZW1hKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gZGVzY3JpcHRpb24gfHwgcy5zY2hlbWEuZGVzY3JpcHRpb247XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyaWJ1dG9uSWQgPSBjb250cmlidXRvbklkIHx8IHMuc2NoZW1hLmlkO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIHZhciBsb2NhdGlvbiA9IG5vZGUuZ2V0Tm9kZUxvY2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpPSB0aGlzLmNvbnRyaWJ1dGlvbnMubGVuZ3RoIC0xOyBpID49IDA7IGktLSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBjb250cmlidXRpb24gPSB0aGlzLmNvbnRyaWJ1dGlvbnNbaV07XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHByb21pc2UgPSBjb250cmlidXRpb24uZ2V0SW5mb0NvbnRyaWJ1dGlvbihyZXNvdXJjZSwgbG9jYXRpb24pO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwcm9taXNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9taXNlLnRoZW4oKGh0bWxDb250ZW50KSA9PiB7IHJldHVybiB0aGlzLmNyZWF0ZUluZm9SZXN1bHQoaHRtbENvbnRlbnQsIG9yaWdpbmFsTm9kZSwgbW9kZWxNaXJyb3IpOyB9ICk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmIChkZXNjcmlwdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBodG1sQ29udGVudCA9IFsge2NsYXNzTmFtZTogJ2RvY3VtZW50YXRpb24nLCB0ZXh0OiBkZXNjcmlwdGlvbiB9IF07XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlSW5mb1Jlc3VsdChodG1sQ29udGVudCwgb3JpZ2luYWxOb2RlLCBtb2RlbE1pcnJvcik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjcmVhdGVJbmZvUmVzdWx0KGh0bWxDb250ZW50IDogSHRtbENvbnRlbnQuSUhUTUxDb250ZW50RWxlbWVudFtdLCBub2RlOiBQYXJzZXIuQVNUTm9kZSwgbW9kZWxNaXJyb3I6IEVkaXRvckNvbW1vbi5JTWlycm9yTW9kZWwpIDogSG92ZXIge1xyXG4gICAgICAgIHZhciByYW5nZSA9IG1vZGVsTWlycm9yLmdldFJhbmdlRnJvbU9mZnNldEFuZExlbmd0aChub2RlLnN0YXJ0LCBub2RlLmVuZCAtIG5vZGUuc3RhcnQpO1xyXG5cclxuICAgICAgICB2YXIgcmVzdWx0OkhvdmVyID0ge1xyXG4gICAgICAgICAgICBodG1sQ29udGVudDogaHRtbENvbnRlbnQsXHJcbiAgICAgICAgICAgIHJhbmdlOiByYW5nZVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHVibGljIHByb3ZpZGVEb2N1bWVudFN5bWJvbHMocmVzb3VyY2U6VVJJKTpQcm9taXNlPFN5bWJvbEluZm9ybWF0aW9uW10+IHtcclxuICAgICAgICB2YXIgbW9kZWxNaXJyb3IgPSB0aGlzLnJlc291cmNlU2VydmljZS5nZXQocmVzb3VyY2UpO1xyXG5cclxuICAgICAgICB2YXIgcGFyc2VyID0gbmV3IFBhcnNlci5KU09OUGFyc2VyKCk7XHJcbiAgICAgICAgdmFyIGRvYyA9IHBhcnNlci5wYXJzZShtb2RlbE1pcnJvci5nZXRWYWx1ZSgpKTtcclxuICAgICAgICB2YXIgcm9vdCA9IGRvYy5yb290O1xyXG4gICAgICAgIGlmICghcm9vdCkge1xyXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG51bGwpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gc3BlY2lhbCBoYW5kbGluZyBmb3Iga2V5IGJpbmRpbmdzXHJcbiAgICAgICAgdmFyIHJlc291cmNlU3RyaW5nID0gcmVzb3VyY2UudG9TdHJpbmcoKTtcclxuICAgICAgICBpZiAoKHJlc291cmNlU3RyaW5nID09PSAndnNjb2RlOi8vZGVmYXVsdHNldHRpbmdzL2tleWJpbmRpbmdzLmpzb24nKSB8fCBTdHJpbmdzLmVuZHNXaXRoKHJlc291cmNlU3RyaW5nLnRvTG93ZXJDYXNlKCksICcvdXNlci9rZXliaW5kaW5ncy5qc29uJykpIHtcclxuICAgICAgICAgICAgaWYgKHJvb3QudHlwZSA9PT0gJ2FycmF5Jykge1xyXG4gICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA6IFN5bWJvbEluZm9ybWF0aW9uW10gPSBbXTtcclxuICAgICAgICAgICAgICAgICg8UGFyc2VyLkFycmF5QVNUTm9kZT4gcm9vdCkuaXRlbXMuZm9yRWFjaCgoaXRlbSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLnR5cGUgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcm9wZXJ0eSA9ICg8UGFyc2VyLk9iamVjdEFTVE5vZGU+IGl0ZW0pLmdldEZpcnN0UHJvcGVydHkoJ2tleScpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJvcGVydHkgJiYgcHJvcGVydHkudmFsdWUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByYW5nZSA9IG1vZGVsTWlycm9yLmdldFJhbmdlRnJvbU9mZnNldEFuZExlbmd0aChpdGVtLnN0YXJ0LCBpdGVtLmVuZCAtIGl0ZW0uc3RhcnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHByb3BlcnR5LnZhbHVlLmdldFZhbHVlKCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2luZDogXCJzdHJpbmdcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbjoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmk6IHJlc291cmNlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZTogcmFuZ2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXN1bHQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmdW5jdGlvbiBjb2xsZWN0T3V0bGluZUVudHJpZXMocmVzdWx0OiBTeW1ib2xJbmZvcm1hdGlvbltdLCBub2RlOiBQYXJzZXIuQVNUTm9kZSwgY29udGFpbmVyTmFtZTogc3RyaW5nKTogU3ltYm9sSW5mb3JtYXRpb25bXSB7XHJcbiAgICAgICAgICAgIGlmIChub2RlLnR5cGUgPT09ICdhcnJheScpIHtcclxuICAgICAgICAgICAgICAgICg8UGFyc2VyLkFycmF5QVNUTm9kZT5ub2RlKS5pdGVtcy5mb3JFYWNoKChub2RlOlBhcnNlci5BU1ROb2RlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29sbGVjdE91dGxpbmVFbnRyaWVzKHJlc3VsdCwgbm9kZSwgY29udGFpbmVyTmFtZSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnR5cGUgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgb2JqZWN0Tm9kZSA9IDxQYXJzZXIuT2JqZWN0QVNUTm9kZT5ub2RlO1xyXG5cclxuICAgICAgICAgICAgICAgIG9iamVjdE5vZGUucHJvcGVydGllcy5mb3JFYWNoKChwcm9wZXJ0eTpQYXJzZXIuUHJvcGVydHlBU1ROb2RlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJhbmdlID0gbW9kZWxNaXJyb3IuZ2V0UmFuZ2VGcm9tT2Zmc2V0QW5kTGVuZ3RoKHByb3BlcnR5LnN0YXJ0LCBwcm9wZXJ0eS5lbmQgLSBwcm9wZXJ0eS5zdGFydCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlTm9kZSA9IHByb3BlcnR5LnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZU5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGNoaWxkQ29udGFpbmVyTmFtZSA9IGNvbnRhaW5lck5hbWUgPyBjb250YWluZXJOYW1lICsgJy4nICsgcHJvcGVydHkua2V5Lm5hbWUgOiBwcm9wZXJ0eS5rZXkubmFtZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogcHJvcGVydHkua2V5LmdldFZhbHVlKCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBraW5kOiBnZXRTeW1ib2xLaW5kKHZhbHVlTm9kZS50eXBlKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJpOiByZXNvdXJjZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZTogcmFuZ2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyTmFtZTogY29udGFpbmVyTmFtZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sbGVjdE91dGxpbmVFbnRyaWVzKHJlc3VsdCwgdmFsdWVOb2RlLCBjaGlsZENvbnRhaW5lck5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciByZXN1bHQgPSBjb2xsZWN0T3V0bGluZUVudHJpZXMoW10sIHJvb3QsIHZvaWQgMCk7XHJcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXN1bHQpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBmb3JtYXQocmVzb3VyY2U6IFVSSSwgcmFuZ2U6IEVkaXRvckNvbW1vbi5JUmFuZ2UsIG9wdGlvbnM6IElGb3JtYXR0aW5nT3B0aW9ucyk6IFByb21pc2U8RWRpdG9yQ29tbW9uLklTaW5nbGVFZGl0T3BlcmF0aW9uW10+IHtcclxuICAgICAgICBsZXQgbW9kZWwgPSB0aGlzLnJlc291cmNlU2VydmljZS5nZXQocmVzb3VyY2UpO1xyXG4gICAgICAgIGxldCBmb3JtYXRSYW5nZSA9IHJhbmdlID8gbW9kZWwuZ2V0T2Zmc2V0QW5kTGVuZ3RoRnJvbVJhbmdlKHJhbmdlKSA6IHZvaWQgMDtcclxuICAgICAgICBsZXQgZWRpdHMgPSBKU09ORm9ybWF0dGVyLmZvcm1hdChtb2RlbC5nZXRWYWx1ZSgpLCBmb3JtYXRSYW5nZSwgeyBpbnNlcnRTcGFjZXM6IG9wdGlvbnMuaW5zZXJ0U3BhY2VzLCB0YWJTaXplOiBvcHRpb25zLnRhYlNpemUsIGVvbDogbW9kZWwuZ2V0RU9MKCkgfSk7XHJcbiAgICAgICAgbGV0IG9wZXJhdGlvbnMgPSBlZGl0cy5tYXAoZSA9PiAoeyByYW5nZTogbW9kZWwuZ2V0UmFuZ2VGcm9tT2Zmc2V0QW5kTGVuZ3RoKGUub2Zmc2V0LCBlLmxlbmd0aCksIHRleHQ6IGUuY29udGVudCB9KSk7XHJcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShvcGVyYXRpb25zKTtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0U3ltYm9sS2luZChub2RlVHlwZTogc3RyaW5nKSB7XHJcbiAgICBzd2l0Y2ggKG5vZGVUeXBlKSB7XHJcbiAgICAgICAgY2FzZSAnb2JqZWN0JzpcclxuICAgICAgICBjYXNlICdzdHJpbmcnOlxyXG4gICAgICAgIGNhc2UgJ251bWJlcic6XHJcbiAgICAgICAgY2FzZSAnYXJyYXknOlxyXG4gICAgICAgIGNhc2UgJ2Jvb2xlYW4nOlxyXG4gICAgICAgICAgICByZXR1cm4gbm9kZVR5cGU7XHJcbiAgICAgICAgZGVmYXVsdDogLy8gJ251bGwnXHJcbiAgICAgICAgICAgIHJldHVybiBcInZhcmlhYmxlXCI7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgU3ltYm9sSW5mb3JtYXRpb24ge1xyXG4gICAgbmFtZTogc3RyaW5nO1xyXG4gICAgY29udGFpbmVyTmFtZT86IHN0cmluZztcclxuICAgIGtpbmQ6IHN0cmluZztcclxuICAgIGxvY2F0aW9uOiBMb2NhdGlvbjtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJRm9ybWF0dGluZ09wdGlvbnMge1xyXG4gICAgdGFiU2l6ZTpudW1iZXI7XHJcbiAgICBpbnNlcnRTcGFjZXM6Ym9vbGVhbjtcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIExvY2F0aW9uIHtcclxuICAgIHVyaTogVVJJO1xyXG4gICAgcmFuZ2U6IFtudW1iZXIsIG51bWJlcl07XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgSG92ZXIge1xyXG4gICAgaHRtbENvbnRlbnQ6IEh0bWxDb250ZW50LklIVE1MQ29udGVudEVsZW1lbnRbXTtcclxuXHJcbiAgICByYW5nZTogW251bWJlciwgbnVtYmVyXTtcclxufVxyXG4iLCIndXNlIHN0cmljdCc7XG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XG4gICAgdmFyIGMgPSBhcmd1bWVudHMubGVuZ3RoLCByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYywgZDtcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XG4gICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcbn07XG52YXIgX19wYXJhbSA9ICh0aGlzICYmIHRoaXMuX19wYXJhbSkgfHwgZnVuY3Rpb24gKHBhcmFtSW5kZXgsIGRlY29yYXRvcikge1xuICAgIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0LCBrZXkpIHsgZGVjb3JhdG9yKHRhcmdldCwga2V5LCBwYXJhbUluZGV4KTsgfVxufTtcbmltcG9ydCBTZXZlcml0eSBmcm9tICcuL2NvbW1vbi9zZXZlcml0eSc7XG5pbXBvcnQgUGFyc2VyIGZyb20gJy4vcGFyc2VyL2pzb25QYXJzZXInO1xuaW1wb3J0IEpTT05Gb3JtYXR0ZXIgZnJvbSAnLi9jb21tb24vanNvbkZvcm1hdHRlcic7XG5pbXBvcnQgU2NoZW1hU2VydmljZSBmcm9tICcuL2pzb25TY2hlbWFTZXJ2aWNlJztcbmltcG9ydCBKU09OSW50ZWxsaXNlbnNlIGZyb20gJy4vanNvbkludGVsbGlzZW5zZSc7XG5pbXBvcnQgU3RyaW5ncyBmcm9tICcuL2NvbW1vbi9zdHJpbmdzJztcbmltcG9ydCBQcm9qZWN0SlNPTkNvbnRyaWJ1dGlvbiBmcm9tICcuL2NvbnRyaWJ1dGlvbnMvcHJvamVjdEpTT05Db250cmlidXRpb24nO1xuaW1wb3J0IFBhY2thZ2VKU09OQ29udHJpYnV0aW9uIGZyb20gJy4vY29udHJpYnV0aW9ucy9wYWNrYWdlSlNPTkNvbnRyaWJ1dGlvbic7XG5pbXBvcnQgQm93ZXJKU09OQ29udHJpYnV0aW9uIGZyb20gJy4vY29udHJpYnV0aW9ucy9ib3dlckpTT05Db250cmlidXRpb24nO1xuaW1wb3J0IEdsb2JQYXR0ZXJuQ29udHJpYnV0aW9uIGZyb20gJy4vY29udHJpYnV0aW9ucy9nbG9iUGF0dGVybkNvbnRyaWJ1dGlvbic7XG5leHBvcnQgY2xhc3MgSlNPTldvcmtlciB7XG4gICAgY29uc3RydWN0b3IobW9kZUlkLCByZXNvdXJjZVNlcnZpY2UsIG1hcmtlclNlcnZpY2UsIGNvbnRleHRTZXJ2aWNlLCBpbnN0YW50aWF0aW9uU2VydmljZSkge1xuICAgICAgICB0aGlzLl9tb2RlSWQgPSBtb2RlSWQ7XG4gICAgICAgIHRoaXMucmVzb3VyY2VTZXJ2aWNlID0gcmVzb3VyY2VTZXJ2aWNlO1xuICAgICAgICB0aGlzLm1hcmtlclNlcnZpY2UgPSBtYXJrZXJTZXJ2aWNlO1xuICAgICAgICB0aGlzLl92YWxpZGF0aW9uSGVscGVyID0gbmV3IFZhbGlkYXRpb25IZWxwZXIodGhpcy5yZXNvdXJjZVNlcnZpY2UsIHRoaXMuX21vZGVJZCwgKHRvVmFsaWRhdGUpID0+IHRoaXMuZG9WYWxpZGF0ZSh0b1ZhbGlkYXRlKSk7XG4gICAgICAgIHRoaXMuY29udGV4dFNlcnZpY2UgPSBjb250ZXh0U2VydmljZTtcbiAgICAgICAgdGhpcy5zY2hlbWFTZXJ2aWNlID0gaW5zdGFudGlhdGlvblNlcnZpY2UuY3JlYXRlSW5zdGFuY2UoU2NoZW1hU2VydmljZS5KU09OU2NoZW1hU2VydmljZSk7XG4gICAgICAgIHRoaXMuY29udHJpYnV0aW9ucyA9IFtcbiAgICAgICAgICAgIGluc3RhbnRpYXRpb25TZXJ2aWNlLmNyZWF0ZUluc3RhbmNlKFByb2plY3RKU09OQ29udHJpYnV0aW9uLlByb2plY3RKU09OQ29udHJpYnV0aW9uKSxcbiAgICAgICAgICAgIGluc3RhbnRpYXRpb25TZXJ2aWNlLmNyZWF0ZUluc3RhbmNlKFBhY2thZ2VKU09OQ29udHJpYnV0aW9uLlBhY2thZ2VKU09OQ29udHJpYnV0aW9uKSxcbiAgICAgICAgICAgIGluc3RhbnRpYXRpb25TZXJ2aWNlLmNyZWF0ZUluc3RhbmNlKEJvd2VySlNPTkNvbnRyaWJ1dGlvbi5Cb3dlckpTT05Db250cmlidXRpb24pLFxuICAgICAgICAgICAgaW5zdGFudGlhdGlvblNlcnZpY2UuY3JlYXRlSW5zdGFuY2UoR2xvYlBhdHRlcm5Db250cmlidXRpb24uR2xvYlBhdHRlcm5Db250cmlidXRpb24pXG4gICAgICAgIF07XG4gICAgICAgIHRoaXMuanNvbkludGVsbGlzZW5zZSA9IG5ldyBKU09OSW50ZWxsaXNlbnNlLkpTT05JbnRlbGxpc2VuZXNlKHRoaXMuc2NoZW1hU2VydmljZSwgdGhpcy5jb250cmlidXRpb25zKTtcbiAgICB9XG4gICAgbmF2aWdhdGVWYWx1ZVNldChyZXNvdXJjZSwgcmFuZ2UsIHVwKSB7XG4gICAgICAgIHZhciBtb2RlbE1pcnJvciA9IHRoaXMucmVzb3VyY2VTZXJ2aWNlLmdldChyZXNvdXJjZSk7XG4gICAgICAgIHZhciBvZmZzZXQgPSBtb2RlbE1pcnJvci5nZXRPZmZzZXRGcm9tUG9zaXRpb24oeyBsaW5lTnVtYmVyOiByYW5nZS5zdGFydExpbmVOdW1iZXIsIGNvbHVtbjogcmFuZ2Uuc3RhcnRDb2x1bW4gfSk7XG4gICAgICAgIHZhciBwYXJzZXIgPSBuZXcgUGFyc2VyLkpTT05QYXJzZXIoKTtcbiAgICAgICAgdmFyIGNvbmZpZyA9IG5ldyBQYXJzZXIuSlNPTkRvY3VtZW50Q29uZmlnKCk7XG4gICAgICAgIGNvbmZpZy5pZ25vcmVEYW5nbGluZ0NvbW1hID0gdHJ1ZTtcbiAgICAgICAgdmFyIGRvYyA9IHBhcnNlci5wYXJzZShtb2RlbE1pcnJvci5nZXRWYWx1ZSgpLCBjb25maWcpO1xuICAgICAgICB2YXIgbm9kZSA9IGRvYy5nZXROb2RlRnJvbU9mZnNldEVuZEluY2x1c2l2ZShvZmZzZXQpO1xuICAgICAgICBpZiAobm9kZSAmJiAobm9kZS50eXBlID09PSAnc3RyaW5nJyB8fCBub2RlLnR5cGUgPT09ICdudW1iZXInIHx8IG5vZGUudHlwZSA9PT0gJ2Jvb2xlYW4nIHx8IG5vZGUudHlwZSA9PT0gJ251bGwnKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2NoZW1hU2VydmljZS5nZXRTY2hlbWFGb3JSZXNvdXJjZShyZXNvdXJjZS50b1N0cmluZygpLCBkb2MpLnRoZW4oKHNjaGVtYSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChzY2hlbWEpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHByb3Bvc2FscyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICB2YXIgcHJvcG9zZWQgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbGxlY3RvciA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFkZDogKHN1Z2dlc3Rpb24pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXByb3Bvc2VkW3N1Z2dlc3Rpb24udGV4dF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcG9zZWRbc3VnZ2VzdGlvbi50ZXh0XSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3Bvc2Fscy5wdXNoKHN1Z2dlc3Rpb24pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXRBc0luY29tcGxldGU6ICgpID0+IHsgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAobWVzc2FnZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihtZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5qc29uSW50ZWxsaXNlbnNlLmdldFZhbHVlU3VnZ2VzdGlvbnMocmVzb3VyY2UsIHNjaGVtYSwgZG9jLCBub2RlLnBhcmVudCwgbm9kZS5zdGFydCwgY29sbGVjdG9yKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJhbmdlID0gbW9kZWxNaXJyb3IuZ2V0UmFuZ2VGcm9tT2Zmc2V0QW5kTGVuZ3RoKG5vZGUuc3RhcnQsIG5vZGUuZW5kIC0gbm9kZS5zdGFydCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gbW9kZWxNaXJyb3IuZ2V0VmFsdWVJblJhbmdlKHJhbmdlKTtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHByb3Bvc2Fscy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFN0cmluZ3MuZXF1YWxzSWdub3JlQ2FzZShwcm9wb3NhbHNbaV0udGV4dCwgdGV4dCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dElkeCA9IGk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRJZHggPSAoaSArIDEpICUgbGVuO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dElkeCA9IGkgLSAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dElkeCA8IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRJZHggPSBsZW4gLSAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcm9wb3NhbHNbbmV4dElkeF0udGV4dCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2U6IHJhbmdlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgX2RvQ29uZmlndXJlKG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5zY2hlbWFzKSB7XG4gICAgICAgICAgICB0aGlzLnNjaGVtYVNlcnZpY2UuY2xlYXJFeHRlcm5hbFNjaGVtYXMoKTtcbiAgICAgICAgICAgIG9wdGlvbnMuc2NoZW1hcy5mb3JFYWNoKChzY2hlbWEpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoc2NoZW1hLnVybCAmJiAoc2NoZW1hLmZpbGVNYXRjaCB8fCBzY2hlbWEuc2NoZW1hKSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgdXJsID0gc2NoZW1hLnVybDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFTdHJpbmdzLnN0YXJ0c1dpdGgodXJsLCAnaHR0cDovLycpICYmICFTdHJpbmdzLnN0YXJ0c1dpdGgodXJsLCAnaHR0cHM6Ly8nKSAmJiAhU3RyaW5ncy5zdGFydHNXaXRoKHVybCwgJ2ZpbGU6Ly8nKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc291cmNlVVJMID0gdGhpcy5jb250ZXh0U2VydmljZS50b1Jlc291cmNlKHVybCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzb3VyY2VVUkwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmwgPSByZXNvdXJjZVVSTC50b1N0cmluZygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICh1cmwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2NoZW1hU2VydmljZS5yZWdpc3RlckV4dGVybmFsU2NoZW1hKHVybCwgc2NoZW1hLmZpbGVNYXRjaCwgc2NoZW1hLnNjaGVtYSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoc2NoZW1hLmZpbGVQYXR0ZXJuICYmIHNjaGVtYS5zY2hlbWFQYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB1cmwgPSB0aGlzLmNvbnRleHRTZXJ2aWNlLnRvUmVzb3VyY2Uoc2NoZW1hLnNjaGVtYVBhdGgpLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwYXR0ZXJucyA9IHNjaGVtYS5maWxlUGF0dGVybiA/IFtzY2hlbWEuZmlsZVBhdHRlcm5dIDogW107XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2NoZW1hU2VydmljZS5yZWdpc3RlckV4dGVybmFsU2NoZW1hKHVybCwgcGF0dGVybnMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3ZhbGlkYXRpb25IZWxwZXIudHJpZ2dlckR1ZVRvQ29uZmlndXJhdGlvbkNoYW5nZSgpO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHZvaWQgMCk7XG4gICAgfVxuICAgIHNldFNjaGVtYUNvbnRyaWJ1dGlvbnMoY29udHJpYnV0aW9ucykge1xuICAgICAgICB0aGlzLnNjaGVtYVNlcnZpY2Uuc2V0U2NoZW1hQ29udHJpYnV0aW9ucyhjb250cmlidXRpb25zKTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0cnVlKTtcbiAgICB9XG4gICAgZW5hYmxlVmFsaWRhdG9yKCkge1xuICAgICAgICB0aGlzLl92YWxpZGF0aW9uSGVscGVyLmVuYWJsZSgpO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG51bGwpO1xuICAgIH1cbiAgICBkb1ZhbGlkYXRlKHJlc291cmNlcykge1xuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc291cmNlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgdGhpcy5kb1ZhbGlkYXRlMShyZXNvdXJjZXNbaV0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIGRvVmFsaWRhdGUxKHJlc291cmNlKSB7XG4gICAgICAgIHZhciBtb2RlbE1pcnJvciA9IHRoaXMucmVzb3VyY2VTZXJ2aWNlLmdldChyZXNvdXJjZSk7XG4gICAgICAgIHZhciBwYXJzZXIgPSBuZXcgUGFyc2VyLkpTT05QYXJzZXIoKTtcbiAgICAgICAgdmFyIGNvbnRlbnQgPSBtb2RlbE1pcnJvci5nZXRWYWx1ZSgpO1xuICAgICAgICBpZiAoY29udGVudC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB2YXIgcmVzdWx0ID0gcGFyc2VyLnBhcnNlKGNvbnRlbnQpO1xuICAgICAgICB0aGlzLnNjaGVtYVNlcnZpY2UuZ2V0U2NoZW1hRm9yUmVzb3VyY2UocmVzb3VyY2UudG9TdHJpbmcoKSwgcmVzdWx0KS50aGVuKChzY2hlbWEpID0+IHtcbiAgICAgICAgICAgIGlmIChzY2hlbWEpIHtcbiAgICAgICAgICAgICAgICBpZiAoc2NoZW1hLmVycm9ycy5sZW5ndGggJiYgcmVzdWx0LnJvb3QpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5ID0gcmVzdWx0LnJvb3QudHlwZSA9PT0gJ29iamVjdCcgPyByZXN1bHQucm9vdC5nZXRGaXJzdFByb3BlcnR5KCckc2NoZW1hJykgOiBudWxsO1xuICAgICAgICAgICAgICAgICAgICBpZiAocHJvcGVydHkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBub2RlID0gcHJvcGVydHkudmFsdWUgfHwgcHJvcGVydHk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQud2FybmluZ3MucHVzaCh7IGxvY2F0aW9uOiB7IHN0YXJ0OiBub2RlLnN0YXJ0LCBlbmQ6IG5vZGUuZW5kIH0sIG1lc3NhZ2U6IHNjaGVtYS5lcnJvcnNbMF0gfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQud2FybmluZ3MucHVzaCh7IGxvY2F0aW9uOiB7IHN0YXJ0OiByZXN1bHQucm9vdC5zdGFydCwgZW5kOiByZXN1bHQucm9vdC5zdGFydCArIDEgfSwgbWVzc2FnZTogc2NoZW1hLmVycm9yc1swXSB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnZhbGlkYXRlKHNjaGVtYS5zY2hlbWEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBhZGRlZCA9IHt9O1xuICAgICAgICAgICAgdmFyIG1hcmtlckRhdGEgPSBbXTtcbiAgICAgICAgICAgIHJlc3VsdC5lcnJvcnMuY29uY2F0KHJlc3VsdC53YXJuaW5ncykuZm9yRWFjaCgoZXJyb3IsIGlkeCkgPT4ge1xuICAgICAgICAgICAgICAgIHZhciBzaWduYXR1cmUgPSBlcnJvci5sb2NhdGlvbi5zdGFydCArICcgJyArIGVycm9yLmxvY2F0aW9uLmVuZCArICcgJyArIGVycm9yLm1lc3NhZ2U7XG4gICAgICAgICAgICAgICAgaWYgKCFhZGRlZFtzaWduYXR1cmVdKSB7XG4gICAgICAgICAgICAgICAgICAgIGFkZGVkW3NpZ25hdHVyZV0gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB2YXIgc3RhcnRQb3NpdGlvbiA9IG1vZGVsTWlycm9yLmdldFBvc2l0aW9uRnJvbU9mZnNldChlcnJvci5sb2NhdGlvbi5zdGFydCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBlbmRQb3NpdGlvbiA9IG1vZGVsTWlycm9yLmdldFBvc2l0aW9uRnJvbU9mZnNldChlcnJvci5sb2NhdGlvbi5lbmQpO1xuICAgICAgICAgICAgICAgICAgICBtYXJrZXJEYXRhLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldmVyaXR5OiBpZHggPj0gcmVzdWx0LmVycm9ycy5sZW5ndGggPyBTZXZlcml0eS5XYXJuaW5nIDogU2V2ZXJpdHkuRXJyb3IsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGFydExpbmVOdW1iZXI6IHN0YXJ0UG9zaXRpb24ubGluZU51bWJlcixcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0Q29sdW1uOiBzdGFydFBvc2l0aW9uLmNvbHVtbixcbiAgICAgICAgICAgICAgICAgICAgICAgIGVuZExpbmVOdW1iZXI6IGVuZFBvc2l0aW9uLmxpbmVOdW1iZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICBlbmRDb2x1bW46IGVuZFBvc2l0aW9uLmNvbHVtblxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMubWFya2VyU2VydmljZS5jaGFuZ2VPbmUodGhpcy5fbW9kZUlkLCByZXNvdXJjZSwgbWFya2VyRGF0YSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBwcm92aWRlQ29tcGxldGlvbkl0ZW1zKHJlc291cmNlLCBwb3NpdGlvbikge1xuICAgICAgICByZXR1cm4gdGhpcy5kb1N1Z2dlc3QocmVzb3VyY2UsIHBvc2l0aW9uKS50aGVuKHZhbHVlID0+IGZpbHRlclN1Z2dlc3Rpb25zKHZhbHVlKSk7XG4gICAgfVxuICAgIGRvU3VnZ2VzdChyZXNvdXJjZSwgcG9zaXRpb24pIHtcbiAgICAgICAgdmFyIG1vZGVsTWlycm9yID0gdGhpcy5yZXNvdXJjZVNlcnZpY2UuZ2V0KHJlc291cmNlKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuanNvbkludGVsbGlzZW5zZS5kb1N1Z2dlc3QocmVzb3VyY2UsIG1vZGVsTWlycm9yLCBwb3NpdGlvbik7XG4gICAgfVxuICAgIHByb3ZpZGVIb3ZlcihyZXNvdXJjZSwgcG9zaXRpb24pIHtcbiAgICAgICAgdmFyIG1vZGVsTWlycm9yID0gdGhpcy5yZXNvdXJjZVNlcnZpY2UuZ2V0KHJlc291cmNlKTtcbiAgICAgICAgdmFyIHBhcnNlciA9IG5ldyBQYXJzZXIuSlNPTlBhcnNlcigpO1xuICAgICAgICB2YXIgZG9jID0gcGFyc2VyLnBhcnNlKG1vZGVsTWlycm9yLmdldFZhbHVlKCkpO1xuICAgICAgICB2YXIgb2Zmc2V0ID0gbW9kZWxNaXJyb3IuZ2V0T2Zmc2V0RnJvbVBvc2l0aW9uKHBvc2l0aW9uKTtcbiAgICAgICAgdmFyIG5vZGUgPSBkb2MuZ2V0Tm9kZUZyb21PZmZzZXQob2Zmc2V0KTtcbiAgICAgICAgdmFyIG9yaWdpbmFsTm9kZSA9IG5vZGU7XG4gICAgICAgIGlmIChub2RlICYmIG5vZGUudHlwZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIHZhciBzdHJpbmdOb2RlID0gbm9kZTtcbiAgICAgICAgICAgIGlmIChzdHJpbmdOb2RlLmlzS2V5KSB7XG4gICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5Tm9kZSA9IG5vZGUucGFyZW50O1xuICAgICAgICAgICAgICAgIG5vZGUgPSBwcm9wZXJ0eU5vZGUudmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFub2RlKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG51bGwpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLnNjaGVtYVNlcnZpY2UuZ2V0U2NoZW1hRm9yUmVzb3VyY2UocmVzb3VyY2UudG9TdHJpbmcoKSwgZG9jKS50aGVuKChzY2hlbWEpID0+IHtcbiAgICAgICAgICAgIGlmIChzY2hlbWEpIHtcbiAgICAgICAgICAgICAgICB2YXIgbWF0Y2hpbmdTY2hlbWFzID0gW107XG4gICAgICAgICAgICAgICAgZG9jLnZhbGlkYXRlKHNjaGVtYS5zY2hlbWEsIG1hdGNoaW5nU2NoZW1hcywgbm9kZS5zdGFydCk7XG4gICAgICAgICAgICAgICAgdmFyIGRlc2NyaXB0aW9uID0gbnVsbDtcbiAgICAgICAgICAgICAgICB2YXIgY29udHJpYnV0b25JZCA9IG51bGw7XG4gICAgICAgICAgICAgICAgbWF0Y2hpbmdTY2hlbWFzLmV2ZXJ5KChzKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLm5vZGUgPT09IG5vZGUgJiYgIXMuaW52ZXJ0ZWQgJiYgcy5zY2hlbWEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gZGVzY3JpcHRpb24gfHwgcy5zY2hlbWEuZGVzY3JpcHRpb247XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250cmlidXRvbklkID0gY29udHJpYnV0b25JZCB8fCBzLnNjaGVtYS5pZDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB2YXIgbG9jYXRpb24gPSBub2RlLmdldE5vZGVMb2NhdGlvbigpO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmNvbnRyaWJ1dGlvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRyaWJ1dGlvbiA9IHRoaXMuY29udHJpYnV0aW9uc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHByb21pc2UgPSBjb250cmlidXRpb24uZ2V0SW5mb0NvbnRyaWJ1dGlvbihyZXNvdXJjZSwgbG9jYXRpb24pO1xuICAgICAgICAgICAgICAgICAgICBpZiAocHJvbWlzZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHByb21pc2UudGhlbigoaHRtbENvbnRlbnQpID0+IHsgcmV0dXJuIHRoaXMuY3JlYXRlSW5mb1Jlc3VsdChodG1sQ29udGVudCwgb3JpZ2luYWxOb2RlLCBtb2RlbE1pcnJvcik7IH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChkZXNjcmlwdGlvbikge1xuICAgICAgICAgICAgICAgICAgICB2YXIgaHRtbENvbnRlbnQgPSBbeyBjbGFzc05hbWU6ICdkb2N1bWVudGF0aW9uJywgdGV4dDogZGVzY3JpcHRpb24gfV07XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUluZm9SZXN1bHQoaHRtbENvbnRlbnQsIG9yaWdpbmFsTm9kZSwgbW9kZWxNaXJyb3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgY3JlYXRlSW5mb1Jlc3VsdChodG1sQ29udGVudCwgbm9kZSwgbW9kZWxNaXJyb3IpIHtcbiAgICAgICAgdmFyIHJhbmdlID0gbW9kZWxNaXJyb3IuZ2V0UmFuZ2VGcm9tT2Zmc2V0QW5kTGVuZ3RoKG5vZGUuc3RhcnQsIG5vZGUuZW5kIC0gbm9kZS5zdGFydCk7XG4gICAgICAgIHZhciByZXN1bHQgPSB7XG4gICAgICAgICAgICBodG1sQ29udGVudDogaHRtbENvbnRlbnQsXG4gICAgICAgICAgICByYW5nZTogcmFuZ2VcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG4gICAgcHJvdmlkZURvY3VtZW50U3ltYm9scyhyZXNvdXJjZSkge1xuICAgICAgICB2YXIgbW9kZWxNaXJyb3IgPSB0aGlzLnJlc291cmNlU2VydmljZS5nZXQocmVzb3VyY2UpO1xuICAgICAgICB2YXIgcGFyc2VyID0gbmV3IFBhcnNlci5KU09OUGFyc2VyKCk7XG4gICAgICAgIHZhciBkb2MgPSBwYXJzZXIucGFyc2UobW9kZWxNaXJyb3IuZ2V0VmFsdWUoKSk7XG4gICAgICAgIHZhciByb290ID0gZG9jLnJvb3Q7XG4gICAgICAgIGlmICghcm9vdCkge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShudWxsKTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgcmVzb3VyY2VTdHJpbmcgPSByZXNvdXJjZS50b1N0cmluZygpO1xuICAgICAgICBpZiAoKHJlc291cmNlU3RyaW5nID09PSAndnNjb2RlOi8vZGVmYXVsdHNldHRpbmdzL2tleWJpbmRpbmdzLmpzb24nKSB8fCBTdHJpbmdzLmVuZHNXaXRoKHJlc291cmNlU3RyaW5nLnRvTG93ZXJDYXNlKCksICcvdXNlci9rZXliaW5kaW5ncy5qc29uJykpIHtcbiAgICAgICAgICAgIGlmIChyb290LnR5cGUgPT09ICdhcnJheScpIHtcbiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107XG4gICAgICAgICAgICAgICAgcm9vdC5pdGVtcy5mb3JFYWNoKChpdGVtKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLnR5cGUgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJvcGVydHkgPSBpdGVtLmdldEZpcnN0UHJvcGVydHkoJ2tleScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5ICYmIHByb3BlcnR5LnZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJhbmdlID0gbW9kZWxNaXJyb3IuZ2V0UmFuZ2VGcm9tT2Zmc2V0QW5kTGVuZ3RoKGl0ZW0uc3RhcnQsIGl0ZW0uZW5kIC0gaXRlbS5zdGFydCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBwcm9wZXJ0eS52YWx1ZS5nZXRWYWx1ZSgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBraW5kOiBcInN0cmluZ1wiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbjoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJpOiByZXNvdXJjZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlOiByYW5nZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZnVuY3Rpb24gY29sbGVjdE91dGxpbmVFbnRyaWVzKHJlc3VsdCwgbm9kZSwgY29udGFpbmVyTmFtZSkge1xuICAgICAgICAgICAgaWYgKG5vZGUudHlwZSA9PT0gJ2FycmF5Jykge1xuICAgICAgICAgICAgICAgIG5vZGUuaXRlbXMuZm9yRWFjaCgobm9kZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb2xsZWN0T3V0bGluZUVudHJpZXMocmVzdWx0LCBub2RlLCBjb250YWluZXJOYW1lKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKG5vZGUudHlwZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgICAgICB2YXIgb2JqZWN0Tm9kZSA9IG5vZGU7XG4gICAgICAgICAgICAgICAgb2JqZWN0Tm9kZS5wcm9wZXJ0aWVzLmZvckVhY2goKHByb3BlcnR5KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHZhciByYW5nZSA9IG1vZGVsTWlycm9yLmdldFJhbmdlRnJvbU9mZnNldEFuZExlbmd0aChwcm9wZXJ0eS5zdGFydCwgcHJvcGVydHkuZW5kIC0gcHJvcGVydHkuc3RhcnQpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWVOb2RlID0gcHJvcGVydHkudmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZU5vZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBjaGlsZENvbnRhaW5lck5hbWUgPSBjb250YWluZXJOYW1lID8gY29udGFpbmVyTmFtZSArICcuJyArIHByb3BlcnR5LmtleS5uYW1lIDogcHJvcGVydHkua2V5Lm5hbWU7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogcHJvcGVydHkua2V5LmdldFZhbHVlKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAga2luZDogZ2V0U3ltYm9sS2luZCh2YWx1ZU5vZGUudHlwZSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRpb246IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJpOiByZXNvdXJjZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2U6IHJhbmdlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyTmFtZTogY29udGFpbmVyTmFtZVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xsZWN0T3V0bGluZUVudHJpZXMocmVzdWx0LCB2YWx1ZU5vZGUsIGNoaWxkQ29udGFpbmVyTmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHJlc3VsdCA9IGNvbGxlY3RPdXRsaW5lRW50cmllcyhbXSwgcm9vdCwgdm9pZCAwKTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShyZXN1bHQpO1xuICAgIH1cbiAgICBmb3JtYXQocmVzb3VyY2UsIHJhbmdlLCBvcHRpb25zKSB7XG4gICAgICAgIGxldCBtb2RlbCA9IHRoaXMucmVzb3VyY2VTZXJ2aWNlLmdldChyZXNvdXJjZSk7XG4gICAgICAgIGxldCBmb3JtYXRSYW5nZSA9IHJhbmdlID8gbW9kZWwuZ2V0T2Zmc2V0QW5kTGVuZ3RoRnJvbVJhbmdlKHJhbmdlKSA6IHZvaWQgMDtcbiAgICAgICAgbGV0IGVkaXRzID0gSlNPTkZvcm1hdHRlci5mb3JtYXQobW9kZWwuZ2V0VmFsdWUoKSwgZm9ybWF0UmFuZ2UsIHsgaW5zZXJ0U3BhY2VzOiBvcHRpb25zLmluc2VydFNwYWNlcywgdGFiU2l6ZTogb3B0aW9ucy50YWJTaXplLCBlb2w6IG1vZGVsLmdldEVPTCgpIH0pO1xuICAgICAgICBsZXQgb3BlcmF0aW9ucyA9IGVkaXRzLm1hcChlID0+ICh7IHJhbmdlOiBtb2RlbC5nZXRSYW5nZUZyb21PZmZzZXRBbmRMZW5ndGgoZS5vZmZzZXQsIGUubGVuZ3RoKSwgdGV4dDogZS5jb250ZW50IH0pKTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShvcGVyYXRpb25zKTtcbiAgICB9XG59XG5KU09OV29ya2VyID0gX19kZWNvcmF0ZShbXG4gICAgX19wYXJhbSgxLCBJUmVzb3VyY2VTZXJ2aWNlKSxcbiAgICBfX3BhcmFtKDIsIElNYXJrZXJTZXJ2aWNlKSxcbiAgICBfX3BhcmFtKDMsIElXb3Jrc3BhY2VDb250ZXh0U2VydmljZSksXG4gICAgX19wYXJhbSg0LCBJSW5zdGFudGlhdGlvblNlcnZpY2UpXG5dLCBKU09OV29ya2VyKTtcbmZ1bmN0aW9uIGdldFN5bWJvbEtpbmQobm9kZVR5cGUpIHtcbiAgICBzd2l0Y2ggKG5vZGVUeXBlKSB7XG4gICAgICAgIGNhc2UgJ29iamVjdCc6XG4gICAgICAgIGNhc2UgJ3N0cmluZyc6XG4gICAgICAgIGNhc2UgJ251bWJlcic6XG4gICAgICAgIGNhc2UgJ2FycmF5JzpcbiAgICAgICAgY2FzZSAnYm9vbGVhbic6XG4gICAgICAgICAgICByZXR1cm4gbm9kZVR5cGU7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICByZXR1cm4gXCJ2YXJpYWJsZVwiO1xuICAgIH1cbn1cbmV4cG9ydCBjbGFzcyBMb2NhdGlvbiB7XG59XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
