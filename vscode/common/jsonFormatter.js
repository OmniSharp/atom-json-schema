'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.applyEdit = applyEdit;
exports.applyEdits = applyEdits;
exports.format = format;

var _json = require('./json');

var _json2 = _interopRequireDefault(_json);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function applyEdit(text, edit) {
    return text.substring(0, edit.offset) + edit.content + text.substring(edit.offset + edit.length);
}
function applyEdits(text, edits) {
    for (var i = edits.length - 1; i >= 0; i--) {
        text = applyEdit(text, edits[i]);
    }
    return text;
}
function format(documentText, range, options) {
    var initialIndentLevel = void 0;
    var value = void 0;
    var rangeStart = void 0;
    var rangeEnd = void 0;
    if (range) {
        rangeStart = range.offset;
        rangeEnd = rangeStart + range.length;
        while (rangeStart > 0 && !isEOL(documentText, rangeStart - 1)) {
            rangeStart--;
        }
        var _scanner = _json2.default.createScanner(documentText, true);
        _scanner.setPosition(rangeEnd);
        _scanner.scan();
        rangeEnd = _scanner.getPosition();
        value = documentText.substring(rangeStart, rangeEnd);
        initialIndentLevel = computeIndentLevel(value, 0, options);
    } else {
        value = documentText;
        rangeStart = 0;
        rangeEnd = documentText.length;
        initialIndentLevel = 0;
    }
    var eol = getEOL(options, documentText);
    var lineBreak = false;
    var indentLevel = 0;
    var indentValue = void 0;
    if (options.insertSpaces) {
        indentValue = repeat(' ', options.tabSize);
    } else {
        indentValue = '\t';
    }
    var scanner = _json2.default.createScanner(value, false);
    function newLineAndIndent() {
        return eol + repeat(indentValue, initialIndentLevel + indentLevel);
    }
    function scanNext() {
        var token = scanner.scan();
        lineBreak = false;
        while (token === _json2.default.SyntaxKind.Trivia || token === _json2.default.SyntaxKind.LineBreakTrivia) {
            lineBreak = lineBreak || token === _json2.default.SyntaxKind.LineBreakTrivia;
            token = scanner.scan();
        }
        return token;
    }
    var editOperations = [];
    function addEdit(text, startOffset, endOffset) {
        if (documentText.substring(startOffset, endOffset) !== text) {
            editOperations.push({ offset: startOffset, length: endOffset - startOffset, content: text });
        }
    }
    var firstToken = scanNext();
    if (firstToken !== _json2.default.SyntaxKind.EOF) {
        var firstTokenStart = scanner.getTokenOffset() + rangeStart;
        var initialIndent = repeat(indentValue, initialIndentLevel);
        addEdit(initialIndent, rangeStart, firstTokenStart);
    }
    while (firstToken !== _json2.default.SyntaxKind.EOF) {
        var firstTokenEnd = scanner.getTokenOffset() + scanner.getTokenLength() + rangeStart;
        var secondToken = scanNext();
        var replaceContent = '';
        while (!lineBreak && (secondToken === _json2.default.SyntaxKind.LineCommentTrivia || secondToken === _json2.default.SyntaxKind.BlockCommentTrivia)) {
            var commentTokenStart = scanner.getTokenOffset() + rangeStart;
            addEdit(' ', firstTokenEnd, commentTokenStart);
            firstTokenEnd = scanner.getTokenOffset() + scanner.getTokenLength() + rangeStart;
            replaceContent = secondToken === _json2.default.SyntaxKind.LineCommentTrivia ? newLineAndIndent() : '';
            secondToken = scanNext();
        }
        if (secondToken === _json2.default.SyntaxKind.CloseBraceToken) {
            if (firstToken !== _json2.default.SyntaxKind.OpenBraceToken) {
                indentLevel--;
                replaceContent = newLineAndIndent();
            }
        } else if (secondToken === _json2.default.SyntaxKind.CloseBracketToken) {
            if (firstToken !== _json2.default.SyntaxKind.OpenBracketToken) {
                indentLevel--;
                replaceContent = newLineAndIndent();
            }
        } else if (secondToken !== _json2.default.SyntaxKind.EOF) {
            switch (firstToken) {
                case _json2.default.SyntaxKind.OpenBracketToken:
                case _json2.default.SyntaxKind.OpenBraceToken:
                    indentLevel++;
                    replaceContent = newLineAndIndent();
                    break;
                case _json2.default.SyntaxKind.CommaToken:
                case _json2.default.SyntaxKind.LineCommentTrivia:
                    replaceContent = newLineAndIndent();
                    break;
                case _json2.default.SyntaxKind.BlockCommentTrivia:
                    if (lineBreak) {
                        replaceContent = newLineAndIndent();
                    } else {
                        replaceContent = ' ';
                    }
                    break;
                case _json2.default.SyntaxKind.ColonToken:
                    replaceContent = ' ';
                    break;
                case _json2.default.SyntaxKind.NullKeyword:
                case _json2.default.SyntaxKind.TrueKeyword:
                case _json2.default.SyntaxKind.FalseKeyword:
                case _json2.default.SyntaxKind.NumericLiteral:
                    if (secondToken === _json2.default.SyntaxKind.NullKeyword || secondToken === _json2.default.SyntaxKind.FalseKeyword || secondToken === _json2.default.SyntaxKind.NumericLiteral) {
                        replaceContent = ' ';
                    }
                    break;
            }
            if (lineBreak && (secondToken === _json2.default.SyntaxKind.LineCommentTrivia || secondToken === _json2.default.SyntaxKind.BlockCommentTrivia)) {
                replaceContent = newLineAndIndent();
            }
        }
        var secondTokenStart = scanner.getTokenOffset() + rangeStart;
        addEdit(replaceContent, firstTokenEnd, secondTokenStart);
        firstToken = secondToken;
    }
    return editOperations;
}
function repeat(s, count) {
    var result = '';
    for (var i = 0; i < count; i++) {
        result += s;
    }
    return result;
}
function computeIndentLevel(content, offset, options) {
    var i = 0;
    var nChars = 0;
    var tabSize = options.tabSize || 4;
    while (i < content.length) {
        var ch = content.charAt(i);
        if (ch === ' ') {
            nChars++;
        } else if (ch === '\t') {
            nChars += tabSize;
        } else {
            break;
        }
        i++;
    }
    return Math.floor(nChars / tabSize);
}
function getEOL(options, text) {
    for (var i = 0; i < text.length; i++) {
        var ch = text.charAt(i);
        if (ch === '\r') {
            if (i + 1 < text.length && text.charAt(i + 1) === '\n') {
                return '\r\n';
            }
            return '\r';
        } else if (ch === '\n') {
            return '\n';
        }
    }
    return options && options.eol || '\n';
}
function isEOL(text, offset) {
    return '\r\n'.indexOf(text.charAt(offset)) !== -1;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZzY29kZS9jb21tb24vanNvbkZvcm1hdHRlci50cyIsInZzY29kZS9jb21tb24vanNvbkZvcm1hdHRlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFJQTs7Ozs7UUF5QkEsUyxHQUFBLFM7UUFJQSxVLEdBQUEsVTtRQU9BLE0sR0FBQSxNOztBQ3ZDQTs7Ozs7O0FENEJBLFNBQUEsU0FBQSxDQUEwQixJQUExQixFQUF3QyxJQUF4QyxFQUFrRDtBQUNqRCxXQUFPLEtBQUssU0FBTCxDQUFlLENBQWYsRUFBa0IsS0FBSyxNQUF2QixJQUFpQyxLQUFLLE9BQXRDLEdBQWdELEtBQUssU0FBTCxDQUFlLEtBQUssTUFBTCxHQUFjLEtBQUssTUFBbEMsQ0FBdkQ7QUFDQTtBQUVELFNBQUEsVUFBQSxDQUEyQixJQUEzQixFQUF5QyxLQUF6QyxFQUFzRDtBQUNyRCxTQUFLLElBQUksSUFBSSxNQUFNLE1BQU4sR0FBZSxDQUE1QixFQUErQixLQUFLLENBQXBDLEVBQXVDLEdBQXZDLEVBQTRDO0FBQzNDLGVBQU8sVUFBVSxJQUFWLEVBQWdCLE1BQU0sQ0FBTixDQUFoQixDQUFQO0FBQ0E7QUFDRCxXQUFPLElBQVA7QUFDQTtBQUVELFNBQUEsTUFBQSxDQUF1QixZQUF2QixFQUE2QyxLQUE3QyxFQUF1RixPQUF2RixFQUFpSDtBQUNoSCxRQUFJLDJCQUFKO0FBQ0EsUUFBSSxjQUFKO0FBQ0EsUUFBSSxtQkFBSjtBQUNBLFFBQUksaUJBQUo7QUFDQSxRQUFJLEtBQUosRUFBVztBQUNWLHFCQUFhLE1BQU0sTUFBbkI7QUFDQSxtQkFBVyxhQUFhLE1BQU0sTUFBOUI7QUFDQSxlQUFPLGFBQWEsQ0FBYixJQUFrQixDQUFDLE1BQU0sWUFBTixFQUFvQixhQUFhLENBQWpDLENBQTFCLEVBQStEO0FBQzlEO0FBQ0E7QUFDRCxZQUFJLFdBQVUsZUFBSyxhQUFMLENBQW1CLFlBQW5CLEVBQWlDLElBQWpDLENBQWQ7QUFDQSxpQkFBUSxXQUFSLENBQW9CLFFBQXBCO0FBQ0Es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QUwsQ0FBWSxDQUFaLENBQVQ7QUFDQSxZQUFJLE9BQU8sSUFBWCxFQUFpQjtBQUNoQixnQkFBSSxJQUFJLENBQUosR0FBUSxLQUFLLE1BQWIsSUFBdUIsS0FBSyxNQUFMLENBQVksSUFBRSxDQUFkLE1BQXFCLElBQWhELEVBQXNEO0FBQ3JELHVCQUFPLE1BQVA7QUFDQTtBQUNELG1CQUFPLElBQVA7QUFDQSxTQUxELE1BS08sSUFBSSxPQUFPLElBQVgsRUFBaUI7QUFDdkIsbUJBQU8sSUFBUDtBQUNBO0FBQ0Q7QUFDRCxXQUFRLFdBQVcsUUFBUSxHQUFwQixJQUE0QixJQUFuQztBQUNBO0FBRUQsU0FBQSxLQUFBLENBQWUsSUFBZixFQUE2QixNQUE3QixFQUEyQztBQUMxQyxXQUFPLE9BQU8sT0FBUCxDQUFlLEtBQUssTUFBTCxDQUFZLE1BQVosQ0FBZixNQUF3QyxDQUFDLENBQWhEO0FBQ0EiLCJmaWxlIjoidnNjb2RlL2NvbW1vbi9qc29uRm9ybWF0dGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuICogIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4gKiAgTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLiBTZWUgTGljZW5zZS50eHQgaW4gdGhlIHByb2plY3Qgcm9vdCBmb3IgbGljZW5zZSBpbmZvcm1hdGlvbi5cclxuICotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovXHJcbid1c2Ugc3RyaWN0JztcclxuXHJcbmltcG9ydCBKc29uIGZyb20gJy4vanNvbic7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEZvcm1hdHRpbmdPcHRpb25zIHtcclxuXHQvKipcclxuXHQgKiBJZiBpbmRlbnRhdGlvbiBpcyBiYXNlZCBvbiBzcGFjZXMgKGBpbnNlcnRTcGFjZXNgID0gdHJ1ZSksIHRoZW4gd2hhdCBpcyB0aGUgbnVtYmVyIG9mIHNwYWNlcyB0aGF0IG1ha2UgYW4gaW5kZW50P1xyXG5cdCAqL1xyXG5cdHRhYlNpemU6IG51bWJlcjtcclxuXHQvKipcclxuXHQgKiBJcyBpbmRlbnRhdGlvbiBiYXNlZCBvbiBzcGFjZXM/XHJcblx0ICovXHJcblx0aW5zZXJ0U3BhY2VzOiBib29sZWFuO1xyXG5cdC8qKlxyXG5cdCAqIFRoZSBkZWZhdWx0IGVuZCBvZiBsaW5lIGxpbmUgY2hhcmFjdGVyXHJcblx0ICovXHJcblx0ZW9sOiBzdHJpbmc7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRWRpdCB7XHJcblx0b2Zmc2V0OiBudW1iZXI7XHJcblx0bGVuZ3RoOiBudW1iZXI7XHJcblx0Y29udGVudDogc3RyaW5nO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gYXBwbHlFZGl0KHRleHQ6IHN0cmluZywgZWRpdDogRWRpdCkgOiBzdHJpbmcge1xyXG5cdHJldHVybiB0ZXh0LnN1YnN0cmluZygwLCBlZGl0Lm9mZnNldCkgKyBlZGl0LmNvbnRlbnQgKyB0ZXh0LnN1YnN0cmluZyhlZGl0Lm9mZnNldCArIGVkaXQubGVuZ3RoKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGFwcGx5RWRpdHModGV4dDogc3RyaW5nLCBlZGl0czogRWRpdFtdKSA6IHN0cmluZyB7XHJcblx0Zm9yIChsZXQgaSA9IGVkaXRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XHJcblx0XHR0ZXh0ID0gYXBwbHlFZGl0KHRleHQsIGVkaXRzW2ldKTtcclxuXHR9XHJcblx0cmV0dXJuIHRleHQ7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBmb3JtYXQoZG9jdW1lbnRUZXh0OiBzdHJpbmcsIHJhbmdlOiB7IG9mZnNldDogbnVtYmVyLCBsZW5ndGg6IG51bWJlcn0sIG9wdGlvbnM6IEZvcm1hdHRpbmdPcHRpb25zKTogRWRpdFtdIHtcclxuXHRsZXQgaW5pdGlhbEluZGVudExldmVsOiBudW1iZXI7XHJcblx0bGV0IHZhbHVlOiBzdHJpbmc7XHJcblx0bGV0IHJhbmdlU3RhcnQ6IG51bWJlcjtcclxuXHRsZXQgcmFuZ2VFbmQ6IG51bWJlcjtcclxuXHRpZiAocmFuZ2UpIHtcclxuXHRcdHJhbmdlU3RhcnQgPSByYW5nZS5vZmZzZXQ7XHJcblx0XHRyYW5nZUVuZCA9IHJhbmdlU3RhcnQgKyByYW5nZS5sZW5ndGg7XHJcblx0XHR3aGlsZSAocmFuZ2VTdGFydCA+IDAgJiYgIWlzRU9MKGRvY3VtZW50VGV4dCwgcmFuZ2VTdGFydCAtIDEpKSB7XHJcblx0XHRcdHJhbmdlU3RhcnQtLTtcclxuXHRcdH1cclxuXHRcdGxldCBzY2FubmVyID0gSnNvbi5jcmVhdGVTY2FubmVyKGRvY3VtZW50VGV4dCwgdHJ1ZSk7XHJcblx0XHRzY2FubmVyLnNldFBvc2l0aW9uKHJhbmdlRW5kKTtcclxuXHRcdHNjYW5uZXIuc2NhbigpO1xyXG5cdFx0cmFuZ2VFbmQgPSBzY2FubmVyLmdldFBvc2l0aW9uKCk7XHJcblxyXG5cdFx0dmFsdWUgPSBkb2N1bWVudFRleHQuc3Vic3RyaW5nKHJhbmdlU3RhcnQsIHJhbmdlRW5kKTtcclxuXHRcdGluaXRpYWxJbmRlbnRMZXZlbCA9IGNvbXB1dGVJbmRlbnRMZXZlbCh2YWx1ZSwgMCwgb3B0aW9ucyk7XHJcblx0fSBlbHNlIHtcclxuXHRcdHZhbHVlID0gZG9jdW1lbnRUZXh0O1xyXG5cdFx0cmFuZ2VTdGFydCA9IDA7XHJcblx0XHRyYW5nZUVuZCA9IGRvY3VtZW50VGV4dC5sZW5ndGg7XHJcblx0XHRpbml0aWFsSW5kZW50TGV2ZWwgPSAwO1xyXG5cdH1cclxuXHRsZXQgZW9sID0gZ2V0RU9MKG9wdGlvbnMsIGRvY3VtZW50VGV4dCk7XHJcblxyXG5cdGxldCBsaW5lQnJlYWsgPSBmYWxzZTtcclxuXHRsZXQgaW5kZW50TGV2ZWwgPSAwO1xyXG5cdGxldCBpbmRlbnRWYWx1ZTogc3RyaW5nO1xyXG5cdGlmIChvcHRpb25zLmluc2VydFNwYWNlcykge1xyXG5cdFx0aW5kZW50VmFsdWUgPSByZXBlYXQoJyAnLCBvcHRpb25zLnRhYlNpemUpO1xyXG5cdH0gZWxzZSB7XHJcblx0XHRpbmRlbnRWYWx1ZSA9ICdcXHQnO1xyXG5cdH1cclxuXHJcblx0bGV0IHNjYW5uZXIgPSBKc29uLmNyZWF0ZVNjYW5uZXIodmFsdWUsIGZhbHNlKTtcclxuXHJcblx0ZnVuY3Rpb24gbmV3TGluZUFuZEluZGVudCgpOiBzdHJpbmcge1xyXG5cdFx0cmV0dXJuIGVvbCArIHJlcGVhdChpbmRlbnRWYWx1ZSwgaW5pdGlhbEluZGVudExldmVsICsgaW5kZW50TGV2ZWwpO1xyXG5cdH1cclxuXHRmdW5jdGlvbiBzY2FuTmV4dCgpOiBKc29uLlN5bnRheEtpbmQge1xyXG5cdFx0bGV0IHRva2VuID0gc2Nhbm5lci5zY2FuKCk7XHJcblx0XHRsaW5lQnJlYWsgPSBmYWxzZTtcclxuXHRcdHdoaWxlICh0b2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLlRyaXZpYSB8fCB0b2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkxpbmVCcmVha1RyaXZpYSkge1xyXG5cdFx0XHRsaW5lQnJlYWsgPSBsaW5lQnJlYWsgfHwgKHRva2VuID09PSBKc29uLlN5bnRheEtpbmQuTGluZUJyZWFrVHJpdmlhKTtcclxuXHRcdFx0dG9rZW4gPSBzY2FubmVyLnNjYW4oKTtcclxuXHRcdH1cclxuXHRcdHJldHVybiB0b2tlbjtcclxuXHR9XHJcblx0bGV0IGVkaXRPcGVyYXRpb25zOiBFZGl0W10gPSBbXTtcclxuXHRmdW5jdGlvbiBhZGRFZGl0KHRleHQ6IHN0cmluZywgc3RhcnRPZmZzZXQ6IG51bWJlciwgZW5kT2Zmc2V0OiBudW1iZXIpIHtcclxuXHRcdGlmIChkb2N1bWVudFRleHQuc3Vic3RyaW5nKHN0YXJ0T2Zmc2V0LCBlbmRPZmZzZXQpICE9PSB0ZXh0KSB7XHJcblx0XHRcdGVkaXRPcGVyYXRpb25zLnB1c2goeyBvZmZzZXQ6IHN0YXJ0T2Zmc2V0LCBsZW5ndGg6IGVuZE9mZnNldCAtIHN0YXJ0T2Zmc2V0LCBjb250ZW50OiB0ZXh0IH0pO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0bGV0IGZpcnN0VG9rZW4gPSBzY2FuTmV4dCgpO1xyXG5cdGlmIChmaXJzdFRva2VuICE9PSBKc29uLlN5bnRheEtpbmQuRU9GKSB7XHJcblx0XHRsZXQgZmlyc3RUb2tlblN0YXJ0ID0gc2Nhbm5lci5nZXRUb2tlbk9mZnNldCgpICsgcmFuZ2VTdGFydDtcclxuXHRcdGxldCBpbml0aWFsSW5kZW50ID0gcmVwZWF0KGluZGVudFZhbHVlLCBpbml0aWFsSW5kZW50TGV2ZWwpO1xyXG5cdFx0YWRkRWRpdChpbml0aWFsSW5kZW50LCByYW5nZVN0YXJ0LCBmaXJzdFRva2VuU3RhcnQpO1xyXG5cdH1cclxuXHJcblx0d2hpbGUgKGZpcnN0VG9rZW4gIT09IEpzb24uU3ludGF4S2luZC5FT0YpIHtcclxuXHRcdGxldCBmaXJzdFRva2VuRW5kID0gc2Nhbm5lci5nZXRUb2tlbk9mZnNldCgpICsgc2Nhbm5lci5nZXRUb2tlbkxlbmd0aCgpICsgcmFuZ2VTdGFydDtcclxuXHRcdGxldCBzZWNvbmRUb2tlbiA9IHNjYW5OZXh0KCk7XHJcblxyXG5cdFx0bGV0IHJlcGxhY2VDb250ZW50ID0gJyc7XHJcblx0XHR3aGlsZSAoIWxpbmVCcmVhayAmJiAoc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5MaW5lQ29tbWVudFRyaXZpYSB8fCBzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkJsb2NrQ29tbWVudFRyaXZpYSkpIHtcclxuXHRcdFx0Ly8gY29tbWVudHMgb24gdGhlIHNhbWUgbGluZToga2VlcCB0aGVtIG9uIHRoZSBzYW1lIGxpbmUsIGJ1dCBpZ25vcmUgdGhlbSBvdGhlcndpc2VcclxuXHRcdFx0bGV0IGNvbW1lbnRUb2tlblN0YXJ0ID0gc2Nhbm5lci5nZXRUb2tlbk9mZnNldCgpICsgcmFuZ2VTdGFydDtcclxuXHRcdFx0YWRkRWRpdCgnICcsIGZpcnN0VG9rZW5FbmQsIGNvbW1lbnRUb2tlblN0YXJ0KTtcclxuXHRcdFx0Zmlyc3RUb2tlbkVuZCA9IHNjYW5uZXIuZ2V0VG9rZW5PZmZzZXQoKSArIHNjYW5uZXIuZ2V0VG9rZW5MZW5ndGgoKSArIHJhbmdlU3RhcnQ7XHJcblx0XHRcdHJlcGxhY2VDb250ZW50ID0gc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5MaW5lQ29tbWVudFRyaXZpYSA/IG5ld0xpbmVBbmRJbmRlbnQoKSA6ICcnO1xyXG5cdFx0XHRzZWNvbmRUb2tlbiA9IHNjYW5OZXh0KCk7XHJcblx0XHR9XHJcblxyXG5cdFx0aWYgKHNlY29uZFRva2VuID09PSBKc29uLlN5bnRheEtpbmQuQ2xvc2VCcmFjZVRva2VuKSB7XHJcblx0XHRcdGlmIChmaXJzdFRva2VuICE9PSBKc29uLlN5bnRheEtpbmQuT3BlbkJyYWNlVG9rZW4pIHtcclxuXHRcdFx0XHRpbmRlbnRMZXZlbC0tO1xyXG5cdFx0XHRcdHJlcGxhY2VDb250ZW50ID0gbmV3TGluZUFuZEluZGVudCgpO1xyXG5cdFx0XHR9XHJcblx0XHR9IGVsc2UgaWYgKHNlY29uZFRva2VuID09PSBKc29uLlN5bnRheEtpbmQuQ2xvc2VCcmFja2V0VG9rZW4pIHtcclxuXHRcdFx0aWYgKGZpcnN0VG9rZW4gIT09IEpzb24uU3ludGF4S2luZC5PcGVuQnJhY2tldFRva2VuKSB7XHJcblx0XHRcdFx0aW5kZW50TGV2ZWwtLTtcclxuXHRcdFx0XHRyZXBsYWNlQ29udGVudCA9IG5ld0xpbmVBbmRJbmRlbnQoKTtcclxuXHRcdFx0fVxyXG5cdFx0fSBlbHNlIGlmIChzZWNvbmRUb2tlbiAhPT0gSnNvbi5TeW50YXhLaW5kLkVPRikge1xyXG5cdFx0XHRzd2l0Y2ggKGZpcnN0VG9rZW4pIHtcclxuXHRcdFx0XHRjYXNlIEpzb24uU3ludGF4S2luZC5PcGVuQnJhY2tldFRva2VuOlxyXG5cdFx0XHRcdGNhc2UgSnNvbi5TeW50YXhLaW5kLk9wZW5CcmFjZVRva2VuOlxyXG5cdFx0XHRcdFx0aW5kZW50TGV2ZWwrKztcclxuXHRcdFx0XHRcdHJlcGxhY2VDb250ZW50ID0gbmV3TGluZUFuZEluZGVudCgpO1xyXG5cdFx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdFx0Y2FzZSBKc29uLlN5bnRheEtpbmQuQ29tbWFUb2tlbjpcclxuXHRcdFx0XHRjYXNlIEpzb24uU3ludGF4S2luZC5MaW5lQ29tbWVudFRyaXZpYTpcclxuXHRcdFx0XHRcdHJlcGxhY2VDb250ZW50ID0gbmV3TGluZUFuZEluZGVudCgpO1xyXG5cdFx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdFx0Y2FzZSBKc29uLlN5bnRheEtpbmQuQmxvY2tDb21tZW50VHJpdmlhOlxyXG5cdFx0XHRcdFx0aWYgKGxpbmVCcmVhaykge1xyXG5cdFx0XHRcdFx0XHRyZXBsYWNlQ29udGVudCA9IG5ld0xpbmVBbmRJbmRlbnQoKTtcclxuXHRcdFx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0XHRcdC8vIHN5bWJvbCBmb2xsb3dpbmcgY29tbWVudCBvbiB0aGUgc2FtZSBsaW5lOiBrZWVwIG9uIHNhbWUgbGluZSwgc2VwYXJhdGUgd2l0aCAnICdcclxuXHRcdFx0XHRcdFx0cmVwbGFjZUNvbnRlbnQgPSAnICc7XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHRicmVhaztcclxuXHRcdFx0XHRjYXNlIEpzb24uU3ludGF4S2luZC5Db2xvblRva2VuOlxyXG5cdFx0XHRcdFx0cmVwbGFjZUNvbnRlbnQgPSAnICc7XHJcblx0XHRcdFx0XHRicmVhaztcclxuXHRcdFx0XHRjYXNlIEpzb24uU3ludGF4S2luZC5OdWxsS2V5d29yZDpcclxuXHRcdFx0XHRjYXNlIEpzb24uU3ludGF4S2luZC5UcnVlS2V5d29yZDpcclxuXHRcdFx0XHRjYXNlIEpzb24uU3ludGF4S2luZC5GYWxzZUtleXdvcmQ6XHJcblx0XHRcdFx0Y2FzZSBKc29uLlN5bnRheEtpbmQuTnVtZXJpY0xpdGVyYWw6XHJcblx0XHRcdFx0XHRpZiAoc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5OdWxsS2V5d29yZCB8fCBzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkZhbHNlS2V5d29yZCB8fCBzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLk51bWVyaWNMaXRlcmFsKSB7XHJcblx0XHRcdFx0XHRcdHJlcGxhY2VDb250ZW50ID0gJyAnO1xyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdH1cclxuXHRcdFx0aWYgKGxpbmVCcmVhayAmJiAoc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5MaW5lQ29tbWVudFRyaXZpYSB8fCBzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkJsb2NrQ29tbWVudFRyaXZpYSkpIHtcclxuXHRcdFx0XHRyZXBsYWNlQ29udGVudCA9IG5ld0xpbmVBbmRJbmRlbnQoKTtcclxuXHRcdFx0fVxyXG5cclxuXHRcdH1cclxuXHRcdGxldCBzZWNvbmRUb2tlblN0YXJ0ID0gc2Nhbm5lci5nZXRUb2tlbk9mZnNldCgpICsgcmFuZ2VTdGFydDtcclxuXHRcdGFkZEVkaXQocmVwbGFjZUNvbnRlbnQsIGZpcnN0VG9rZW5FbmQsIHNlY29uZFRva2VuU3RhcnQpO1xyXG5cdFx0Zmlyc3RUb2tlbiA9IHNlY29uZFRva2VuO1xyXG5cdH1cclxuXHRyZXR1cm4gZWRpdE9wZXJhdGlvbnM7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJlcGVhdChzOiBzdHJpbmcsIGNvdW50OiBudW1iZXIpOiBzdHJpbmcge1xyXG5cdGxldCByZXN1bHQgPSAnJztcclxuXHRmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHtcclxuXHRcdHJlc3VsdCArPSBzO1xyXG5cdH1cclxuXHRyZXR1cm4gcmVzdWx0O1xyXG59XHJcblxyXG5mdW5jdGlvbiBjb21wdXRlSW5kZW50TGV2ZWwoY29udGVudDogc3RyaW5nLCBvZmZzZXQ6IG51bWJlciwgb3B0aW9uczogRm9ybWF0dGluZ09wdGlvbnMpOiBudW1iZXIge1xyXG5cdGxldCBpID0gMDtcclxuXHRsZXQgbkNoYXJzID0gMDtcclxuXHRsZXQgdGFiU2l6ZSA9IG9wdGlvbnMudGFiU2l6ZSB8fCA0O1xyXG5cdHdoaWxlIChpIDwgY29udGVudC5sZW5ndGgpIHtcclxuXHRcdGxldCBjaCA9IGNvbnRlbnQuY2hhckF0KGkpO1xyXG5cdFx0aWYgKGNoID09PSAnICcpIHtcclxuXHRcdFx0bkNoYXJzKys7XHJcblx0XHR9IGVsc2UgaWYgKGNoID09PSAnXFx0Jykge1xyXG5cdFx0XHRuQ2hhcnMgKz0gdGFiU2l6ZTtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdGJyZWFrO1xyXG5cdFx0fVxyXG5cdFx0aSsrO1xyXG5cdH1cclxuXHRyZXR1cm4gTWF0aC5mbG9vcihuQ2hhcnMgLyB0YWJTaXplKTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0RU9MKG9wdGlvbnM6IEZvcm1hdHRpbmdPcHRpb25zLCB0ZXh0OiBzdHJpbmcpOiBzdHJpbmcge1xyXG5cdGZvciAobGV0IGkgPSAwOyBpIDwgdGV4dC5sZW5ndGg7IGkrKykge1xyXG5cdFx0bGV0IGNoID0gdGV4dC5jaGFyQXQoaSk7XHJcblx0XHRpZiAoY2ggPT09ICdcXHInKSB7XHJcblx0XHRcdGlmIChpICsgMSA8IHRleHQubGVuZ3RoICYmIHRleHQuY2hhckF0KGkrMSkgPT09ICdcXG4nKSB7XHJcblx0XHRcdFx0cmV0dXJuICdcXHJcXG4nO1xyXG5cdFx0XHR9XHJcblx0XHRcdHJldHVybiAnXFxyJztcclxuXHRcdH0gZWxzZSBpZiAoY2ggPT09ICdcXG4nKSB7XHJcblx0XHRcdHJldHVybiAnXFxuJztcclxuXHRcdH1cclxuXHR9XHJcblx0cmV0dXJuIChvcHRpb25zICYmIG9wdGlvbnMuZW9sKSB8fCAnXFxuJztcclxufVxyXG5cclxuZnVuY3Rpb24gaXNFT0wodGV4dDogc3RyaW5nLCBvZmZzZXQ6IG51bWJlcikge1xyXG5cdHJldHVybiAnXFxyXFxuJy5pbmRleE9mKHRleHQuY2hhckF0KG9mZnNldCkpICE9PSAtMTtcclxufSIsIid1c2Ugc3RyaWN0JztcbmltcG9ydCBKc29uIGZyb20gJy4vanNvbic7XG5leHBvcnQgZnVuY3Rpb24gYXBwbHlFZGl0KHRleHQsIGVkaXQpIHtcbiAgICByZXR1cm4gdGV4dC5zdWJzdHJpbmcoMCwgZWRpdC5vZmZzZXQpICsgZWRpdC5jb250ZW50ICsgdGV4dC5zdWJzdHJpbmcoZWRpdC5vZmZzZXQgKyBlZGl0Lmxlbmd0aCk7XG59XG5leHBvcnQgZnVuY3Rpb24gYXBwbHlFZGl0cyh0ZXh0LCBlZGl0cykge1xuICAgIGZvciAobGV0IGkgPSBlZGl0cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgICB0ZXh0ID0gYXBwbHlFZGl0KHRleHQsIGVkaXRzW2ldKTtcbiAgICB9XG4gICAgcmV0dXJuIHRleHQ7XG59XG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0KGRvY3VtZW50VGV4dCwgcmFuZ2UsIG9wdGlvbnMpIHtcbiAgICBsZXQgaW5pdGlhbEluZGVudExldmVsO1xuICAgIGxldCB2YWx1ZTtcbiAgICBsZXQgcmFuZ2VTdGFydDtcbiAgICBsZXQgcmFuZ2VFbmQ7XG4gICAgaWYgKHJhbmdlKSB7XG4gICAgICAgIHJhbmdlU3RhcnQgPSByYW5nZS5vZmZzZXQ7XG4gICAgICAgIHJhbmdlRW5kID0gcmFuZ2VTdGFydCArIHJhbmdlLmxlbmd0aDtcbiAgICAgICAgd2hpbGUgKHJhbmdlU3RhcnQgPiAwICYmICFpc0VPTChkb2N1bWVudFRleHQsIHJhbmdlU3RhcnQgLSAxKSkge1xuICAgICAgICAgICAgcmFuZ2VTdGFydC0tO1xuICAgICAgICB9XG4gICAgICAgIGxldCBzY2FubmVyID0gSnNvbi5jcmVhdGVTY2FubmVyKGRvY3VtZW50VGV4dCwgdHJ1ZSk7XG4gICAgICAgIHNjYW5uZXIuc2V0UG9zaXRpb24ocmFuZ2VFbmQpO1xuICAgICAgICBzY2FubmVyLnNjYW4oKTtcbiAgICAgICAgcmFuZ2VFbmQgPSBzY2FubmVyLmdldFBvc2l0aW9uKCk7XG4gICAgICAgIHZhbHVlID0gZG9jdW1lbnRUZXh0LnN1YnN0cmluZyhyYW5nZVN0YXJ0LCByYW5nZUVuZCk7XG4gICAgICAgIGluaXRpYWxJbmRlbnRMZXZlbCA9IGNvbXB1dGVJbmRlbnRMZXZlbCh2YWx1ZSwgMCwgb3B0aW9ucyk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICB2YWx1ZSA9IGRvY3VtZW50VGV4dDtcbiAgICAgICAgcmFuZ2VTdGFydCA9IDA7XG4gICAgICAgIHJhbmdlRW5kID0gZG9jdW1lbnRUZXh0Lmxlbmd0aDtcbiAgICAgICAgaW5pdGlhbEluZGVudExldmVsID0gMDtcbiAgICB9XG4gICAgbGV0IGVvbCA9IGdldEVPTChvcHRpb25zLCBkb2N1bWVudFRleHQpO1xuICAgIGxldCBsaW5lQnJlYWsgPSBmYWxzZTtcbiAgICBsZXQgaW5kZW50TGV2ZWwgPSAwO1xuICAgIGxldCBpbmRlbnRWYWx1ZTtcbiAgICBpZiAob3B0aW9ucy5pbnNlcnRTcGFjZXMpIHtcbiAgICAgICAgaW5kZW50VmFsdWUgPSByZXBlYXQoJyAnLCBvcHRpb25zLnRhYlNpemUpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgaW5kZW50VmFsdWUgPSAnXFx0JztcbiAgICB9XG4gICAgbGV0IHNjYW5uZXIgPSBKc29uLmNyZWF0ZVNjYW5uZXIodmFsdWUsIGZhbHNlKTtcbiAgICBmdW5jdGlvbiBuZXdMaW5lQW5kSW5kZW50KCkge1xuICAgICAgICByZXR1cm4gZW9sICsgcmVwZWF0KGluZGVudFZhbHVlLCBpbml0aWFsSW5kZW50TGV2ZWwgKyBpbmRlbnRMZXZlbCk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIHNjYW5OZXh0KCkge1xuICAgICAgICBsZXQgdG9rZW4gPSBzY2FubmVyLnNjYW4oKTtcbiAgICAgICAgbGluZUJyZWFrID0gZmFsc2U7XG4gICAgICAgIHdoaWxlICh0b2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLlRyaXZpYSB8fCB0b2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkxpbmVCcmVha1RyaXZpYSkge1xuICAgICAgICAgICAgbGluZUJyZWFrID0gbGluZUJyZWFrIHx8ICh0b2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkxpbmVCcmVha1RyaXZpYSk7XG4gICAgICAgICAgICB0b2tlbiA9IHNjYW5uZXIuc2NhbigpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0b2tlbjtcbiAgICB9XG4gICAgbGV0IGVkaXRPcGVyYXRpb25zID0gW107XG4gICAgZnVuY3Rpb24gYWRkRWRpdCh0ZXh0LCBzdGFydE9mZnNldCwgZW5kT2Zmc2V0KSB7XG4gICAgICAgIGlmIChkb2N1bWVudFRleHQuc3Vic3RyaW5nKHN0YXJ0T2Zmc2V0LCBlbmRPZmZzZXQpICE9PSB0ZXh0KSB7XG4gICAgICAgICAgICBlZGl0T3BlcmF0aW9ucy5wdXNoKHsgb2Zmc2V0OiBzdGFydE9mZnNldCwgbGVuZ3RoOiBlbmRPZmZzZXQgLSBzdGFydE9mZnNldCwgY29udGVudDogdGV4dCB9KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBsZXQgZmlyc3RUb2tlbiA9IHNjYW5OZXh0KCk7XG4gICAgaWYgKGZpcnN0VG9rZW4gIT09IEpzb24uU3ludGF4S2luZC5FT0YpIHtcbiAgICAgICAgbGV0IGZpcnN0VG9rZW5TdGFydCA9IHNjYW5uZXIuZ2V0VG9rZW5PZmZzZXQoKSArIHJhbmdlU3RhcnQ7XG4gICAgICAgIGxldCBpbml0aWFsSW5kZW50ID0gcmVwZWF0KGluZGVudFZhbHVlLCBpbml0aWFsSW5kZW50TGV2ZWwpO1xuICAgICAgICBhZGRFZGl0KGluaXRpYWxJbmRlbnQsIHJhbmdlU3RhcnQsIGZpcnN0VG9rZW5TdGFydCk7XG4gICAgfVxuICAgIHdoaWxlIChmaXJzdFRva2VuICE9PSBKc29uLlN5bnRheEtpbmQuRU9GKSB7XG4gICAgICAgIGxldCBmaXJzdFRva2VuRW5kID0gc2Nhbm5lci5nZXRUb2tlbk9mZnNldCgpICsgc2Nhbm5lci5nZXRUb2tlbkxlbmd0aCgpICsgcmFuZ2VTdGFydDtcbiAgICAgICAgbGV0IHNlY29uZFRva2VuID0gc2Nhbk5leHQoKTtcbiAgICAgICAgbGV0IHJlcGxhY2VDb250ZW50ID0gJyc7XG4gICAgICAgIHdoaWxlICghbGluZUJyZWFrICYmIChzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkxpbmVDb21tZW50VHJpdmlhIHx8IHNlY29uZFRva2VuID09PSBKc29uLlN5bnRheEtpbmQuQmxvY2tDb21tZW50VHJpdmlhKSkge1xuICAgICAgICAgICAgbGV0IGNvbW1lbnRUb2tlblN0YXJ0ID0gc2Nhbm5lci5nZXRUb2tlbk9mZnNldCgpICsgcmFuZ2VTdGFydDtcbiAgICAgICAgICAgIGFkZEVkaXQoJyAnLCBmaXJzdFRva2VuRW5kLCBjb21tZW50VG9rZW5TdGFydCk7XG4gICAgICAgICAgICBmaXJzdFRva2VuRW5kID0gc2Nhbm5lci5nZXRUb2tlbk9mZnNldCgpICsgc2Nhbm5lci5nZXRUb2tlbkxlbmd0aCgpICsgcmFuZ2VTdGFydDtcbiAgICAgICAgICAgIHJlcGxhY2VDb250ZW50ID0gc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5MaW5lQ29tbWVudFRyaXZpYSA/IG5ld0xpbmVBbmRJbmRlbnQoKSA6ICcnO1xuICAgICAgICAgICAgc2Vjb25kVG9rZW4gPSBzY2FuTmV4dCgpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkNsb3NlQnJhY2VUb2tlbikge1xuICAgICAgICAgICAgaWYgKGZpcnN0VG9rZW4gIT09IEpzb24uU3ludGF4S2luZC5PcGVuQnJhY2VUb2tlbikge1xuICAgICAgICAgICAgICAgIGluZGVudExldmVsLS07XG4gICAgICAgICAgICAgICAgcmVwbGFjZUNvbnRlbnQgPSBuZXdMaW5lQW5kSW5kZW50KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5DbG9zZUJyYWNrZXRUb2tlbikge1xuICAgICAgICAgICAgaWYgKGZpcnN0VG9rZW4gIT09IEpzb24uU3ludGF4S2luZC5PcGVuQnJhY2tldFRva2VuKSB7XG4gICAgICAgICAgICAgICAgaW5kZW50TGV2ZWwtLTtcbiAgICAgICAgICAgICAgICByZXBsYWNlQ29udGVudCA9IG5ld0xpbmVBbmRJbmRlbnQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChzZWNvbmRUb2tlbiAhPT0gSnNvbi5TeW50YXhLaW5kLkVPRikge1xuICAgICAgICAgICAgc3dpdGNoIChmaXJzdFRva2VuKSB7XG4gICAgICAgICAgICAgICAgY2FzZSBKc29uLlN5bnRheEtpbmQuT3BlbkJyYWNrZXRUb2tlbjpcbiAgICAgICAgICAgICAgICBjYXNlIEpzb24uU3ludGF4S2luZC5PcGVuQnJhY2VUb2tlbjpcbiAgICAgICAgICAgICAgICAgICAgaW5kZW50TGV2ZWwrKztcbiAgICAgICAgICAgICAgICAgICAgcmVwbGFjZUNvbnRlbnQgPSBuZXdMaW5lQW5kSW5kZW50KCk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgSnNvbi5TeW50YXhLaW5kLkNvbW1hVG9rZW46XG4gICAgICAgICAgICAgICAgY2FzZSBKc29uLlN5bnRheEtpbmQuTGluZUNvbW1lbnRUcml2aWE6XG4gICAgICAgICAgICAgICAgICAgIHJlcGxhY2VDb250ZW50ID0gbmV3TGluZUFuZEluZGVudCgpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlIEpzb24uU3ludGF4S2luZC5CbG9ja0NvbW1lbnRUcml2aWE6XG4gICAgICAgICAgICAgICAgICAgIGlmIChsaW5lQnJlYWspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VDb250ZW50ID0gbmV3TGluZUFuZEluZGVudCgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZUNvbnRlbnQgPSAnICc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSBKc29uLlN5bnRheEtpbmQuQ29sb25Ub2tlbjpcbiAgICAgICAgICAgICAgICAgICAgcmVwbGFjZUNvbnRlbnQgPSAnICc7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgSnNvbi5TeW50YXhLaW5kLk51bGxLZXl3b3JkOlxuICAgICAgICAgICAgICAgIGNhc2UgSnNvbi5TeW50YXhLaW5kLlRydWVLZXl3b3JkOlxuICAgICAgICAgICAgICAgIGNhc2UgSnNvbi5TeW50YXhLaW5kLkZhbHNlS2V5d29yZDpcbiAgICAgICAgICAgICAgICBjYXNlIEpzb24uU3ludGF4S2luZC5OdW1lcmljTGl0ZXJhbDpcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNlY29uZFRva2VuID09PSBKc29uLlN5bnRheEtpbmQuTnVsbEtleXdvcmQgfHwgc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5GYWxzZUtleXdvcmQgfHwgc2Vjb25kVG9rZW4gPT09IEpzb24uU3ludGF4S2luZC5OdW1lcmljTGl0ZXJhbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZUNvbnRlbnQgPSAnICc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobGluZUJyZWFrICYmIChzZWNvbmRUb2tlbiA9PT0gSnNvbi5TeW50YXhLaW5kLkxpbmVDb21tZW50VHJpdmlhIHx8IHNlY29uZFRva2VuID09PSBKc29uLlN5bnRheEtpbmQuQmxvY2tDb21tZW50VHJpdmlhKSkge1xuICAgICAgICAgICAgICAgIHJlcGxhY2VDb250ZW50ID0gbmV3TGluZUFuZEluZGVudCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGxldCBzZWNvbmRUb2tlblN0YXJ0ID0gc2Nhbm5lci5nZXRUb2tlbk9mZnNldCgpICsgcmFuZ2VTdGFydDtcbiAgICAgICAgYWRkRWRpdChyZXBsYWNlQ29udGVudCwgZmlyc3RUb2tlbkVuZCwgc2Vjb25kVG9rZW5TdGFydCk7XG4gICAgICAgIGZpcnN0VG9rZW4gPSBzZWNvbmRUb2tlbjtcbiAgICB9XG4gICAgcmV0dXJuIGVkaXRPcGVyYXRpb25zO1xufVxuZnVuY3Rpb24gcmVwZWF0KHMsIGNvdW50KSB7XG4gICAgbGV0IHJlc3VsdCA9ICcnO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnQ7IGkrKykge1xuICAgICAgICByZXN1bHQgKz0gcztcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cbmZ1bmN0aW9uIGNvbXB1dGVJbmRlbnRMZXZlbChjb250ZW50LCBvZmZzZXQsIG9wdGlvbnMpIHtcbiAgICBsZXQgaSA9IDA7XG4gICAgbGV0IG5DaGFycyA9IDA7XG4gICAgbGV0IHRhYlNpemUgPSBvcHRpb25zLnRhYlNpemUgfHwgNDtcbiAgICB3aGlsZSAoaSA8IGNvbnRlbnQubGVuZ3RoKSB7XG4gICAgICAgIGxldCBjaCA9IGNvbnRlbnQuY2hhckF0KGkpO1xuICAgICAgICBpZiAoY2ggPT09ICcgJykge1xuICAgICAgICAgICAgbkNoYXJzKys7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoY2ggPT09ICdcXHQnKSB7XG4gICAgICAgICAgICBuQ2hhcnMgKz0gdGFiU2l6ZTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGkrKztcbiAgICB9XG4gICAgcmV0dXJuIE1hdGguZmxvb3IobkNoYXJzIC8gdGFiU2l6ZSk7XG59XG5mdW5jdGlvbiBnZXRFT0wob3B0aW9ucywgdGV4dCkge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGV4dC5sZW5ndGg7IGkrKykge1xuICAgICAgICBsZXQgY2ggPSB0ZXh0LmNoYXJBdChpKTtcbiAgICAgICAgaWYgKGNoID09PSAnXFxyJykge1xuICAgICAgICAgICAgaWYgKGkgKyAxIDwgdGV4dC5sZW5ndGggJiYgdGV4dC5jaGFyQXQoaSArIDEpID09PSAnXFxuJykge1xuICAgICAgICAgICAgICAgIHJldHVybiAnXFxyXFxuJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiAnXFxyJztcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChjaCA9PT0gJ1xcbicpIHtcbiAgICAgICAgICAgIHJldHVybiAnXFxuJztcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gKG9wdGlvbnMgJiYgb3B0aW9ucy5lb2wpIHx8ICdcXG4nO1xufVxuZnVuY3Rpb24gaXNFT0wodGV4dCwgb2Zmc2V0KSB7XG4gICAgcmV0dXJuICdcXHJcXG4nLmluZGV4T2YodGV4dC5jaGFyQXQob2Zmc2V0KSkgIT09IC0xO1xufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
