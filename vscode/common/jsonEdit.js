'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.removeProperty = removeProperty;
exports.setProperty = setProperty;

var _json = require('./json');

var _jsonFormatter = require('./jsonFormatter');

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function removeProperty(text, path, formattingOptions) {
    return setProperty(text, path, void 0, formattingOptions);
}
function setProperty(text, path, value, formattingOptions, getInsertionIndex) {
    var errors = [];
    var root = (0, _json.parseTree)(text, errors);
    var parent = void 0;
    var lastSegment = void 0;
    while (path.length > 0) {
        lastSegment = path.pop();
        parent = (0, _json.findNodeAtLocation)(root, path);
        if (parent === void 0 && value !== void 0) {
            if (typeof lastSegment === 'string') {
                value = _defineProperty({}, lastSegment, value);
            } else {
                value = [value];
            }
        } else {
            break;
        }
    }
    if (!parent) {
        if (value === void 0) {
            throw new Error('Can not delete in empty document');
        }
        return withFormatting(text, { offset: root ? root.offset : 0, length: root ? root.length : 0, content: JSON.stringify(value) }, formattingOptions);
    } else if (parent.type === 'object' && typeof lastSegment === 'string') {
        var existing = (0, _json.findNodeAtLocation)(parent, [lastSegment]);
        if (existing !== void 0) {
            if (value === void 0) {
                var propertyIndex = parent.children.indexOf(existing.parent);
                var removeBegin = void 0;
                var removeEnd = existing.parent.offset + existing.parent.length;
                if (propertyIndex > 0) {
                    var previous = parent.children[propertyIndex - 1];
                    removeBegin = previous.offset + previous.length;
                } else {
                    removeBegin = parent.offset + 1;
                    if (parent.children.length > 1) {
                        var next = parent.children[1];
                        removeEnd = next.offset;
                    }
                }
                return withFormatting(text, { offset: removeBegin, length: removeEnd - removeBegin, content: '' }, formattingOptions);
            } else {
                return [{ offset: existing.offset, length: existing.length, content: JSON.stringify(value) }];
            }
        } else {
            if (value === void 0) {
                throw new Error('Property ' + lastSegment + ' does not exist.');
            }
            var newProperty = JSON.stringify(lastSegment) + ': ' + JSON.stringify(value);
            var index = getInsertionIndex ? getInsertionIndex(parent.children.map(function (p) {
                return p.children[0].value;
            })) : parent.children.length;
            var edit = void 0;
            if (index > 0) {
                var _previous = parent.children[index - 1];
                edit = { offset: _previous.offset + _previous.length, length: 0, content: ',' + newProperty };
            } else if (parent.children.length === 0) {
                edit = { offset: parent.offset + 1, length: 0, content: newProperty };
            } else {
                edit = { offset: parent.offset + 1, length: 0, content: newProperty + ',' };
            }
            return withFormatting(text, edit, formattingOptions);
        }
    } else if (parent.type === 'array' && typeof lastSegment === 'number') {
        throw new Error('Array modification not supported yet');
    } else {
        throw new Error('Can not add ' + (typeof lastSegment !== 'number' ? 'index' : 'property') + ' to parent of type ' + parent.type);
    }
}
function withFormatting(text, edit, formattingOptions) {
    var newText = (0, _jsonFormatter.applyEdit)(text, edit);
    var begin = edit.offset;
    var end = edit.offset + edit.content.length;
    var edits = (0, _jsonFormatter.format)(newText, { offset: begin, length: end - begin }, formattingOptions);
    for (var i = edits.length - 1; i >= 0; i--) {
        var _edit = edits[i];
        newText = (0, _jsonFormatter.applyEdit)(newText, _edit);
        begin = Math.min(begin, _edit.offset);
        end = Math.max(end, _edit.offset + _edit.length);
        end += _edit.content.length - _edit.length;
    }
    var editLength = text.length - (newText.length - end) - begin;
    return [{ offset: begin, length: editLength, content: newText.substring(begin, end) }];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZzY29kZS9jb21tb24vanNvbkVkaXQudHMiLCJ2c2NvZGUvY29tbW9uL2pzb25FZGl0LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUlBOzs7OztRQUtBLGMsR0FBQSxjO1FBSUEsVyxHQUFBLFc7O0FDWkE7O0FBQ0E7Ozs7QURPQSxTQUFBLGNBQUEsQ0FBK0IsSUFBL0IsRUFBNkMsSUFBN0MsRUFBNkQsaUJBQTdELEVBQWlHO0FBQzdGLFdBQU8sWUFBWSxJQUFaLEVBQWtCLElBQWxCLEVBQXdCLEtBQUssQ0FBN0IsRUFBZ0MsaUJBQWhDLENBQVA7QUFDSDtBQUVELFNBQUEsV0FBQSxDQUE0QixJQUE1QixFQUEwQyxJQUExQyxFQUEwRCxLQUExRCxFQUFzRSxpQkFBdEUsRUFBNEcsaUJBQTVHLEVBQWdLO0FBQzVKLFFBQUksU0FBdUIsRUFBM0I7QUFDQSxRQUFJLE9BQU8scUJBQVUsSUFBVixFQUFnQixNQUFoQixDQUFYO0FBQ0EsUUFBSSxTQUFlLEtBQUssQ0FBeEI7QUFFQSxRQUFJLGNBQXVCLEtBQUssQ0FBaEM7QUFDQSxXQUFPLEtBQUssTUFBTCxHQUFjLENBQXJCLEVBQXdCO0FBQ3BCLHNCQUFjLEtBQUssR0FBTCxFQUFkO0FBQ0EsaUJBQVMsOEJBQW1CLElBQW5CLEVBQXlCLElBQXpCLENBQVQ7QUFDQSxZQUFJLFdBQVcsS0FBSyxDQUFoQixJQUFxQixVQUFVLEtBQUssQ0FBeEMsRUFBMkM7QUFDdkMsZ0JBQUksT0FBTyxXQUFQLEtBQXVCLFFBQTNCLEVBQXFDO0FBQ2pDLDRDQUFXLFdBQVgsRUFBeUIsS0FBekI7QUFDSCxhQUZELE1BRU87QUFDSCx3QkFBUSxDQUFFLEtBQUYsQ0FBUjtBQUNIO0FBQ0osU0FORCxNQU1PO0FBQ0g7QUFDSDtBQUNKO0FBRUQsUUFBSSxDQUFDLE1BQUwsRUFBYTtBQUVULFlBQUksVUFBVSxLQUFLLENBQW5CLEVBQXNCO0FBQ2xCLGtCQUFNLElBQUksS0FBSixDQUFVLGtDQUFWLENBQU47QUFDSDtBQUNELGVB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UixHQUFpQixHQUFoQyxJQUF1QyxLQUF4RDtBQUNBLFdBQU8sQ0FBQyxFQUFFLFFBQVEsS0FBVixFQUFpQixRQUFRLFVBQXpCLEVBQXFDLFNBQVMsUUFBUSxTQUFSLENBQWtCLEtBQWxCLEVBQXlCLEdBQXpCLENBQTlDLEVBQUQsQ0FBUDtBQUNIIiwiZmlsZSI6InZzY29kZS9jb21tb24vanNvbkVkaXQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4gKiAgQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuIFNlZSBMaWNlbnNlLnR4dCBpbiB0aGUgcHJvamVjdCByb290IGZvciBsaWNlbnNlIGluZm9ybWF0aW9uLlxyXG4gKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi9cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuaW1wb3J0IHsgUGFyc2VFcnJvciwgTm9kZSwgcGFyc2VUcmVlLCBmaW5kTm9kZUF0TG9jYXRpb24sIEpTT05QYXRoLCBTZWdtZW50IH0gZnJvbSAnLi9qc29uJztcclxuaW1wb3J0IHsgRWRpdCwgRm9ybWF0dGluZ09wdGlvbnMsIGZvcm1hdCwgYXBwbHlFZGl0IH0gZnJvbSAnLi9qc29uRm9ybWF0dGVyJztcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiByZW1vdmVQcm9wZXJ0eSh0ZXh0OiBzdHJpbmcsIHBhdGg6IEpTT05QYXRoLCBmb3JtYXR0aW5nT3B0aW9uczogRm9ybWF0dGluZ09wdGlvbnMpIDogRWRpdFtdIHtcclxuICAgIHJldHVybiBzZXRQcm9wZXJ0eSh0ZXh0LCBwYXRoLCB2b2lkIDAsIGZvcm1hdHRpbmdPcHRpb25zKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHNldFByb3BlcnR5KHRleHQ6IHN0cmluZywgcGF0aDogSlNPTlBhdGgsIHZhbHVlOiBhbnksIGZvcm1hdHRpbmdPcHRpb25zOiBGb3JtYXR0aW5nT3B0aW9ucywgZ2V0SW5zZXJ0aW9uSW5kZXg/OiAocHJvcGVydGllczogc3RyaW5nW10pID0+IG51bWJlcikgOiBFZGl0W10ge1xyXG4gICAgbGV0IGVycm9yczogUGFyc2VFcnJvcltdID0gW107XHJcbiAgICBsZXQgcm9vdCA9IHBhcnNlVHJlZSh0ZXh0LCBlcnJvcnMpO1xyXG4gICAgbGV0IHBhcmVudDogTm9kZSA9IHZvaWQgMDtcclxuXHJcbiAgICBsZXQgbGFzdFNlZ21lbnQ6IFNlZ21lbnQgPSB2b2lkIDA7XHJcbiAgICB3aGlsZSAocGF0aC5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgbGFzdFNlZ21lbnQgPSBwYXRoLnBvcCgpO1xyXG4gICAgICAgIHBhcmVudCA9IGZpbmROb2RlQXRMb2NhdGlvbihyb290LCBwYXRoKTtcclxuICAgICAgICBpZiAocGFyZW50ID09PSB2b2lkIDAgJiYgdmFsdWUgIT09IHZvaWQgMCkge1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIGxhc3RTZWdtZW50ID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSB7IFtsYXN0U2VnbWVudF06IHZhbHVlIH07XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IFsgdmFsdWUgXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAoIXBhcmVudCkge1xyXG4gICAgICAgIC8vIGVtcHR5IGRvY3VtZW50XHJcbiAgICAgICAgaWYgKHZhbHVlID09PSB2b2lkIDApIHsgLy8gZGVsZXRlXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2FuIG5vdCBkZWxldGUgaW4gZW1wdHkgZG9jdW1lbnQnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHdpdGhGb3JtYXR0aW5nKHRleHQsIHsgb2Zmc2V0OiByb290ID8gcm9vdC5vZmZzZXQgOiAwLCBsZW5ndGg6IHJvb3QgPyByb290Lmxlbmd0aCA6IDAsIGNvbnRlbnQ6IEpTT04uc3RyaW5naWZ5KHZhbHVlKSB9LCBmb3JtYXR0aW5nT3B0aW9ucyk7XHJcbiAgICB9IGVsc2UgaWYgKHBhcmVudC50eXBlID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgbGFzdFNlZ21lbnQgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgbGV0IGV4aXN0aW5nID0gZmluZE5vZGVBdExvY2F0aW9uKHBhcmVudCwgWyBsYXN0U2VnbWVudCBdKTtcclxuICAgICAgICBpZiAoZXhpc3RpbmcgIT09IHZvaWQgMCkge1xyXG4gICAgICAgICAgICBpZiAodmFsdWUgPT09IHZvaWQgMCkgeyAvLyBkZWxldGVcclxuICAgICAgICAgICAgICAgIGxldCBwcm9wZXJ0eUluZGV4ID0gcGFyZW50LmNoaWxkcmVuLmluZGV4T2YoZXhpc3RpbmcucGFyZW50KTtcclxuICAgICAgICAgICAgICAgIGxldCByZW1vdmVCZWdpbiA6IG51bWJlcjtcclxuICAgICAgICAgICAgICAgIGxldCByZW1vdmVFbmQgPSBleGlzdGluZy5wYXJlbnQub2Zmc2V0ICsgZXhpc3RpbmcucGFyZW50Lmxlbmd0aDtcclxuICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZGV4ID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgY29tbWEgb2YgdGhlIHByZXZpb3VzIG5vZGVcclxuICAgICAgICAgICAgICAgICAgICBsZXQgcHJldmlvdXMgPSBwYXJlbnQuY2hpbGRyZW5bcHJvcGVydHlJbmRleCAtIDFdO1xyXG4gICAgICAgICAgICAgICAgICAgIHJlbW92ZUJlZ2luID0gcHJldmlvdXMub2Zmc2V0ICsgcHJldmlvdXMubGVuZ3RoO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZW1vdmVCZWdpbiA9IHBhcmVudC5vZmZzZXQgKyAxO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQuY2hpbGRyZW4ubGVuZ3RoID4gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgdGhlIGNvbW1hIG9mIHRoZSBuZXh0IG5vZGVcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG5leHQgPSBwYXJlbnQuY2hpbGRyZW5bMV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZUVuZCA9IG5leHQub2Zmc2V0O1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiB3aXRoRm9ybWF0dGluZyh0ZXh0LCB7IG9mZnNldDogcmVtb3ZlQmVnaW4sIGxlbmd0aDogcmVtb3ZlRW5kIC0gcmVtb3ZlQmVnaW4sIGNvbnRlbnQ6ICcnIH0sIGZvcm1hdHRpbmdPcHRpb25zKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vIHNldCB2YWx1ZSBvZiBleGlzdGluZyBwcm9wZXJ0eVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFt7IG9mZnNldDogZXhpc3Rpbmcub2Zmc2V0LCBsZW5ndGg6IGV4aXN0aW5nLmxlbmd0aCwgY29udGVudDogSlNPTi5zdHJpbmdpZnkodmFsdWUpIH1dO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKHZhbHVlID09PSB2b2lkIDApIHsgLy8gZGVsZXRlXHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFByb3BlcnR5ICR7bGFzdFNlZ21lbnR9IGRvZXMgbm90IGV4aXN0LmApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxldCBuZXdQcm9wZXJ0eSA9IGAke0pTT04uc3RyaW5naWZ5KGxhc3RTZWdtZW50KX06ICR7SlNPTi5zdHJpbmdpZnkodmFsdWUpfWA7XHJcbiAgICAgICAgICAgIGxldCBpbmRleCA9IGdldEluc2VydGlvbkluZGV4ID8gZ2V0SW5zZXJ0aW9uSW5kZXgocGFyZW50LmNoaWxkcmVuLm1hcChwID0+IHAuY2hpbGRyZW5bMF0udmFsdWUpKSA6IHBhcmVudC5jaGlsZHJlbi5sZW5ndGg7XHJcbiAgICAgICAgICAgIGxldCBlZGl0OiBFZGl0O1xyXG4gICAgICAgICAgICBpZiAoaW5kZXggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgcHJldmlvdXMgPSBwYXJlbnQuY2hpbGRyZW5baW5kZXggLSAxXTtcclxuICAgICAgICAgICAgICAgIGVkaXQgPSB7IG9mZnNldDogcHJldmlvdXMub2Zmc2V0ICsgcHJldmlvdXMubGVuZ3RoLCBsZW5ndGg6IDAsIGNvbnRlbnQ6ICcsJyArIG5ld1Byb3BlcnR5fTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChwYXJlbnQuY2hpbGRyZW4ubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICBlZGl0ID0geyBvZmZzZXQ6IHBhcmVudC5vZmZzZXQgKyAxLCBsZW5ndGg6IDAsIGNvbnRlbnQ6IG5ld1Byb3BlcnR5fTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGVkaXQgPSB7IG9mZnNldDogcGFyZW50Lm9mZnNldCArIDEsIGxlbmd0aDogMCwgY29udGVudDogbmV3UHJvcGVydHkgKyAnLCd9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB3aXRoRm9ybWF0dGluZyh0ZXh0LCBlZGl0LCBmb3JtYXR0aW5nT3B0aW9ucyk7XHJcbiAgICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChwYXJlbnQudHlwZSA9PT0gJ2FycmF5JyAmJiB0eXBlb2YgbGFzdFNlZ21lbnQgPT09ICdudW1iZXInKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBcnJheSBtb2RpZmljYXRpb24gbm90IHN1cHBvcnRlZCB5ZXQnKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW4gbm90IGFkZCAke3R5cGVvZiBsYXN0U2VnbWVudCAhPT0gJ251bWJlcicgPyAnaW5kZXgnIDogJ3Byb3BlcnR5JyB9IHRvIHBhcmVudCBvZiB0eXBlICR7cGFyZW50LnR5cGV9YCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHdpdGhGb3JtYXR0aW5nKHRleHQ6c3RyaW5nLCBlZGl0OiBFZGl0LCBmb3JtYXR0aW5nT3B0aW9uczogRm9ybWF0dGluZ09wdGlvbnMpIDogRWRpdFtdIHtcclxuICAgIC8vIGFwcGx5IHRoZSBlZGl0XHJcbiAgICBsZXQgbmV3VGV4dCA9IGFwcGx5RWRpdCh0ZXh0LCBlZGl0KTtcclxuXHJcbiAgICAvLyBmb3JtYXQgdGhlIG5ldyB0ZXh0XHJcbiAgICBsZXQgYmVnaW4gPSBlZGl0Lm9mZnNldDtcclxuICAgIGxldCBlbmQgPSBlZGl0Lm9mZnNldCArIGVkaXQuY29udGVudC5sZW5ndGg7XHJcbiAgICBsZXQgZWRpdHMgPSBmb3JtYXQobmV3VGV4dCwgeyBvZmZzZXQ6IGJlZ2luLCBsZW5ndGg6IGVuZCAtIGJlZ2luIH0sIGZvcm1hdHRpbmdPcHRpb25zKTtcclxuXHJcbiAgICAvLyBhcHBseSB0aGUgZm9ybWF0dGluZyBlZGl0cyBhbmQgdHJhY2sgdGhlIGJlZ2luIGFuZCBlbmQgb2Zmc2V0cyBvZiB0aGUgY2hhbmdlc1xyXG4gICAgZm9yIChsZXQgaSA9IGVkaXRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XHJcbiAgICAgICAgbGV0IGVkaXQgPSBlZGl0c1tpXTtcclxuICAgICAgICBuZXdUZXh0ID0gYXBwbHlFZGl0KG5ld1RleHQsIGVkaXQpO1xyXG4gICAgICAgIGJlZ2luID0gTWF0aC5taW4oYmVnaW4sIGVkaXQub2Zmc2V0KTtcclxuICAgICAgICBlbmQgPSBNYXRoLm1heChlbmQsIGVkaXQub2Zmc2V0ICsgZWRpdC5sZW5ndGgpO1xyXG4gICAgICAgIGVuZCArPSBlZGl0LmNvbnRlbnQubGVuZ3RoIC0gZWRpdC5sZW5ndGg7XHJcbiAgICB9XHJcbiAgICAvLyBjcmVhdGUgYSBzaW5nbGUgZWRpdCB3aXRoIGFsbCBjaGFuZ2VzXHJcbiAgICBsZXQgZWRpdExlbmd0aCA9IHRleHQubGVuZ3RoIC0gKG5ld1RleHQubGVuZ3RoIC0gZW5kKSAtIGJlZ2luO1xyXG4gICAgcmV0dXJuIFt7IG9mZnNldDogYmVnaW4sIGxlbmd0aDogZWRpdExlbmd0aCwgY29udGVudDogbmV3VGV4dC5zdWJzdHJpbmcoYmVnaW4sIGVuZCkgfV07XHJcbn1cclxuIiwiJ3VzZSBzdHJpY3QnO1xuaW1wb3J0IHsgcGFyc2VUcmVlLCBmaW5kTm9kZUF0TG9jYXRpb24gfSBmcm9tICcuL2pzb24nO1xuaW1wb3J0IHsgZm9ybWF0LCBhcHBseUVkaXQgfSBmcm9tICcuL2pzb25Gb3JtYXR0ZXInO1xuZXhwb3J0IGZ1bmN0aW9uIHJlbW92ZVByb3BlcnR5KHRleHQsIHBhdGgsIGZvcm1hdHRpbmdPcHRpb25zKSB7XG4gICAgcmV0dXJuIHNldFByb3BlcnR5KHRleHQsIHBhdGgsIHZvaWQgMCwgZm9ybWF0dGluZ09wdGlvbnMpO1xufVxuZXhwb3J0IGZ1bmN0aW9uIHNldFByb3BlcnR5KHRleHQsIHBhdGgsIHZhbHVlLCBmb3JtYXR0aW5nT3B0aW9ucywgZ2V0SW5zZXJ0aW9uSW5kZXgpIHtcbiAgICBsZXQgZXJyb3JzID0gW107XG4gICAgbGV0IHJvb3QgPSBwYXJzZVRyZWUodGV4dCwgZXJyb3JzKTtcbiAgICBsZXQgcGFyZW50ID0gdm9pZCAwO1xuICAgIGxldCBsYXN0U2VnbWVudCA9IHZvaWQgMDtcbiAgICB3aGlsZSAocGF0aC5sZW5ndGggPiAwKSB7XG4gICAgICAgIGxhc3RTZWdtZW50ID0gcGF0aC5wb3AoKTtcbiAgICAgICAgcGFyZW50ID0gZmluZE5vZGVBdExvY2F0aW9uKHJvb3QsIHBhdGgpO1xuICAgICAgICBpZiAocGFyZW50ID09PSB2b2lkIDAgJiYgdmFsdWUgIT09IHZvaWQgMCkge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBsYXN0U2VnbWVudCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHsgW2xhc3RTZWdtZW50XTogdmFsdWUgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhbHVlID0gW3ZhbHVlXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmICghcGFyZW50KSB7XG4gICAgICAgIGlmICh2YWx1ZSA9PT0gdm9pZCAwKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NhbiBub3QgZGVsZXRlIGluIGVtcHR5IGRvY3VtZW50Jyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHdpdGhGb3JtYXR0aW5nKHRleHQsIHsgb2Zmc2V0OiByb290ID8gcm9vdC5vZmZzZXQgOiAwLCBsZW5ndGg6IHJvb3QgPyByb290Lmxlbmd0aCA6IDAsIGNvbnRlbnQ6IEpTT04uc3RyaW5naWZ5KHZhbHVlKSB9LCBmb3JtYXR0aW5nT3B0aW9ucyk7XG4gICAgfVxuICAgIGVsc2UgaWYgKHBhcmVudC50eXBlID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgbGFzdFNlZ21lbnQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGxldCBleGlzdGluZyA9IGZpbmROb2RlQXRMb2NhdGlvbihwYXJlbnQsIFtsYXN0U2VnbWVudF0pO1xuICAgICAgICBpZiAoZXhpc3RpbmcgIT09IHZvaWQgMCkge1xuICAgICAgICAgICAgaWYgKHZhbHVlID09PSB2b2lkIDApIHtcbiAgICAgICAgICAgICAgICBsZXQgcHJvcGVydHlJbmRleCA9IHBhcmVudC5jaGlsZHJlbi5pbmRleE9mKGV4aXN0aW5nLnBhcmVudCk7XG4gICAgICAgICAgICAgICAgbGV0IHJlbW92ZUJlZ2luO1xuICAgICAgICAgICAgICAgIGxldCByZW1vdmVFbmQgPSBleGlzdGluZy5wYXJlbnQub2Zmc2V0ICsgZXhpc3RpbmcucGFyZW50Lmxlbmd0aDtcbiAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmRleCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHByZXZpb3VzID0gcGFyZW50LmNoaWxkcmVuW3Byb3BlcnR5SW5kZXggLSAxXTtcbiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQmVnaW4gPSBwcmV2aW91cy5vZmZzZXQgKyBwcmV2aW91cy5sZW5ndGg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZW1vdmVCZWdpbiA9IHBhcmVudC5vZmZzZXQgKyAxO1xuICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50LmNoaWxkcmVuLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBuZXh0ID0gcGFyZW50LmNoaWxkcmVuWzFdO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlRW5kID0gbmV4dC5vZmZzZXQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHdpdGhGb3JtYXR0aW5nKHRleHQsIHsgb2Zmc2V0OiByZW1vdmVCZWdpbiwgbGVuZ3RoOiByZW1vdmVFbmQgLSByZW1vdmVCZWdpbiwgY29udGVudDogJycgfSwgZm9ybWF0dGluZ09wdGlvbnMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFt7IG9mZnNldDogZXhpc3Rpbmcub2Zmc2V0LCBsZW5ndGg6IGV4aXN0aW5nLmxlbmd0aCwgY29udGVudDogSlNPTi5zdHJpbmdpZnkodmFsdWUpIH1dO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgaWYgKHZhbHVlID09PSB2b2lkIDApIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFByb3BlcnR5ICR7bGFzdFNlZ21lbnR9IGRvZXMgbm90IGV4aXN0LmApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGV0IG5ld1Byb3BlcnR5ID0gYCR7SlNPTi5zdHJpbmdpZnkobGFzdFNlZ21lbnQpfTogJHtKU09OLnN0cmluZ2lmeSh2YWx1ZSl9YDtcbiAgICAgICAgICAgIGxldCBpbmRleCA9IGdldEluc2VydGlvbkluZGV4ID8gZ2V0SW5zZXJ0aW9uSW5kZXgocGFyZW50LmNoaWxkcmVuLm1hcChwID0+IHAuY2hpbGRyZW5bMF0udmFsdWUpKSA6IHBhcmVudC5jaGlsZHJlbi5sZW5ndGg7XG4gICAgICAgICAgICBsZXQgZWRpdDtcbiAgICAgICAgICAgIGlmIChpbmRleCA+IDApIHtcbiAgICAgICAgICAgICAgICBsZXQgcHJldmlvdXMgPSBwYXJlbnQuY2hpbGRyZW5baW5kZXggLSAxXTtcbiAgICAgICAgICAgICAgICBlZGl0ID0geyBvZmZzZXQ6IHByZXZpb3VzLm9mZnNldCArIHByZXZpb3VzLmxlbmd0aCwgbGVuZ3RoOiAwLCBjb250ZW50OiAnLCcgKyBuZXdQcm9wZXJ0eSB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAocGFyZW50LmNoaWxkcmVuLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGVkaXQgPSB7IG9mZnNldDogcGFyZW50Lm9mZnNldCArIDEsIGxlbmd0aDogMCwgY29udGVudDogbmV3UHJvcGVydHkgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGVkaXQgPSB7IG9mZnNldDogcGFyZW50Lm9mZnNldCArIDEsIGxlbmd0aDogMCwgY29udGVudDogbmV3UHJvcGVydHkgKyAnLCcgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB3aXRoRm9ybWF0dGluZyh0ZXh0LCBlZGl0LCBmb3JtYXR0aW5nT3B0aW9ucyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZWxzZSBpZiAocGFyZW50LnR5cGUgPT09ICdhcnJheScgJiYgdHlwZW9mIGxhc3RTZWdtZW50ID09PSAnbnVtYmVyJykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FycmF5IG1vZGlmaWNhdGlvbiBub3Qgc3VwcG9ydGVkIHlldCcpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW4gbm90IGFkZCAke3R5cGVvZiBsYXN0U2VnbWVudCAhPT0gJ251bWJlcicgPyAnaW5kZXgnIDogJ3Byb3BlcnR5J30gdG8gcGFyZW50IG9mIHR5cGUgJHtwYXJlbnQudHlwZX1gKTtcbiAgICB9XG59XG5mdW5jdGlvbiB3aXRoRm9ybWF0dGluZyh0ZXh0LCBlZGl0LCBmb3JtYXR0aW5nT3B0aW9ucykge1xuICAgIGxldCBuZXdUZXh0ID0gYXBwbHlFZGl0KHRleHQsIGVkaXQpO1xuICAgIGxldCBiZWdpbiA9IGVkaXQub2Zmc2V0O1xuICAgIGxldCBlbmQgPSBlZGl0Lm9mZnNldCArIGVkaXQuY29udGVudC5sZW5ndGg7XG4gICAgbGV0IGVkaXRzID0gZm9ybWF0KG5ld1RleHQsIHsgb2Zmc2V0OiBiZWdpbiwgbGVuZ3RoOiBlbmQgLSBiZWdpbiB9LCBmb3JtYXR0aW5nT3B0aW9ucyk7XG4gICAgZm9yIChsZXQgaSA9IGVkaXRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgIGxldCBlZGl0ID0gZWRpdHNbaV07XG4gICAgICAgIG5ld1RleHQgPSBhcHBseUVkaXQobmV3VGV4dCwgZWRpdCk7XG4gICAgICAgIGJlZ2luID0gTWF0aC5taW4oYmVnaW4sIGVkaXQub2Zmc2V0KTtcbiAgICAgICAgZW5kID0gTWF0aC5tYXgoZW5kLCBlZGl0Lm9mZnNldCArIGVkaXQubGVuZ3RoKTtcbiAgICAgICAgZW5kICs9IGVkaXQuY29udGVudC5sZW5ndGggLSBlZGl0Lmxlbmd0aDtcbiAgICB9XG4gICAgbGV0IGVkaXRMZW5ndGggPSB0ZXh0Lmxlbmd0aCAtIChuZXdUZXh0Lmxlbmd0aCAtIGVuZCkgLSBiZWdpbjtcbiAgICByZXR1cm4gW3sgb2Zmc2V0OiBiZWdpbiwgbGVuZ3RoOiBlZGl0TGVuZ3RoLCBjb250ZW50OiBuZXdUZXh0LnN1YnN0cmluZyhiZWdpbiwgZW5kKSB9XTtcbn1cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
