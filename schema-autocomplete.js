'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.CompletionProvider = undefined;

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _getRanges2 = require('./helpers/get-ranges');

var _schemaProvider = require('./schema-provider');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var filter = require('fuzzaldrin').filter;

function fixSnippet(snippet, options, type) {
    var t = _lodash2.default.trim(snippet);
    if (_lodash2.default.startsWith(t, '{') || _lodash2.default.startsWith(t, '"') || _lodash2.default.endsWith(t, '}') || _lodash2.default.endsWith(t, '"') || _lodash2.default.endsWith(t, ',')) return snippet;
    if (!options.hasLeadingQuote) snippet = '"' + snippet;
    if (!options.hasTrailingQuote && !_lodash2.default.endsWith(snippet, '.')) snippet = snippet + '"';
    if (type === "string") {
        snippet = snippet += ': ""';
    } else if (type === "object") {
        snippet = snippet += ': {}';
    } else if (type === "array") {
        snippet = snippet += ': []';
    }
    return snippet;
}
function makeSuggestion(item, options) {
    var description = item.description,
        leftLabel = item.type.substr(0, 1),
        type = 'variable';
    return {
        _search: item.key,
        text: item.key,
        snippet: fixSnippet(item.key, options, item.type),
        type: type,
        displayText: item.key,
        className: 'autocomplete-json-schema',
        description: description
    };
}
function renderReturnType(returnType) {
    if (returnType === null) {
        return;
    }
    return 'Returns: ' + returnType;
}
function schemaGet(schema, path) {
    var p = (path || '').split('/');
    var rootSchema = schema;
    while (p.length) {
        var s = p.shift();
        if (schema.properties && schema.properties[s]) {
            schema = schema.properties[s];
        } else if (schema.additionalProperties) {
            schema = schema.additionalProperties;
        }
        if (schema.$ref) {
            var childPath = _lodash2.default.trim(schema.$ref, '/#').split('/').join('.');
            schema = _lodash2.default.get(rootSchema, childPath);
        }
    }
    return schema;
}
function getSuggestions(options) {
    var line = options.editor.getBuffer().getLines()[options.bufferPosition.row];
    var hasLeadingQuote = false;
    for (var i = options.bufferPosition.column; i >= 0; i--) {
        var char = line[i];
        if (char === ',' || char === '}' || char === ':') {
            break;
        }
        if (char === '"') {
            hasLeadingQuote = true;
            break;
        }
    }
    var hasTrailingQuote = false;
    for (var i = options.bufferPosition.column; i < line.length; i++) {
        var _char = line[i];
        if (_char === ':' || _char === '}' || _char === ',' || _char === '{') {
            break;
        }
        if (_char === '"') {
            hasTrailingQuote = true;
            break;
        }
    }
    var prefix = options.prefix;
    try {
        var cursor = options.editor.getLastCursor();
        var editor = options.editor;
        prefix = editor.getTextInBufferRange(cursor.getCurrentWordBufferRange({ wordRegex: /^[\t ]*$|[^\s\/\\\(\)"':,\;<>~!@#\$%\^&\*\|\+=\[\]\{\}`\?]+|[\/\\\(\)"':,\;<>~!@#\$%\^&\*\|\+=\[\]\{\}`\?]+/ }));
    } catch (e) {}
    prefix = _lodash2.default.trim(prefix, ':{}," ');
    var context = (0, _getRanges2.getPath)(options.editor, function (line, column) {
        return options.bufferPosition.row === line && options.bufferPosition.column === column + 1;
    });

    var _getRanges = (0, _getRanges2.getRanges)(options.editor);

    var ranges = _getRanges.ranges;
    var objectPaths = _getRanges.objectPaths;

    var existingKeys = (0, _lodash2.default)(_lodash2.default.keys(ranges)).filter(function (z) {
        return _lodash2.default.startsWith(z + '/', context.path);
    }).filter(function (z) {
        return z && z.indexOf('/') === -1;
    }).value();
    var p = _schemaProvider.schemaProvider.getSchemaForEditor(options.editor).flatMap(function (schema) {
        return schema.content;
    }).map(function (schema) {
        var p = (context.path || '').split('/');
        var rootSchema = schema;
        var parentSchema;
        while (p.length) {
            var lastSchema = schema;
            var s = p.shift();
            if (schema.properties && schema.properties[s]) {
                schema = schema.properties[s];
            } else if (schema.additionalProperties) {
                schema = schema.additionalProperties;
            } else if (schema !== rootSchema) {
                schema = {};
            }
            if (schema.$ref) {
                var childPath = _lodash2.default.trim(schema.$ref, '/#').split('/').join('.');
                schema = _lodash2.default.get(rootSchema, childPath);
            }
        }
        var inferedType = "";
        if (typeof schema.type === "string" && schema.type === "object") {
            inferedType = "object";
        }
        var objectPath = _lodash2.default.find(objectPaths, function (value, key) {
            return key === context.path;
        });
        if (objectPath && _lodash2.default.isArray(schema.type) && _lodash2.default.includes(schema.type, "object") && (options.bufferPosition.row == objectPath.line && options.bufferPosition.column + 1 > objectPath.column || options.bufferPosition.row > objectPath.line)) {
            inferedType = "object";
        }
        if (schema.enum && schema.enum.length) {
            return schema.enum.map(function (property) {
                return { key: property, type: 'enum', description: '' };
            });
        }
        if (inferedType === "object" && schema.properties && _lodash2.default.some(schema.properties)) {
            return _lodash2.default.keys(schema.properties).filter(function (z) {
                return !_lodash2.default.includes(existingKeys, z);
            }).map(function (property) {
                var propertySchema = schema.properties[property];
                return { key: property, type: typeof propertySchema.type === "string" ? propertySchema.type : 'property', description: propertySchema.description };
            });
        }
        var types = [];
        if (typeof schema.type === "string") {
            types = [schema.type];
        } else if (_lodash2.default.isArray(types)) {
            types = schema.type || [];
        }
        if (types.length > 1) {
            return _lodash2.default.map(types, function (type) {
                if (type === "string") {
                    return { key: '""', type: "value", description: '' };
                } else if (type === "object") {
                    var res = {};
                    _lodash2.default.each(schema.properties, function (value, key) {
                        if (value.type === "string") res[key] = value.default || '';
                    });
                    return { key: JSON.stringify(res, null, options.editor.getTabLength()), type: "value", description: '' };
                }
            });
        }
        return [];
    }).defaultIfEmpty([]).toPromise();
    var search = prefix;
    if (search === ".") search = "";
    if (search) p = p.then(function (s) {
        return filter(s, search, { key: 'key' });
    });
    var baseSuggestions = p.then(function (response) {
        return response.map(function (s) {
            return makeSuggestion(s, { replacementPrefix: prefix, hasLeadingQuote: hasLeadingQuote, hasTrailingQuote: hasTrailingQuote });
        });
    });
    if (providers.length) {
        var workingOptions = _lodash2.default.defaults({ prefix: prefix, replacementPrefix: prefix }, context, options);
        var workingProviders = _lodash2.default.filter(providers, function (z) {
            return _lodash2.default.includes(z.fileMatchs, options.editor.getBuffer().getBaseName()) && z.pathMatch(context.path);
        }).map(function (z) {
            return z.getSuggestions(workingOptions).then(function (suggestions) {
                return _lodash2.default.each(suggestions, function (s) {
                    return s.snippet = fixSnippet(s.snippet, { hasLeadingQuote: hasLeadingQuote, hasTrailingQuote: hasTrailingQuote }, 'other');
                });
            });
        });
        if (workingProviders.length) {
            return Promise.all(workingProviders.concat([baseSuggestions])).then(function (items) {
                return _lodash2.default.flatten(items);
            });
        }
    }
    return baseSuggestions;
}
var providers = [].concat(require('./providers/npm-provider')).concat(require('./providers/bower-provider'));
var CompletionProvider = exports.CompletionProvider = {
    selector: '.source.json',
    inclusionPriority: 2,
    excludeLowerPriority: false,
    getSuggestions: getSuggestions,
    registerProvider: function registerProvider(provider) {
        providers.push(provider);
    },
    onDidInsertSuggestion: function onDidInsertSuggestion(_ref) {
        var editor = _ref.editor;
        var suggestion = _ref.suggestion;

        if (_lodash2.default.endsWith(suggestion.text, '.')) {
            _lodash2.default.defer(function () {
                return atom.commands.dispatch(atom.views.getView(editor), "autocomplete-plus:activate");
            });
        }
    },
    dispose: function dispose() {}
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNjaGVtYS1hdXRvY29tcGxldGUuanMiLCJzY2hlbWEtYXV0b2NvbXBsZXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7OztBQUVBOztBQUNBOzs7O0FDQ0EsSUFBSSxTQUFTLFFBQVEsWUFBUixFQUFzQixNQUFuQzs7QUFZQSxTQUFBLFVBQUEsQ0FBb0IsT0FBcEIsRUFBcUMsT0FBckMsRUFBd0csSUFBeEcsRUFBb0g7QUFDaEgsUUFBSSxJQUFJLGlCQUFFLElBQUYsQ0FBTyxPQUFQLENBQVI7QUFDQSxRQUFJLGlCQUFFLFVBQUYsQ0FBYSxDQUFiLEVBQWdCLEdBQWhCLEtBQXdCLGlCQUFFLFVBQUYsQ0FBYSxDQUFiLEVBQWdCLEdBQWhCLENBQXhCLElBQWdELGlCQUFFLFFBQUYsQ0FBVyxDQUFYLEVBQWMsR0FBZCxDQUFoRCxJQUFzRSxpQkFBRSxRQUFGLENBQVcsQ0FBWCxFQUFjLEdBQWQsQ0FBdEUsSUFBNEYsaUJBQUUsUUFBRixDQUFXLENBQVgsRUFBYyxHQUFkLENBQWhHLEVBQ0ksT0FBTyxPQUFQO0FBRUosUUFBSSxDQUFDLFFBQVEsZUFBYixFQUNJLFVBQVUsTUFBTSxPQUFoQjtBQUNKLFFBQUksQ0FBQyxRQUFRLGdCQUFULElBQTZCLENBQUMsaUJBQUUsUUFBRixDQUFXLE9BQVgsRUFBb0IsR0FBcEIsQ0FBbEMsRUFDSSxVQUFVLFVBQVUsR0FBcEI7QUFFSixRQUFJLFNBQVMsUUFBYixFQUF1QjtBQUNuQixrQkFBVSxXQUFXLE1BQXJCO0FBQ0gsS0FGRCxNQUVPLElBQUksU0FBUyxRQUFiLEVBQXVCO0FBQzFCLGtCQUFVLFdBQVcsTUFBckI7QUFDSCxLQUZNLE1BRUEsSUFBSSxTQUFTLE9BQWIsRUFBc0I7QUFDekIsa0JBQVUsV0FBVyxNQUFyQjtBQUNIO0FBRUQsV0FBTyxPQUFQO0FBQ0g7QUFFRCxTQUFBLGNBQUEsQ0FBd0IsSUFBeEIsRUFBa0YsT0FBbEYsRUFBNks7QUFDekssUUFBSSxjQUFjLEtBQUssV0FB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QUEsWUFBNUYsVUFBNEYsUUFBNUYsVUFBNEY7O0FBQ3ZILFlBQUksaUJBQUUsUUFBRixDQUFXLFdBQVcsSUFBdEIsRUFBNEIsR0FBNUIsQ0FBSixFQUFzQztBQUNsQyw2QkFBRSxLQUFGLENBQVE7QUFBQSx1QkFBTSxLQUFLLFFBQUwsQ0FBYyxRQUFkLENBQXVCLEtBQUssS0FBTCxDQUFXLE9BQVgsQ0FBbUIsTUFBbkIsQ0FBdkIsRUFBbUQsNEJBQW5ELENBQU47QUFBQSxhQUFSO0FBQ0g7QUFDSixLQVoyQjtBQWE1QixXQWI0QixxQkFhckIsQ0FBTTtBQWJlLENBQXpCIiwiZmlsZSI6InNjaGVtYS1hdXRvY29tcGxldGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xudmFyIGZpbHRlciA9IHJlcXVpcmUoJ2Z1enphbGRyaW4nKS5maWx0ZXI7XG5pbXBvcnQgeyBnZXRQYXRoLCBnZXRSYW5nZXMgfSBmcm9tIFwiLi9oZWxwZXJzL2dldC1yYW5nZXNcIjtcbmltcG9ydCB7IHNjaGVtYVByb3ZpZGVyIH0gZnJvbSBcIi4vc2NoZW1hLXByb3ZpZGVyXCI7XG5mdW5jdGlvbiBmaXhTbmlwcGV0KHNuaXBwZXQsIG9wdGlvbnMsIHR5cGUpIHtcbiAgICBsZXQgdCA9IF8udHJpbShzbmlwcGV0KTtcbiAgICBpZiAoXy5zdGFydHNXaXRoKHQsICd7JykgfHwgXy5zdGFydHNXaXRoKHQsICdcIicpIHx8IF8uZW5kc1dpdGgodCwgJ30nKSB8fCBfLmVuZHNXaXRoKHQsICdcIicpIHx8IF8uZW5kc1dpdGgodCwgJywnKSlcbiAgICAgICAgcmV0dXJuIHNuaXBwZXQ7XG4gICAgaWYgKCFvcHRpb25zLmhhc0xlYWRpbmdRdW90ZSlcbiAgICAgICAgc25pcHBldCA9ICdcIicgKyBzbmlwcGV0O1xuICAgIGlmICghb3B0aW9ucy5oYXNUcmFpbGluZ1F1b3RlICYmICFfLmVuZHNXaXRoKHNuaXBwZXQsICcuJykpXG4gICAgICAgIHNuaXBwZXQgPSBzbmlwcGV0ICsgJ1wiJztcbiAgICBpZiAodHlwZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICBzbmlwcGV0ID0gc25pcHBldCArPSAnOiBcIlwiJztcbiAgICB9XG4gICAgZWxzZSBpZiAodHlwZSA9PT0gXCJvYmplY3RcIikge1xuICAgICAgICBzbmlwcGV0ID0gc25pcHBldCArPSAnOiB7fSc7XG4gICAgfVxuICAgIGVsc2UgaWYgKHR5cGUgPT09IFwiYXJyYXlcIikge1xuICAgICAgICBzbmlwcGV0ID0gc25pcHBldCArPSAnOiBbXSc7XG4gICAgfVxuICAgIHJldHVybiBzbmlwcGV0O1xufVxuZnVuY3Rpb24gbWFrZVN1Z2dlc3Rpb24oaXRlbSwgb3B0aW9ucykge1xuICAgIHZhciBkZXNjcmlwdGlvbiA9IGl0ZW0uZGVzY3JpcHRpb24sIGxlZnRMYWJlbCA9IGl0ZW0udHlwZS5zdWJzdHIoMCwgMSksIHR5cGUgPSAndmFyaWFibGUnO1xuICAgIHJldHVybiB7XG4gICAgICAgIF9zZWFyY2g6IGl0ZW0ua2V5LFxuICAgICAgICB0ZXh0OiBpdGVtLmtleSxcbiAgICAgICAgc25pcHBldDogZml4U25pcHBldChpdGVtLmtleSwgb3B0aW9ucywgaXRlbS50eXBlKSxcbiAgICAgICAgdHlwZTogdHlwZSxcbiAgICAgICAgZGlzcGxheVRleHQ6IGl0ZW0ua2V5LFxuICAgICAgICBjbGFzc05hbWU6ICdhdXRvY29tcGxldGUtanNvbi1zY2hlbWEnLFxuICAgICAgICBkZXNjcmlwdGlvbjogZGVzY3JpcHRpb24sXG4gICAgfTtcbn1cbmZ1bmN0aW9uIHJlbmRlclJldHVyblR5cGUocmV0dXJuVHlwZSkge1xuICAgIGlmIChyZXR1cm5UeXBlID09PSBudWxsKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgcmV0dXJuIGBSZXR1cm5zOiAke3JldHVyblR5cGV9YDtcbn1cbmZ1bmN0aW9uIHNjaGVtYUdldChzY2hlbWEsIHBhdGgpIHtcbiAgICB2YXIgcCA9IChwYXRoIHx8ICcnKS5zcGxpdCgnLycpO1xuICAgIHZhciByb290U2NoZW1hID0gc2NoZW1hO1xuICAgIHdoaWxlIChwLmxlbmd0aCkge1xuICAgICAgICBsZXQgcyA9IHAuc2hpZnQoKTtcbiAgICAgICAgaWYgKHNjaGVtYS5wcm9wZXJ0aWVzICYmIHNjaGVtYS5wcm9wZXJ0aWVzW3NdKSB7XG4gICAgICAgICAgICBzY2hlbWEgPSBzY2hlbWEucHJvcGVydGllc1tzXTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChzY2hlbWEuYWRkaXRpb25hbFByb3BlcnRpZXMpIHtcbiAgICAgICAgICAgIHNjaGVtYSA9IHNjaGVtYS5hZGRpdGlvbmFsUHJvcGVydGllcztcbiAgICAgICAgfVxuICAgICAgICBpZiAoc2NoZW1hLiRyZWYpIHtcbiAgICAgICAgICAgIHZhciBjaGlsZFBhdGggPSBfLnRyaW0oc2NoZW1hLiRyZWYsICcvIycpLnNwbGl0KCcvJykuam9pbignLicpO1xuICAgICAgICAgICAgc2NoZW1hID0gXy5nZXQocm9vdFNjaGVtYSwgY2hpbGRQYXRoKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gc2NoZW1hO1xufVxuZnVuY3Rpb24gZ2V0U3VnZ2VzdGlvbnMob3B0aW9ucykge1xuICAgIHZhciBsaW5lID0gb3B0aW9ucy5lZGl0b3IuZ2V0QnVmZmVyKCkuZ2V0TGluZXMoKVtvcHRpb25zLmJ1ZmZlclBvc2l0aW9uLnJvd107XG4gICAgdmFyIGhhc0xlYWRpbmdRdW90ZSA9IGZhbHNlO1xuICAgIGZvciAodmFyIGkgPSBvcHRpb25zLmJ1ZmZlclBvc2l0aW9uLmNvbHVtbjsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgbGV0IGNoYXIgPSBsaW5lW2ldO1xuICAgICAgICBpZiAoY2hhciA9PT0gJywnIHx8IGNoYXIgPT09ICd9JyB8fCBjaGFyID09PSAnOicpIHtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjaGFyID09PSAnXCInKSB7XG4gICAgICAgICAgICBoYXNMZWFkaW5nUXVvdGUgPSB0cnVlO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIGhhc1RyYWlsaW5nUXVvdGUgPSBmYWxzZTtcbiAgICBmb3IgKHZhciBpID0gb3B0aW9ucy5idWZmZXJQb3NpdGlvbi5jb2x1bW47IGkgPCBsaW5lLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGxldCBjaGFyID0gbGluZVtpXTtcbiAgICAgICAgaWYgKGNoYXIgPT09ICc6JyB8fCBjaGFyID09PSAnfScgfHwgY2hhciA9PT0gJywnIHx8IGNoYXIgPT09ICd7Jykge1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNoYXIgPT09ICdcIicpIHtcbiAgICAgICAgICAgIGhhc1RyYWlsaW5nUXVvdGUgPSB0cnVlO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdmFyIHByZWZpeCA9IG9wdGlvbnMucHJlZml4O1xuICAgIHRyeSB7XG4gICAgICAgIGxldCBjdXJzb3IgPSBvcHRpb25zLmVkaXRvci5nZXRMYXN0Q3Vyc29yKCk7XG4gICAgICAgIGxldCBlZGl0b3IgPSBvcHRpb25zLmVkaXRvcjtcbiAgICAgICAgcHJlZml4ID0gZWRpdG9yLmdldFRleHRJbkJ1ZmZlclJhbmdlKGN1cnNvci5nZXRDdXJyZW50V29yZEJ1ZmZlclJhbmdlKHsgd29yZFJlZ2V4OiAvXltcXHQgXSokfFteXFxzXFwvXFxcXFxcKFxcKVwiJzosXFw7PD5+IUAjXFwkJVxcXiZcXCpcXHxcXCs9XFxbXFxdXFx7XFx9YFxcP10rfFtcXC9cXFxcXFwoXFwpXCInOixcXDs8Pn4hQCNcXCQlXFxeJlxcKlxcfFxcKz1cXFtcXF1cXHtcXH1gXFw/XSsvIH0pKTtcbiAgICB9XG4gICAgY2F0Y2ggKGUpIHsgfVxuICAgIHByZWZpeCA9IF8udHJpbShwcmVmaXgsICc6e30sXCIgJyk7XG4gICAgdmFyIGNvbnRleHQgPSBnZXRQYXRoKG9wdGlvbnMuZWRpdG9yLCAobGluZSwgY29sdW1uKSA9PiBvcHRpb25zLmJ1ZmZlclBvc2l0aW9uLnJvdyA9PT0gbGluZSAmJiBvcHRpb25zLmJ1ZmZlclBvc2l0aW9uLmNvbHVtbiA9PT0gY29sdW1uICsgMSk7XG4gICAgdmFyIHsgcmFuZ2VzLCBvYmplY3RQYXRocyB9ID0gZ2V0UmFuZ2VzKG9wdGlvbnMuZWRpdG9yKTtcbiAgICB2YXIgZXhpc3RpbmdLZXlzID0gXyhfLmtleXMocmFuZ2VzKSlcbiAgICAgICAgLmZpbHRlcih6ID0+IF8uc3RhcnRzV2l0aCh6ICsgJy8nLCBjb250ZXh0LnBhdGgpKVxuICAgICAgICAuZmlsdGVyKHogPT4geiAmJiB6LmluZGV4T2YoJy8nKSA9PT0gLTEpXG4gICAgICAgIC52YWx1ZSgpO1xuICAgIHZhciBwID0gc2NoZW1hUHJvdmlkZXJcbiAgICAgICAgLmdldFNjaGVtYUZvckVkaXRvcihvcHRpb25zLmVkaXRvcilcbiAgICAgICAgLmZsYXRNYXAoc2NoZW1hID0+IHNjaGVtYS5jb250ZW50KVxuICAgICAgICAubWFwKHNjaGVtYSA9PiB7XG4gICAgICAgIHZhciBwID0gKGNvbnRleHQucGF0aCB8fCAnJykuc3BsaXQoJy8nKTtcbiAgICAgICAgdmFyIHJvb3RTY2hlbWEgPSBzY2hlbWE7XG4gICAgICAgIHZhciBwYXJlbnRTY2hlbWE7XG4gICAgICAgIHdoaWxlIChwLmxlbmd0aCkge1xuICAgICAgICAgICAgbGV0IGxhc3RTY2hlbWEgPSBzY2hlbWE7XG4gICAgICAgICAgICBsZXQgcyA9IHAuc2hpZnQoKTtcbiAgICAgICAgICAgIGlmIChzY2hlbWEucHJvcGVydGllcyAmJiBzY2hlbWEucHJvcGVydGllc1tzXSkge1xuICAgICAgICAgICAgICAgIHNjaGVtYSA9IHNjaGVtYS5wcm9wZXJ0aWVzW3NdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoc2NoZW1hLmFkZGl0aW9uYWxQcm9wZXJ0aWVzKSB7XG4gICAgICAgICAgICAgICAgc2NoZW1hID0gc2NoZW1hLmFkZGl0aW9uYWxQcm9wZXJ0aWVzO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoc2NoZW1hICE9PSByb290U2NoZW1hKSB7XG4gICAgICAgICAgICAgICAgc2NoZW1hID0ge307XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoc2NoZW1hLiRyZWYpIHtcbiAgICAgICAgICAgICAgICB2YXIgY2hpbGRQYXRoID0gXy50cmltKHNjaGVtYS4kcmVmLCAnLyMnKS5zcGxpdCgnLycpLmpvaW4oJy4nKTtcbiAgICAgICAgICAgICAgICBzY2hlbWEgPSBfLmdldChyb290U2NoZW1hLCBjaGlsZFBhdGgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHZhciBpbmZlcmVkVHlwZSA9IFwiXCI7XG4gICAgICAgIGlmICh0eXBlb2Ygc2NoZW1hLnR5cGUgPT09IFwic3RyaW5nXCIgJiYgc2NoZW1hLnR5cGUgPT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgICAgIGluZmVyZWRUeXBlID0gXCJvYmplY3RcIjtcbiAgICAgICAgfVxuICAgICAgICB2YXIgb2JqZWN0UGF0aCA9IF8uZmluZChvYmplY3RQYXRocywgKHZhbHVlLCBrZXkpID0+IGtleSA9PT0gY29udGV4dC5wYXRoKTtcbiAgICAgICAgaWYgKG9iamVjdFBhdGggJiYgXy5pc0FycmF5KHNjaGVtYS50eXBlKSAmJiBfLmluY2x1ZGVzKHNjaGVtYS50eXBlLCBcIm9iamVjdFwiKSAmJiAob3B0aW9ucy5idWZmZXJQb3NpdGlvbi5yb3cgPT0gb2JqZWN0UGF0aC5saW5lICYmIG9wdGlvbnMuYnVmZmVyUG9zaXRpb24uY29sdW1uICsgMSA+IG9iamVjdFBhdGguY29sdW1uIHx8IG9wdGlvbnMuYnVmZmVyUG9zaXRpb24ucm93ID4gb2JqZWN0UGF0aC5saW5lKSkge1xuICAgICAgICAgICAgaW5mZXJlZFR5cGUgPSBcIm9iamVjdFwiO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzY2hlbWEuZW51bSAmJiBzY2hlbWEuZW51bS5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiBzY2hlbWEuZW51bS5tYXAocHJvcGVydHkgPT4gKHsga2V5OiBwcm9wZXJ0eSwgdHlwZTogJ2VudW0nLCBkZXNjcmlwdGlvbjogJycgfSkpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChpbmZlcmVkVHlwZSA9PT0gXCJvYmplY3RcIiAmJiBzY2hlbWEucHJvcGVydGllcyAmJiBfLnNvbWUoc2NoZW1hLnByb3BlcnRpZXMpKSB7XG4gICAgICAgICAgICByZXR1cm4gXy5rZXlzKHNjaGVtYS5wcm9wZXJ0aWVzKVxuICAgICAgICAgICAgICAgIC5maWx0ZXIoeiA9PiAhXy5pbmNsdWRlcyhleGlzdGluZ0tleXMsIHopKVxuICAgICAgICAgICAgICAgIC5tYXAocHJvcGVydHkgPT4ge1xuICAgICAgICAgICAgICAgIHZhciBwcm9wZXJ0eVNjaGVtYSA9IHNjaGVtYS5wcm9wZXJ0aWVzW3Byb3BlcnR5XTtcbiAgICAgICAgICAgICAgICByZXR1cm4geyBrZXk6IHByb3BlcnR5LCB0eXBlOiB0eXBlb2YgcHJvcGVydHlTY2hlbWEudHlwZSA9PT0gXCJzdHJpbmdcIiA/IHByb3BlcnR5U2NoZW1hLnR5cGUgOiAncHJvcGVydHknLCBkZXNjcmlwdGlvbjogcHJvcGVydHlTY2hlbWEuZGVzY3JpcHRpb24gfTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHZhciB0eXBlcyA9IFtdO1xuICAgICAgICBpZiAodHlwZW9mIHNjaGVtYS50eXBlID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICB0eXBlcyA9IFtzY2hlbWEudHlwZV07XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoXy5pc0FycmF5KHR5cGVzKSkge1xuICAgICAgICAgICAgdHlwZXMgPSBzY2hlbWEudHlwZSB8fCBbXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZXMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgcmV0dXJuIF8ubWFwKHR5cGVzLCB0eXBlID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4geyBrZXk6ICdcIlwiJywgdHlwZTogXCJ2YWx1ZVwiLCBkZXNjcmlwdGlvbjogJycgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PT0gXCJvYmplY3RcIikge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcmVzID0ge307XG4gICAgICAgICAgICAgICAgICAgIF8uZWFjaChzY2hlbWEucHJvcGVydGllcywgKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZS50eXBlID09PSBcInN0cmluZ1wiKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc1trZXldID0gdmFsdWUuZGVmYXVsdCB8fCAnJztcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7IGtleTogSlNPTi5zdHJpbmdpZnkocmVzLCBudWxsLCBvcHRpb25zLmVkaXRvci5nZXRUYWJMZW5ndGgoKSksIHR5cGU6IFwidmFsdWVcIiwgZGVzY3JpcHRpb246ICcnIH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH0pXG4gICAgICAgIC5kZWZhdWx0SWZFbXB0eShbXSlcbiAgICAgICAgLnRvUHJvbWlzZSgpO1xuICAgIHZhciBzZWFyY2ggPSBwcmVmaXg7XG4gICAgaWYgKHNlYXJjaCA9PT0gXCIuXCIpXG4gICAgICAgIHNlYXJjaCA9IFwiXCI7XG4gICAgaWYgKHNlYXJjaClcbiAgICAgICAgcCA9IHAudGhlbihzID0+IGZpbHRlcihzLCBzZWFyY2gsIHsga2V5OiAna2V5JyB9KSk7XG4gICAgdmFyIGJhc2VTdWdnZXN0aW9ucyA9IHAudGhlbihyZXNwb25zZSA9PiByZXNwb25zZS5tYXAocyA9PiBtYWtlU3VnZ2VzdGlvbihzLCB7IHJlcGxhY2VtZW50UHJlZml4OiBwcmVmaXgsIGhhc0xlYWRpbmdRdW90ZSwgaGFzVHJhaWxpbmdRdW90ZSB9KSkpO1xuICAgIGlmIChwcm92aWRlcnMubGVuZ3RoKSB7XG4gICAgICAgIHZhciB3b3JraW5nT3B0aW9ucyA9IF8uZGVmYXVsdHMoeyBwcmVmaXgsIHJlcGxhY2VtZW50UHJlZml4OiBwcmVmaXggfSwgY29udGV4dCwgb3B0aW9ucyk7XG4gICAgICAgIHZhciB3b3JraW5nUHJvdmlkZXJzID0gXy5maWx0ZXIocHJvdmlkZXJzLCB6ID0+IF8uaW5jbHVkZXMoei5maWxlTWF0Y2hzLCBvcHRpb25zLmVkaXRvci5nZXRCdWZmZXIoKS5nZXRCYXNlTmFtZSgpKSAmJiB6LnBhdGhNYXRjaChjb250ZXh0LnBhdGgpKVxuICAgICAgICAgICAgLm1hcCh6ID0+IHouZ2V0U3VnZ2VzdGlvbnMod29ya2luZ09wdGlvbnMpLnRoZW4oc3VnZ2VzdGlvbnMgPT4gXy5lYWNoKHN1Z2dlc3Rpb25zLCBzID0+IHMuc25pcHBldCA9IGZpeFNuaXBwZXQocy5zbmlwcGV0LCB7IGhhc0xlYWRpbmdRdW90ZSwgaGFzVHJhaWxpbmdRdW90ZSB9LCAnb3RoZXInKSkpKTtcbiAgICAgICAgaWYgKHdvcmtpbmdQcm92aWRlcnMubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwod29ya2luZ1Byb3ZpZGVycy5jb25jYXQoW2Jhc2VTdWdnZXN0aW9uc10pKVxuICAgICAgICAgICAgICAgIC50aGVuKGl0ZW1zID0+IF8uZmxhdHRlbihpdGVtcykpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBiYXNlU3VnZ2VzdGlvbnM7XG59XG52YXIgcHJvdmlkZXJzID0gW10uY29uY2F0KHJlcXVpcmUoJy4vcHJvdmlkZXJzL25wbS1wcm92aWRlcicpKS5jb25jYXQocmVxdWlyZSgnLi9wcm92aWRlcnMvYm93ZXItcHJvdmlkZXInKSk7XG5leHBvcnQgdmFyIENvbXBsZXRpb25Qcm92aWRlciA9IHtcbiAgICBzZWxlY3RvcjogJy5zb3VyY2UuanNvbicsXG4gICAgaW5jbHVzaW9uUHJpb3JpdHk6IDIsXG4gICAgZXhjbHVkZUxvd2VyUHJpb3JpdHk6IGZhbHNlLFxuICAgIGdldFN1Z2dlc3Rpb25zLFxuICAgIHJlZ2lzdGVyUHJvdmlkZXI6IChwcm92aWRlcikgPT4ge1xuICAgICAgICBwcm92aWRlcnMucHVzaChwcm92aWRlcik7XG4gICAgfSxcbiAgICBvbkRpZEluc2VydFN1Z2dlc3Rpb24oeyBlZGl0b3IsIHN1Z2dlc3Rpb24gfSkge1xuICAgICAgICBpZiAoXy5lbmRzV2l0aChzdWdnZXN0aW9uLnRleHQsICcuJykpIHtcbiAgICAgICAgICAgIF8uZGVmZXIoKCkgPT4gYXRvbS5jb21tYW5kcy5kaXNwYXRjaChhdG9tLnZpZXdzLmdldFZpZXcoZWRpdG9yKSwgXCJhdXRvY29tcGxldGUtcGx1czphY3RpdmF0ZVwiKSk7XG4gICAgICAgIH1cbiAgICB9LFxuICAgIGRpc3Bvc2UoKSB7IH1cbn07XG4iLCJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xyXG5pbXBvcnQge1N1YmplY3QsIEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZX0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7Q29tcG9zaXRlRGlzcG9zYWJsZX0gZnJvbSAnLi9kaXNwb3NhYmxlcyc7XHJcbi8vdmFyIGVzY2FwZSA9IHJlcXVpcmUoXCJlc2NhcGUtaHRtbFwiKTtcclxudmFyIGZpbHRlciA9IHJlcXVpcmUoJ2Z1enphbGRyaW4nKS5maWx0ZXI7XHJcbmltcG9ydCB7Z2V0UGF0aCwgZ2V0UmFuZ2VzLCBJVG9rZW5SYW5nZX0gZnJvbSBcIi4vaGVscGVycy9nZXQtcmFuZ2VzXCI7XHJcbmltcG9ydCB7c2NoZW1hUHJvdmlkZXIsIElTY2hlbWFJbnN0YW5jZX0gZnJvbSBcIi4vc2NoZW1hLXByb3ZpZGVyXCI7XHJcblxyXG5pbnRlcmZhY2UgUmVxdWVzdE9wdGlvbnMge1xyXG4gICAgZWRpdG9yOiBBdG9tLlRleHRFZGl0b3I7XHJcbiAgICBidWZmZXJQb3NpdGlvbjogVGV4dEJ1ZmZlci5Qb2ludDsgLy8gdGhlIHBvc2l0aW9uIG9mIHRoZSBjdXJzb3JcclxuICAgIHByZWZpeDogc3RyaW5nO1xyXG4gICAgc2NvcGVEZXNjcmlwdG9yOiB7IHNjb3Blczogc3RyaW5nW10gfTtcclxuICAgIGFjdGl2YXRlZE1hbnVhbGx5OiBib29sZWFuO1xyXG59XHJcblxyXG5mdW5jdGlvbiBmaXhTbmlwcGV0KHNuaXBwZXQ6IHN0cmluZywgb3B0aW9uczogeyBoYXNUcmFpbGluZ1F1b3RlOiBib29sZWFuOyBoYXNMZWFkaW5nUXVvdGU6IGJvb2xlYW47IH0sIHR5cGU6IHN0cmluZykge1xyXG4gICAgbGV0IHQgPSBfLnRyaW0oc25pcHBldCk7XHJcbiAgICBpZiAoXy5zdGFydHNXaXRoKHQsICd7JykgfHwgXy5zdGFydHNXaXRoKHQsICdcIicpIHx8IF8uZW5kc1dpdGgodCwgJ30nKSB8fCBfLmVuZHNXaXRoKHQsICdcIicpIHx8IF8uZW5kc1dpdGgodCwgJywnKSlcclxuICAgICAgICByZXR1cm4gc25pcHBldDtcclxuXHJcbiAgICBpZiAoIW9wdGlvbnMuaGFzTGVhZGluZ1F1b3RlKVxyXG4gICAgICAgIHNuaXBwZXQgPSAnXCInICsgc25pcHBldDtcclxuICAgIGlmICghb3B0aW9ucy5oYXNUcmFpbGluZ1F1b3RlICYmICFfLmVuZHNXaXRoKHNuaXBwZXQsICcuJykpXHJcbiAgICAgICAgc25pcHBldCA9IHNuaXBwZXQgKyAnXCInO1xyXG5cclxuICAgIGlmICh0eXBlID09PSBcInN0cmluZ1wiKSB7XHJcbiAgICAgICAgc25pcHBldCA9IHNuaXBwZXQgKz0gJzogXCJcIidcclxuICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gXCJvYmplY3RcIikge1xyXG4gICAgICAgIHNuaXBwZXQgPSBzbmlwcGV0ICs9ICc6IHt9J1xyXG4gICAgfSBlbHNlIGlmICh0eXBlID09PSBcImFycmF5XCIpIHtcclxuICAgICAgICBzbmlwcGV0ID0gc25pcHBldCArPSAnOiBbXSdcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gc25pcHBldDtcclxufVxyXG5cclxuZnVuY3Rpb24gbWFrZVN1Z2dlc3Rpb24oaXRlbTogeyBrZXk6IHN0cmluZzsgZGVzY3JpcHRpb246IHN0cmluZzsgdHlwZTogc3RyaW5nIH0sIG9wdGlvbnM6IHsgcmVwbGFjZW1lbnRQcmVmaXg6IHN0cmluZzsgaGFzVHJhaWxpbmdRdW90ZTogYm9vbGVhbjsgaGFzTGVhZGluZ1F1b3RlOiBib29sZWFuIH0pIHtcclxuICAgIHZhciBkZXNjcmlwdGlvbiA9IGl0ZW0uZGVzY3JpcHRpb24sXHJcbiAgICAgICAgbGVmdExhYmVsID0gaXRlbS50eXBlLnN1YnN0cigwLCAxKSxcclxuICAgICAgICB0eXBlID0gJ3ZhcmlhYmxlJztcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIF9zZWFyY2g6IGl0ZW0ua2V5LFxyXG4gICAgICAgIHRleHQ6IGl0ZW0ua2V5LFxyXG4gICAgICAgIHNuaXBwZXQ6IGZpeFNuaXBwZXQoaXRlbS5rZXksIG9wdGlvbnMsIGl0ZW0udHlwZSksXHJcbiAgICAgICAgdHlwZTogdHlwZSxcclxuICAgICAgICBkaXNwbGF5VGV4dDogaXRlbS5rZXksXHJcbiAgICAgICAgY2xhc3NOYW1lOiAnYXV0b2NvbXBsZXRlLWpzb24tc2NoZW1hJyxcclxuICAgICAgICBkZXNjcmlwdGlvbjogZGVzY3JpcHRpb24sXHJcbiAgICAgICAgLy9sZWZ0TGFiZWw6IGxlZnRMYWJlbCxcclxuICAgIH07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJlbmRlclJldHVyblR5cGUocmV0dXJuVHlwZTogc3RyaW5nKSB7XHJcbiAgICBpZiAocmV0dXJuVHlwZSA9PT0gbnVsbCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHJldHVybiBgUmV0dXJuczogJHtyZXR1cm5UeXBlfWA7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNjaGVtYUdldChzY2hlbWE6IElTY2hlbWFJbnN0YW5jZSwgcGF0aDogc3RyaW5nKSB7XHJcbiAgICAvLyBpZ25vcmUgLmRhdGFcclxuICAgIHZhciBwID0gKHBhdGggfHwgJycpLnNwbGl0KCcvJyk7XHJcbiAgICB2YXIgcm9vdFNjaGVtYSA9IHNjaGVtYTtcclxuICAgIHdoaWxlIChwLmxlbmd0aCkge1xyXG4gICAgICAgIGxldCBzID0gcC5zaGlmdCgpO1xyXG4gICAgICAgIGlmIChzY2hlbWEucHJvcGVydGllcyAmJiBzY2hlbWEucHJvcGVydGllc1tzXSkge1xyXG4gICAgICAgICAgICBzY2hlbWEgPSBzY2hlbWEucHJvcGVydGllc1tzXVxyXG4gICAgICAgIH0gZWxzZSBpZiAoc2NoZW1hLmFkZGl0aW9uYWxQcm9wZXJ0aWVzKSB7XHJcbiAgICAgICAgICAgIHNjaGVtYSA9IHNjaGVtYS5hZGRpdGlvbmFsUHJvcGVydGllcztcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHNjaGVtYS4kcmVmKSB7XHJcbiAgICAgICAgICAgIC8vIFRoaXMgaXMgdGhlIG1vc3QgY29tbW9uIGRlZiBjYXNlLCBtYXkgbm90IGFsd2F5cyB3b3JrXHJcbiAgICAgICAgICAgIHZhciBjaGlsZFBhdGggPSBfLnRyaW0oc2NoZW1hLiRyZWYsICcvIycpLnNwbGl0KCcvJykuam9pbignLicpO1xyXG4gICAgICAgICAgICBzY2hlbWEgPSBfLmdldDxJU2NoZW1hSW5zdGFuY2U+KHJvb3RTY2hlbWEsIGNoaWxkUGF0aCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHNjaGVtYTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0U3VnZ2VzdGlvbnMob3B0aW9uczogUmVxdWVzdE9wdGlvbnMpOiBQcm9taXNlPFN1Z2dlc3Rpb25bXT4ge1xyXG4gICAgLyp2YXIgYnVmZmVyID0gb3B0aW9ucy5lZGl0b3IuZ2V0QnVmZmVyKCk7XHJcbiAgICB2YXIgZW5kID0gb3B0aW9ucy5idWZmZXJQb3NpdGlvbi5jb2x1bW47XHJcbiAgICB2YXIgZGF0YSA9IGJ1ZmZlci5nZXRMaW5lcygpW29wdGlvbnMuYnVmZmVyUG9zaXRpb24ucm93XS5zdWJzdHJpbmcoMCwgZW5kICsgMSk7XHJcbiAgICB2YXIgbGFzdENoYXJhY3RlclR5cGVkID0gZGF0YVtlbmQgLSAxXTtcclxuXHJcbiAgICBpZiAoIS9bQS1aXzAtOS5dKy9pLnRlc3QobGFzdENoYXJhY3RlclR5cGVkKSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH0qL1xyXG4gICAgdmFyIGxpbmUgPSBvcHRpb25zLmVkaXRvci5nZXRCdWZmZXIoKS5nZXRMaW5lcygpW29wdGlvbnMuYnVmZmVyUG9zaXRpb24ucm93XTtcclxuICAgIHZhciBoYXNMZWFkaW5nUXVvdGUgPSBmYWxzZTtcclxuICAgIGZvciAodmFyIGkgPSBvcHRpb25zLmJ1ZmZlclBvc2l0aW9uLmNvbHVtbjsgaSA+PSAwOyBpLS0pIHtcclxuICAgICAgICBsZXQgY2hhciA9IGxpbmVbaV07XHJcbiAgICAgICAgaWYgKGNoYXIgPT09ICcsJyB8fCBjaGFyID09PSAnfScgfHwgY2hhciA9PT0gJzonKSB7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGNoYXIgPT09ICdcIicpIHtcclxuICAgICAgICAgICAgaGFzTGVhZGluZ1F1b3RlID0gdHJ1ZTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgdmFyIGhhc1RyYWlsaW5nUXVvdGUgPSBmYWxzZTtcclxuICAgIGZvciAodmFyIGkgPSBvcHRpb25zLmJ1ZmZlclBvc2l0aW9uLmNvbHVtbjsgaSA8IGxpbmUubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBsZXQgY2hhciA9IGxpbmVbaV07XHJcbiAgICAgICAgaWYgKGNoYXIgPT09ICc6JyB8fCBjaGFyID09PSAnfScgfHwgY2hhciA9PT0gJywnIHx8IGNoYXIgPT09ICd7Jykge1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChjaGFyID09PSAnXCInKSB7XHJcbiAgICAgICAgICAgIGhhc1RyYWlsaW5nUXVvdGUgPSB0cnVlO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdmFyIHByZWZpeCA9IG9wdGlvbnMucHJlZml4O1xyXG4gICAgdHJ5IHtcclxuICAgICAgICBsZXQgY3Vyc29yID0gb3B0aW9ucy5lZGl0b3IuZ2V0TGFzdEN1cnNvcigpO1xyXG4gICAgICAgIGxldCBlZGl0b3IgPSBvcHRpb25zLmVkaXRvcjtcclxuICAgICAgICBwcmVmaXggPSA8YW55PmVkaXRvci5nZXRUZXh0SW5CdWZmZXJSYW5nZShjdXJzb3IuZ2V0Q3VycmVudFdvcmRCdWZmZXJSYW5nZSh7IHdvcmRSZWdleDogL15bXFx0IF0qJHxbXlxcc1xcL1xcXFxcXChcXClcIic6LFxcOzw+fiFAI1xcJCVcXF4mXFwqXFx8XFwrPVxcW1xcXVxce1xcfWBcXD9dK3xbXFwvXFxcXFxcKFxcKVwiJzosXFw7PD5+IUAjXFwkJVxcXiZcXCpcXHxcXCs9XFxbXFxdXFx7XFx9YFxcP10rLyB9KSk7XHJcbiAgICB9IGNhdGNoIChlKSB7IH1cclxuXHJcbiAgICBwcmVmaXggPSBfLnRyaW0ocHJlZml4LCAnOnt9LFwiICcpO1xyXG5cclxuICAgIHZhciBjb250ZXh0ID0gZ2V0UGF0aChvcHRpb25zLmVkaXRvciwgKGxpbmUsIGNvbHVtbikgPT5cclxuICAgICAgICBvcHRpb25zLmJ1ZmZlclBvc2l0aW9uLnJvdyA9PT0gbGluZSAmJiBvcHRpb25zLmJ1ZmZlclBvc2l0aW9uLmNvbHVtbiA9PT0gY29sdW1uICsgMSk7XHJcblxyXG4gICAgdmFyIHtyYW5nZXMsIG9iamVjdFBhdGhzfSA9IGdldFJhbmdlcyhvcHRpb25zLmVkaXRvcik7XHJcbiAgICB2YXIgZXhpc3RpbmdLZXlzID0gXyhfLmtleXMocmFuZ2VzKSlcclxuICAgICAgICAuZmlsdGVyKHogPT4gXy5zdGFydHNXaXRoKHogKyAnLycsIGNvbnRleHQucGF0aCkpXHJcbiAgICAgICAgLmZpbHRlcih6ID0+IHogJiYgei5pbmRleE9mKCcvJykgPT09IC0xKVxyXG4gICAgICAgIC52YWx1ZSgpO1xyXG5cclxuICAgIHZhciBwID0gc2NoZW1hUHJvdmlkZXJcclxuICAgICAgICAuZ2V0U2NoZW1hRm9yRWRpdG9yKG9wdGlvbnMuZWRpdG9yKVxyXG4gICAgICAgIC5mbGF0TWFwKHNjaGVtYSA9PiBzY2hlbWEuY29udGVudClcclxuICAgICAgICAubWFwKHNjaGVtYSA9PiB7XHJcbiAgICAgICAgICAgIC8vIGlnbm9yZSAuZGF0YVxyXG4gICAgICAgICAgICB2YXIgcCA9IChjb250ZXh0LnBhdGggfHwgJycpLnNwbGl0KCcvJyk7XHJcbiAgICAgICAgICAgIHZhciByb290U2NoZW1hID0gc2NoZW1hO1xyXG5cclxuICAgICAgICAgICAgdmFyIHBhcmVudFNjaGVtYTogYW55O1xyXG4gICAgICAgICAgICB3aGlsZSAocC5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIGxldCBsYXN0U2NoZW1hID0gc2NoZW1hO1xyXG4gICAgICAgICAgICAgICAgbGV0IHMgPSBwLnNoaWZ0KCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoc2NoZW1hLnByb3BlcnRpZXMgJiYgc2NoZW1hLnByb3BlcnRpZXNbc10pIHtcclxuICAgICAgICAgICAgICAgICAgICBzY2hlbWEgPSBzY2hlbWEucHJvcGVydGllc1tzXVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzY2hlbWEuYWRkaXRpb25hbFByb3BlcnRpZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICBzY2hlbWEgPSBzY2hlbWEuYWRkaXRpb25hbFByb3BlcnRpZXM7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNjaGVtYSAhPT0gcm9vdFNjaGVtYSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHNjaGVtYSA9IDxhbnk+e307XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoc2NoZW1hLiRyZWYpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIHRoZSBtb3N0IGNvbW1vbiBkZWYgY2FzZSwgbWF5IG5vdCBhbHdheXMgd29ya1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZFBhdGggPSBfLnRyaW0oc2NoZW1hLiRyZWYsICcvIycpLnNwbGl0KCcvJykuam9pbignLicpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNjaGVtYSA9IF8uZ2V0PElTY2hlbWFJbnN0YW5jZT4ocm9vdFNjaGVtYSwgY2hpbGRQYXRoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdmFyIGluZmVyZWRUeXBlID0gXCJcIjtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBzY2hlbWEudHlwZSA9PT0gXCJzdHJpbmdcIiAmJiBzY2hlbWEudHlwZSA9PT0gXCJvYmplY3RcIikge1xyXG4gICAgICAgICAgICAgICAgaW5mZXJlZFR5cGUgPSBcIm9iamVjdFwiO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB2YXIgb2JqZWN0UGF0aCA9IF8uZmluZChvYmplY3RQYXRocywgKHZhbHVlLCBrZXkpID0+IGtleSA9PT0gY29udGV4dC5wYXRoKTtcclxuICAgICAgICAgICAgaWYgKG9iamVjdFBhdGggJiYgXy5pc0FycmF5KHNjaGVtYS50eXBlKSAmJiBfLmluY2x1ZGVzKHNjaGVtYS50eXBlLCBcIm9iamVjdFwiKSAmJiAob3B0aW9ucy5idWZmZXJQb3NpdGlvbi5yb3cgPT0gb2JqZWN0UGF0aC5saW5lICYmIG9wdGlvbnMuYnVmZmVyUG9zaXRpb24uY29sdW1uICsgMSA+IG9iamVjdFBhdGguY29sdW1uIHx8IG9wdGlvbnMuYnVmZmVyUG9zaXRpb24ucm93ID4gb2JqZWN0UGF0aC5saW5lKSkge1xyXG4gICAgICAgICAgICAgICAgaW5mZXJlZFR5cGUgPSBcIm9iamVjdFwiO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoc2NoZW1hLmVudW0gJiYgc2NoZW1hLmVudW0ubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gc2NoZW1hLmVudW0ubWFwKHByb3BlcnR5ID0+ICh7IGtleTogcHJvcGVydHksIHR5cGU6ICdlbnVtJywgZGVzY3JpcHRpb246ICcnIH0pKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGluZmVyZWRUeXBlID09PSBcIm9iamVjdFwiICYmIHNjaGVtYS5wcm9wZXJ0aWVzICYmIF8uc29tZShzY2hlbWEucHJvcGVydGllcykpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBfLmtleXMoc2NoZW1hLnByb3BlcnRpZXMpXHJcbiAgICAgICAgICAgICAgICAgICAgLmZpbHRlcih6ID0+ICFfLmluY2x1ZGVzKGV4aXN0aW5nS2V5cywgeikpXHJcbiAgICAgICAgICAgICAgICAgICAgLm1hcChwcm9wZXJ0eSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcm9wZXJ0eVNjaGVtYSA9IHNjaGVtYS5wcm9wZXJ0aWVzW3Byb3BlcnR5XTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsga2V5OiBwcm9wZXJ0eSwgdHlwZTogdHlwZW9mIHByb3BlcnR5U2NoZW1hLnR5cGUgPT09IFwic3RyaW5nXCIgPyA8c3RyaW5nPnByb3BlcnR5U2NoZW1hLnR5cGUgOiAncHJvcGVydHknLCBkZXNjcmlwdGlvbjogcHJvcGVydHlTY2hlbWEuZGVzY3JpcHRpb24gfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB2YXIgdHlwZXM6IHN0cmluZ1tdID0gW107XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygc2NoZW1hLnR5cGUgPT09IFwic3RyaW5nXCIpIHtcclxuICAgICAgICAgICAgICAgIHR5cGVzID0gPGFueT5bc2NoZW1hLnR5cGVdO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKF8uaXNBcnJheSh0eXBlcykpIHtcclxuICAgICAgICAgICAgICAgIHR5cGVzID0gPGFueT5zY2hlbWEudHlwZSB8fCBbXTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHR5cGVzLmxlbmd0aCA+IDEpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBfLm1hcCh0eXBlcywgdHlwZSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IFwic3RyaW5nXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsga2V5OiAnXCJcIicsIHR5cGU6IFwidmFsdWVcIiwgZGVzY3JpcHRpb246ICcnIH07XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSBcIm9iamVjdFwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXMgPSB7fTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgXy5lYWNoKHNjaGVtYS5wcm9wZXJ0aWVzLCAodmFsdWUsIGtleSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlLnR5cGUgPT09IFwic3RyaW5nXCIpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzW2tleV0gPSB2YWx1ZS5kZWZhdWx0IHx8ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsga2V5OiBKU09OLnN0cmluZ2lmeShyZXMsIG51bGwsIG9wdGlvbnMuZWRpdG9yLmdldFRhYkxlbmd0aCgpKSwgdHlwZTogXCJ2YWx1ZVwiLCBkZXNjcmlwdGlvbjogJycgfTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIFtdO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmRlZmF1bHRJZkVtcHR5KFtdKVxyXG4gICAgICAgIC50b1Byb21pc2UoKTtcclxuXHJcbiAgICB2YXIgc2VhcmNoID0gcHJlZml4O1xyXG4gICAgaWYgKHNlYXJjaCA9PT0gXCIuXCIpXHJcbiAgICAgICAgc2VhcmNoID0gXCJcIjtcclxuXHJcbiAgICAvL29wdGlvbnMucHJlZml4ID0gcHJlZml4O1xyXG5cclxuICAgIGlmIChzZWFyY2gpXHJcbiAgICAgICAgcCA9IHAudGhlbihzID0+XHJcbiAgICAgICAgICAgIGZpbHRlcihzLCBzZWFyY2gsIHsga2V5OiAna2V5JyB9KSk7XHJcblxyXG4gICAgdmFyIGJhc2VTdWdnZXN0aW9ucyA9IHAudGhlbihyZXNwb25zZSA9PiByZXNwb25zZS5tYXAocyA9PiBtYWtlU3VnZ2VzdGlvbihzLCB7IHJlcGxhY2VtZW50UHJlZml4OiBwcmVmaXgsIGhhc0xlYWRpbmdRdW90ZSwgaGFzVHJhaWxpbmdRdW90ZSB9KSkpO1xyXG5cclxuICAgIGlmIChwcm92aWRlcnMubGVuZ3RoKSB7XHJcbiAgICAgICAgdmFyIHdvcmtpbmdPcHRpb25zID0gPElBdXRvY29tcGxldGVQcm92aWRlck9wdGlvbnM+Xy5kZWZhdWx0cyh7IHByZWZpeCwgcmVwbGFjZW1lbnRQcmVmaXg6IHByZWZpeCB9LCBjb250ZXh0LCBvcHRpb25zKTtcclxuICAgICAgICB2YXIgd29ya2luZ1Byb3ZpZGVycyA9IF8uZmlsdGVyKHByb3ZpZGVycywgeiA9PlxyXG4gICAgICAgICAgICBfLmluY2x1ZGVzKHouZmlsZU1hdGNocywgb3B0aW9ucy5lZGl0b3IuZ2V0QnVmZmVyKCkuZ2V0QmFzZU5hbWUoKSkgJiYgei5wYXRoTWF0Y2goY29udGV4dC5wYXRoKSlcclxuICAgICAgICAgICAgLm1hcCh6ID0+IHouZ2V0U3VnZ2VzdGlvbnMod29ya2luZ09wdGlvbnMpLnRoZW4oc3VnZ2VzdGlvbnMgPT5cclxuICAgICAgICAgICAgICAgIF8uZWFjaChzdWdnZXN0aW9ucywgcyA9PiBzLnNuaXBwZXQgPSBmaXhTbmlwcGV0KHMuc25pcHBldCwgeyBoYXNMZWFkaW5nUXVvdGUsIGhhc1RyYWlsaW5nUXVvdGUgfSwgJ290aGVyJykpKSk7XHJcbiAgICAgICAgaWYgKHdvcmtpbmdQcm92aWRlcnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbCh3b3JraW5nUHJvdmlkZXJzLmNvbmNhdChbYmFzZVN1Z2dlc3Rpb25zXSkpXHJcbiAgICAgICAgICAgICAgICAudGhlbihpdGVtcyA9PlxyXG4gICAgICAgICAgICAgICAgICAgIF8uZmxhdHRlbihpdGVtcykpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBiYXNlU3VnZ2VzdGlvbnM7XHJcbn1cclxuXHJcbnZhciBwcm92aWRlcnM6IElBdXRvY29tcGxldGVQcm92aWRlcltdID0gW10uY29uY2F0KHJlcXVpcmUoJy4vcHJvdmlkZXJzL25wbS1wcm92aWRlcicpKS5jb25jYXQocmVxdWlyZSgnLi9wcm92aWRlcnMvYm93ZXItcHJvdmlkZXInKSk7XHJcblxyXG5leHBvcnQgdmFyIENvbXBsZXRpb25Qcm92aWRlciA9IHtcclxuICAgIHNlbGVjdG9yOiAnLnNvdXJjZS5qc29uJyxcclxuICAgIGluY2x1c2lvblByaW9yaXR5OiAyLFxyXG4gICAgZXhjbHVkZUxvd2VyUHJpb3JpdHk6IGZhbHNlLFxyXG4gICAgZ2V0U3VnZ2VzdGlvbnMsXHJcbiAgICByZWdpc3RlclByb3ZpZGVyOiAocHJvdmlkZXI6IGFueSkgPT4ge1xyXG4gICAgICAgIHByb3ZpZGVycy5wdXNoKHByb3ZpZGVyKTtcclxuICAgIH0sXHJcbiAgICBvbkRpZEluc2VydFN1Z2dlc3Rpb24oe2VkaXRvciwgc3VnZ2VzdGlvbn06IHsgZWRpdG9yOiBBdG9tLlRleHRFZGl0b3I7IHRyaWdnZXJQb3NpdGlvbjogYW55OyBzdWdnZXN0aW9uOiB7IHRleHQ6IHN0cmluZyB9IH0pIHtcclxuICAgICAgICBpZiAoXy5lbmRzV2l0aChzdWdnZXN0aW9uLnRleHQsICcuJykpIHtcclxuICAgICAgICAgICAgXy5kZWZlcigoKSA9PiBhdG9tLmNvbW1hbmRzLmRpc3BhdGNoKGF0b20udmlld3MuZ2V0VmlldyhlZGl0b3IpLCBcImF1dG9jb21wbGV0ZS1wbHVzOmFjdGl2YXRlXCIpKVxyXG4gICAgICAgIH1cclxuICAgIH0sXHJcbiAgICBkaXNwb3NlKCkgeyB9XHJcbn1cclxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
