'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.provider = undefined;

var _jsonSchemaService = require('./vscode/plugin/jsonSchemaService');

var _jsonParser = require('./vscode/plugin/jsonParser');

var Range = require('atom').Range;

var jsonSchemaService = new _jsonSchemaService.JSONSchemaService();
function getWordAt(str, pos) {
    var wordLocation = {
        start: pos,
        end: pos
    };
    if (str === undefined) {
        return wordLocation;
    }
    while (pos < str.length && /\W/.test(str[pos])) {
        ++pos;
    }
    var left = str.slice(0, pos + 1).search(/\W(?!.*\W)/);
    var right = str.slice(pos).search(/(\W|$)/);
    wordLocation.start = left + 1;
    wordLocation.end = wordLocation.start + right;
    return wordLocation;
}
function mapValues(editor, ranges, error) {
    var range = ranges[error.field.replace('data.', '')];
    if (!range) {
        return null;
    }
    var line = range.section.start[0];
    var column = range.section.start[1];
    var text = editor.lineTextForBufferRow(line);
    var level = 'error';
    return {
        type: level,
        text: error.field + ' - ' + error.message,
        filePath: editor.getPath(),
        line: line + 1,
        col: column + 1,
        range: new Range(range.value.start, range.value.end)
    };
}
var provider = exports.provider = [{
    grammarScopes: ['source.json'],
    scope: 'file',
    lintOnFly: true,
    lint: function lint(editor) {
        if (editor.getText().length === 0) {
            return Promise.resolve([]);
        }
        var jsonDocument = (0, _jsonParser.parse)(editor.getText());
        return jsonSchemaService.getSchemaForResource(editor.getURI(), jsonDocument).then(function (schema) {
            if (schema) {
                if (schema.errors.length && jsonDocument.root) {
                    var astRoot = jsonDocument.root;
                    var property = astRoot.type === 'object' ? astRoot.getFirstProperty('$schema') : null;
                    if (property) {
                        var node = property.value || property;
                        jsonDocument.warnings.push({ location: { start: node.start, end: node.end }, message: schema.errors[0] });
                    } else {
                        jsonDocument.warnings.push({ location: { start: astRoot.start, end: astRoot.start + 1 }, message: schema.errors[0] });
                    }
                } else {
                    jsonDocument.validate(schema.schema);
                }
            }
            var diagnostics = [];
            jsonDocument.errors.concat(jsonDocument.warnings).forEach(function (error, idx) {
                var signature = error.location.start + ' ' + error.location.end + ' ' + error.message;
                var location = editor.getBuffer().positionForCharacterIndex(error.location.start);
                diagnostics.push({
                    type: idx >= jsonDocument.errors.length ? "warning" : "error",
                    text: signature,
                    filePath: editor.getPath(),
                    line: location.row + 1,
                    col: location.column + 1,
                    range: new Range(error.location.start, error.location.end)
                });
            });
            return diagnostics;
        });
    }
}];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNjaGVtYS1saW50ZXIuanMiLCJzY2hlbWEtbGludGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFDQTs7QUFDQTs7QUNGQSxJQUFJLFFBQVEsUUFBUSxNQUFSLEVBQWdCLEtBQTVCOztBQVVBLElBQU0sb0JBQW9CLDBDQUExQjtBQXVCQSxTQUFBLFNBQUEsQ0FBbUIsR0FBbkIsRUFBZ0MsR0FBaEMsRUFBMkM7QUFDdkMsUUFBSSxlQUFlO0FBQ2YsZUFBTyxHQURRO0FBRWYsYUFBSztBQUZVLEtBQW5CO0FBS0EsUUFBSSxRQUFRLFNBQVosRUFBdUI7QUFDbkIsZUFBTyxZQUFQO0FBQ0g7QUFFRCxXQUFPLE1BQU0sSUFBSSxNQUFWLElBQW9CLEtBQUssSUFBTCxDQUFVLElBQUksR0FBSixDQUFWLENBQTNCLEVBQWdEO0FBQzVDLFVBQUUsR0FBRjtBQUNIO0FBRUQsUUFBSSxPQUFPLElBQUksS0FBSixDQUFVLENBQVYsRUFBYSxNQUFNLENBQW5CLEVBQXNCLE1BQXRCLENBQTZCLFlBQTdCLENBQVg7QUFDQSxRQUFJLFFBQVEsSUFBSSxLQUFKLENBQVUsR0FBVixFQUFlLE1BQWYsQ0FBc0IsUUFBdEIsQ0FBWjtBQUVBLGlCQUFhLEtBQWIsR0FBcUIsT0FBTyxDQUE1QjtBQUNBLGlCQUFhLEdBQWIsR0FBbUIsYUFBYSxLQUFiLEdBQXFCLEtBQXhDO0FBRUEsV0FBTyxZQUFQO0FBQ0g7QUFFRCxTQUFBLFNBQUEsQ0FBbUIsTUFBbkIsRUFBNEMsTUFBNUMsRUFBb0YsS0FBcEYsRUFBeUc7QUFDckcsUUFBSSxRQUFRLE9BQU8sTUFBTSxLQUFOLENBQVksT0FBWixDQUFvQixPQUFwQixFQUE2QixFQUE3QixDQUFQLENBQVo7QUFDQSxRQUFJLENBQUMsS0FBTCxFQUFZO0FBRVIsZUFBTyxJQUFQO0FBQ0g7QUFDRCxRQUFJLE9BQU8sTUFBTSxPQUFOLENBQWMsS0FBZCxDQUFvQixDQUFwQixDQUFYO0FBQ0EsUUFBSSxTQUFTLE1BQU0sT0FBTixD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QUFRSCxhQWJEO0FBZUEsbUJBQU8sV0FBUDtBQUNILFNBakNNLENBQVA7QUFrQ0g7QUE3Q0wsQ0FEa0IsQ0FBZiIsImZpbGUiOiJzY2hlbWEtbGludGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIFJhbmdlID0gcmVxdWlyZSgnYXRvbScpLlJhbmdlO1xuaW1wb3J0IHsgSlNPTlNjaGVtYVNlcnZpY2UgfSBmcm9tICcuL3ZzY29kZS9wbHVnaW4vanNvblNjaGVtYVNlcnZpY2UnO1xuaW1wb3J0IHsgcGFyc2UgYXMgcGFyc2VKU09OIH0gZnJvbSAnLi92c2NvZGUvcGx1Z2luL2pzb25QYXJzZXInO1xuY29uc3QganNvblNjaGVtYVNlcnZpY2UgPSBuZXcgSlNPTlNjaGVtYVNlcnZpY2UoKTtcbmZ1bmN0aW9uIGdldFdvcmRBdChzdHIsIHBvcykge1xuICAgIHZhciB3b3JkTG9jYXRpb24gPSB7XG4gICAgICAgIHN0YXJ0OiBwb3MsXG4gICAgICAgIGVuZDogcG9zXG4gICAgfTtcbiAgICBpZiAoc3RyID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIHdvcmRMb2NhdGlvbjtcbiAgICB9XG4gICAgd2hpbGUgKHBvcyA8IHN0ci5sZW5ndGggJiYgL1xcVy8udGVzdChzdHJbcG9zXSkpIHtcbiAgICAgICAgKytwb3M7XG4gICAgfVxuICAgIHZhciBsZWZ0ID0gc3RyLnNsaWNlKDAsIHBvcyArIDEpLnNlYXJjaCgvXFxXKD8hLipcXFcpLyk7XG4gICAgdmFyIHJpZ2h0ID0gc3RyLnNsaWNlKHBvcykuc2VhcmNoKC8oXFxXfCQpLyk7XG4gICAgd29yZExvY2F0aW9uLnN0YXJ0ID0gbGVmdCArIDE7XG4gICAgd29yZExvY2F0aW9uLmVuZCA9IHdvcmRMb2NhdGlvbi5zdGFydCArIHJpZ2h0O1xuICAgIHJldHVybiB3b3JkTG9jYXRpb247XG59XG5mdW5jdGlvbiBtYXBWYWx1ZXMoZWRpdG9yLCByYW5nZXMsIGVycm9yKSB7XG4gICAgdmFyIHJhbmdlID0gcmFuZ2VzW2Vycm9yLmZpZWxkLnJlcGxhY2UoJ2RhdGEuJywgJycpXTtcbiAgICBpZiAoIXJhbmdlKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICB2YXIgbGluZSA9IHJhbmdlLnNlY3Rpb24uc3RhcnRbMF07XG4gICAgdmFyIGNvbHVtbiA9IHJhbmdlLnNlY3Rpb24uc3RhcnRbMV07XG4gICAgdmFyIHRleHQgPSBlZGl0b3IubGluZVRleHRGb3JCdWZmZXJSb3cobGluZSk7XG4gICAgdmFyIGxldmVsID0gJ2Vycm9yJztcbiAgICByZXR1cm4ge1xuICAgICAgICB0eXBlOiBsZXZlbCxcbiAgICAgICAgdGV4dDogYCR7ZXJyb3IuZmllbGR9IC0gJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgIGZpbGVQYXRoOiBlZGl0b3IuZ2V0UGF0aCgpLFxuICAgICAgICBsaW5lOiBsaW5lICsgMSxcbiAgICAgICAgY29sOiBjb2x1bW4gKyAxLFxuICAgICAgICByYW5nZTogbmV3IFJhbmdlKHJhbmdlLnZhbHVlLnN0YXJ0LCByYW5nZS52YWx1ZS5lbmQpXG4gICAgfTtcbn1cbmV4cG9ydCB2YXIgcHJvdmlkZXIgPSBbXG4gICAge1xuICAgICAgICBncmFtbWFyU2NvcGVzOiBbJ3NvdXJjZS5qc29uJ10sXG4gICAgICAgIHNjb3BlOiAnZmlsZScsXG4gICAgICAgIGxpbnRPbkZseTogdHJ1ZSxcbiAgICAgICAgbGludDogKGVkaXRvcikgPT4ge1xuICAgICAgICAgICAgaWYgKGVkaXRvci5nZXRUZXh0KCkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShbXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsZXQganNvbkRvY3VtZW50ID0gcGFyc2VKU09OKGVkaXRvci5nZXRUZXh0KCkpO1xuICAgICAgICAgICAgcmV0dXJuIGpzb25TY2hlbWFTZXJ2aWNlLmdldFNjaGVtYUZvclJlc291cmNlKGVkaXRvci5nZXRVUkkoKSwganNvbkRvY3VtZW50KS50aGVuKHNjaGVtYSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHNjaGVtYSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc2NoZW1hLmVycm9ycy5sZW5ndGggJiYganNvbkRvY3VtZW50LnJvb3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhc3RSb290ID0ganNvbkRvY3VtZW50LnJvb3Q7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgcHJvcGVydHkgPSBhc3RSb290LnR5cGUgPT09ICdvYmplY3QnID8gYXN0Um9vdC5nZXRGaXJzdFByb3BlcnR5KCckc2NoZW1hJykgOiBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG5vZGUgPSBwcm9wZXJ0eS52YWx1ZSB8fCBwcm9wZXJ0eTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqc29uRG9jdW1lbnQud2FybmluZ3MucHVzaCh7IGxvY2F0aW9uOiB7IHN0YXJ0OiBub2RlLnN0YXJ0LCBlbmQ6IG5vZGUuZW5kIH0sIG1lc3NhZ2U6IHNjaGVtYS5lcnJvcnNbMF0gfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqc29uRG9jdW1lbnQud2FybmluZ3MucHVzaCh7IGxvY2F0aW9uOiB7IHN0YXJ0OiBhc3RSb290LnN0YXJ0LCBlbmQ6IGFzdFJvb3Quc3RhcnQgKyAxIH0sIG1lc3NhZ2U6IHNjaGVtYS5lcnJvcnNbMF0gfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBqc29uRG9jdW1lbnQudmFsaWRhdGUoc2NoZW1hLnNjaGVtYSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbGV0IGRpYWdub3N0aWNzID0gW107XG4gICAgICAgICAgICAgICAganNvbkRvY3VtZW50LmVycm9ycy5jb25jYXQoanNvbkRvY3VtZW50Lndhcm5pbmdzKS5mb3JFYWNoKChlcnJvciwgaWR4KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBzaWduYXR1cmUgPSBlcnJvci5sb2NhdGlvbi5zdGFydCArICcgJyArIGVycm9yLmxvY2F0aW9uLmVuZCArICcgJyArIGVycm9yLm1lc3NhZ2U7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGxvY2F0aW9uID0gZWRpdG9yLmdldEJ1ZmZlcigpLnBvc2l0aW9uRm9yQ2hhcmFjdGVySW5kZXgoZXJyb3IubG9jYXRpb24uc3RhcnQpO1xuICAgICAgICAgICAgICAgICAgICBkaWFnbm9zdGljcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IGlkeCA+PSBqc29uRG9jdW1lbnQuZXJyb3JzLmxlbmd0aCA/IFwid2FybmluZ1wiIDogXCJlcnJvclwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogc2lnbmF0dXJlLFxuICAgICAgICAgICAgICAgICAgICAgICAgZmlsZVBhdGg6IGVkaXRvci5nZXRQYXRoKCksXG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBsb2NhdGlvbi5yb3cgKyAxLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29sOiBsb2NhdGlvbi5jb2x1bW4gKyAxLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2U6IG5ldyBSYW5nZShlcnJvci5sb2NhdGlvbi5zdGFydCwgZXJyb3IubG9jYXRpb24uZW5kKVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZGlhZ25vc3RpY3M7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cbl07XG4iLCJ2YXIgUmFuZ2UgPSByZXF1aXJlKCdhdG9tJykuUmFuZ2U7XHJcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XHJcbmltcG9ydCB7b21uaX0gZnJvbSBcIi4vb21uaVwiO1xyXG5pbXBvcnQge09ic2VydmFibGV9IGZyb20gXCJyeGpzXCI7XHJcbmltcG9ydCB7Q29tcG9zaXRlRGlzcG9zYWJsZX0gZnJvbSBcIi4vZGlzcG9zYWJsZXNcIjtcclxuaW1wb3J0IHtnZXRSYW5nZXMsIElUb2tlblJhbmdlfSBmcm9tIFwiLi9oZWxwZXJzL2dldC1yYW5nZXNcIjtcclxuXHJcbmltcG9ydCB7SlNPTlNjaGVtYVNlcnZpY2UsIElTY2hlbWFBc3NvY2lhdGlvbnN9IGZyb20gJy4vdnNjb2RlL3BsdWdpbi9qc29uU2NoZW1hU2VydmljZSc7XHJcbmltcG9ydCB7cGFyc2UgYXMgcGFyc2VKU09OLCBPYmplY3RBU1ROb2RlLCBKU09ORG9jdW1lbnR9IGZyb20gJy4vdnNjb2RlL3BsdWdpbi9qc29uUGFyc2VyJztcclxuXHJcbmNvbnN0IGpzb25TY2hlbWFTZXJ2aWNlID0gbmV3IEpTT05TY2hlbWFTZXJ2aWNlKCk7XHJcblxyXG5pbnRlcmZhY2UgTGludGVyRXJyb3Ige1xyXG4gICAgdHlwZTogc3RyaW5nOyAvLyAnZXJyb3InIHwgJ3dhcm5pbmcnXHJcbiAgICB0ZXh0Pzogc3RyaW5nO1xyXG4gICAgaHRtbD86IHN0cmluZztcclxuICAgIGZpbGVQYXRoPzogc3RyaW5nO1xyXG4gICAgcmFuZ2U/OiBSYW5nZTtcclxuICAgIGxpbmU/OiBudW1iZXI7XHJcbiAgICBjb2w/OiBudW1iZXI7XHJcbn1cclxuXHJcbmludGVyZmFjZSB2YWxpZGF0b3JSZXN1bHQge1xyXG4gICAgKGRhdGE6IGFueSwgb3B0aW9uczogYW55KTogdm9pZDtcclxuICAgIGVycm9yczogdmFsaWRhdG9yRXJyb3JbXTtcclxufVxyXG5cclxuaW50ZXJmYWNlIHZhbGlkYXRvckVycm9yIHtcclxuICAgIGZpZWxkOiBzdHJpbmc7XHJcbiAgICBtZXNzYWdlOiBzdHJpbmc7XHJcbiAgICB2YWx1ZTogYW55O1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRXb3JkQXQoc3RyOiBzdHJpbmcsIHBvczogbnVtYmVyKSB7XHJcbiAgICB2YXIgd29yZExvY2F0aW9uID0ge1xyXG4gICAgICAgIHN0YXJ0OiBwb3MsXHJcbiAgICAgICAgZW5kOiBwb3NcclxuICAgIH1cclxuXHJcbiAgICBpZiAoc3RyID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICByZXR1cm4gd29yZExvY2F0aW9uO1xyXG4gICAgfVxyXG5cclxuICAgIHdoaWxlIChwb3MgPCBzdHIubGVuZ3RoICYmIC9cXFcvLnRlc3Qoc3RyW3Bvc10pKSB7XHJcbiAgICAgICAgKytwb3M7XHJcbiAgICB9XHJcblxyXG4gICAgdmFyIGxlZnQgPSBzdHIuc2xpY2UoMCwgcG9zICsgMSkuc2VhcmNoKC9cXFcoPyEuKlxcVykvKTtcclxuICAgIHZhciByaWdodCA9IHN0ci5zbGljZShwb3MpLnNlYXJjaCgvKFxcV3wkKS8pO1xyXG5cclxuICAgIHdvcmRMb2NhdGlvbi5zdGFydCA9IGxlZnQgKyAxO1xyXG4gICAgd29yZExvY2F0aW9uLmVuZCA9IHdvcmRMb2NhdGlvbi5zdGFydCArIHJpZ2h0O1xyXG5cclxuICAgIHJldHVybiB3b3JkTG9jYXRpb247XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG1hcFZhbHVlcyhlZGl0b3I6IEF0b20uVGV4dEVkaXRvciwgcmFuZ2VzOiB7IFtrZXk6IHN0cmluZ106IElUb2tlblJhbmdlIH0sIGVycm9yOiB2YWxpZGF0b3JFcnJvcik6IExpbnRlckVycm9yIHtcclxuICAgIHZhciByYW5nZSA9IHJhbmdlc1tlcnJvci5maWVsZC5yZXBsYWNlKCdkYXRhLicsICcnKV07XHJcbiAgICBpZiAoIXJhbmdlKSB7XHJcbiAgICAgICAgLy8gVE9ETzogIFNob3VsZCB0cnkgYW5kIGZpZ3VyZSBvdXQgc29tZSBvZiB0aGVzZSBmYWlsdXJlc1xyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgdmFyIGxpbmUgPSByYW5nZS5zZWN0aW9uLnN0YXJ0WzBdO1xyXG4gICAgdmFyIGNvbHVtbiA9IHJhbmdlLnNlY3Rpb24uc3RhcnRbMV07XHJcbiAgICB2YXIgdGV4dCA9IGVkaXRvci5saW5lVGV4dEZvckJ1ZmZlclJvdyhsaW5lKTtcclxuICAgIHZhciBsZXZlbCA9ICdlcnJvcic7XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICB0eXBlOiBsZXZlbCxcclxuICAgICAgICB0ZXh0OiBgJHtlcnJvci5maWVsZH0gLSAke2Vycm9yLm1lc3NhZ2V9YCxcclxuICAgICAgICBmaWxlUGF0aDogZWRpdG9yLmdldFBhdGgoKSxcclxuICAgICAgICBsaW5lOiBsaW5lICsgMSxcclxuICAgICAgICBjb2w6IGNvbHVtbiArIDEsXHJcbiAgICAgICAgcmFuZ2U6IG5ldyBSYW5nZShyYW5nZS52YWx1ZS5zdGFydCwgcmFuZ2UudmFsdWUuZW5kKVxyXG4gICAgfTtcclxufVxyXG5cclxuZXhwb3J0IHZhciBwcm92aWRlciA9IFtcclxuICAgIHtcclxuICAgICAgICBncmFtbWFyU2NvcGVzOiBbJ3NvdXJjZS5qc29uJ10sXHJcbiAgICAgICAgc2NvcGU6ICdmaWxlJyxcclxuICAgICAgICBsaW50T25GbHk6IHRydWUsXHJcbiAgICAgICAgbGludDogKGVkaXRvcjogQXRvbS5UZXh0RWRpdG9yKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlZGl0b3IuZ2V0VGV4dCgpLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgLy8gaWdub3JlIGVtcHR5IGRvY3VtZW50c1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZTxMaW50ZXJFcnJvcltdPihbXSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGxldCBqc29uRG9jdW1lbnQgPSBwYXJzZUpTT04oZWRpdG9yLmdldFRleHQoKSk7XHJcbiAgICAgICAgICAgIHJldHVybiBqc29uU2NoZW1hU2VydmljZS5nZXRTY2hlbWFGb3JSZXNvdXJjZShlZGl0b3IuZ2V0VVJJKCksIGpzb25Eb2N1bWVudCkudGhlbihzY2hlbWEgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHNjaGVtYSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzY2hlbWEuZXJyb3JzLmxlbmd0aCAmJiBqc29uRG9jdW1lbnQucm9vdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXN0Um9vdCA9IGpzb25Eb2N1bWVudC5yb290O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgcHJvcGVydHkgPSBhc3RSb290LnR5cGUgPT09ICdvYmplY3QnID8gKDxPYmplY3RBU1ROb2RlPmFzdFJvb3QpLmdldEZpcnN0UHJvcGVydHkoJyRzY2hlbWEnKSA6IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG5vZGUgPSBwcm9wZXJ0eS52YWx1ZSB8fCBwcm9wZXJ0eTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpzb25Eb2N1bWVudC53YXJuaW5ncy5wdXNoKHsgbG9jYXRpb246IHsgc3RhcnQ6IG5vZGUuc3RhcnQsIGVuZDogbm9kZS5lbmQgfSwgbWVzc2FnZTogc2NoZW1hLmVycm9yc1swXSB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpzb25Eb2N1bWVudC53YXJuaW5ncy5wdXNoKHsgbG9jYXRpb246IHsgc3RhcnQ6IGFzdFJvb3Quc3RhcnQsIGVuZDogYXN0Um9vdC5zdGFydCArIDEgfSwgbWVzc2FnZTogc2NoZW1hLmVycm9yc1swXSB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGpzb25Eb2N1bWVudC52YWxpZGF0ZShzY2hlbWEuc2NoZW1hKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IGRpYWdub3N0aWNzOiBMaW50ZXJFcnJvcltdID0gW107XHJcbiAgICAgICAgICAgICAgICBqc29uRG9jdW1lbnQuZXJyb3JzLmNvbmNhdChqc29uRG9jdW1lbnQud2FybmluZ3MpLmZvckVhY2goKGVycm9yLCBpZHgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgZHVwbGljYXRlZCBtZXNzYWdlc1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBzaWduYXR1cmUgPSBlcnJvci5sb2NhdGlvbi5zdGFydCArICcgJyArIGVycm9yLmxvY2F0aW9uLmVuZCArICcgJyArIGVycm9yLm1lc3NhZ2U7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9jYXRpb24gPSBlZGl0b3IuZ2V0QnVmZmVyKCkucG9zaXRpb25Gb3JDaGFyYWN0ZXJJbmRleChlcnJvci5sb2NhdGlvbi5zdGFydCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGRpYWdub3N0aWNzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBpZHggPj0ganNvbkRvY3VtZW50LmVycm9ycy5sZW5ndGggPyBcIndhcm5pbmdcIiA6IFwiZXJyb3JcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogc2lnbmF0dXJlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWxlUGF0aDogZWRpdG9yLmdldFBhdGgoKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGluZTogbG9jYXRpb24ucm93ICsgMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sOiBsb2NhdGlvbi5jb2x1bW4gKyAxLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICByYW5nZTogbmV3IFJhbmdlKGVycm9yLmxvY2F0aW9uLnN0YXJ0LCBlcnJvci5sb2NhdGlvbi5lbmQpXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIC8vIFNlbmQgdGhlIGNvbXB1dGVkIGRpYWdub3N0aWNzIHRvIFZTQ29kZS5cclxuICAgICAgICAgICAgICAgIHJldHVybiBkaWFnbm9zdGljcztcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5dO1xyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
